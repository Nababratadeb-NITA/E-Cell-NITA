/*! For license information please see pushly-sdk.min.js.LICENSE */
(()=>{var s={"./node_modules/error-stack-parser/error-stack-parser.js":function(e,s,i){var n,r;!function(t){"use strict";r=[i("./node_modules/stackframe/stackframe.js")],void 0!==(r="function"==typeof(n=t)?n.apply(s,r):n)&&(e.exports=r)}(function(c){"use strict";var e=/(^|@)\S+:\d+/,s=/^\s*at .*(\S+:\d+|\(native\))/m,i=/^(eval@)?(\[native code])?$/;return{parse:function(t){if(void 0!==t.stacktrace||void 0!==t["opera#sourceloc"])return this.parseOpera(t);if(t.stack&&t.stack.match(s))return this.parseV8OrIE(t);if(t.stack)return this.parseFFOrSafari(t);throw new Error("Cannot parse given Error object")},extractLocation:function(t){if(-1===t.indexOf(":"))return[t];t=/(.+?)(?::(\d+))?(?::(\d+))?$/.exec(t.replace(/[()]/g,""));return[t[1],t[2]||void 0,t[3]||void 0]},parseV8OrIE:function(t){return t.stack.split("\n").filter(function(t){return!!t.match(s)},this).map(function(t){var e=(s=(t=-1<t.indexOf("(eval ")?t.replace(/eval code/g,"eval").replace(/(\(eval at [^()]*)|(,.*$)/g,""):t).replace(/^\s+/,"").replace(/\(eval code/g,"(").replace(/^.*?\s+/,"")).match(/ (\(.+\)$)/),s=e?s.replace(e[0],""):s,i=this.extractLocation(e?e[1]:s),e=e&&s||void 0,s=-1<["eval","<anonymous>"].indexOf(i[0])?void 0:i[0];return new c({functionName:e,fileName:s,lineNumber:i[1],columnNumber:i[2],source:t})},this)},parseFFOrSafari:function(t){return t.stack.split("\n").filter(function(t){return!t.match(i)},this).map(function(t){var e,s;return-1===(t=-1<t.indexOf(" > eval")?t.replace(/ line (\d+)(?: > eval line \d+)* > eval:\d+:\d+/g,":$1"):t).indexOf("@")&&-1===t.indexOf(":")?new c({functionName:t}):(e=(e=t.match(s=/((.*".+"[^@]*)?[^@]*)(?:@)/))&&e[1]?e[1]:void 0,s=this.extractLocation(t.replace(s,"")),new c({functionName:e,fileName:s[0],lineNumber:s[1],columnNumber:s[2],source:t}))},this)},parseOpera:function(t){return!t.stacktrace||-1<t.message.indexOf("\n")&&t.message.split("\n").length>t.stacktrace.split("\n").length?this.parseOpera9(t):t.stack?this.parseOpera11(t):this.parseOpera10(t)},parseOpera9:function(t){for(var e=/Line (\d+).*script (?:in )?(\S+)/i,s=t.message.split("\n"),i=[],n=2,r=s.length;n<r;n+=2){var o=e.exec(s[n]);o&&i.push(new c({fileName:o[2],lineNumber:o[1],source:s[n]}))}return i},parseOpera10:function(t){for(var e=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i,s=t.stacktrace.split("\n"),i=[],n=0,r=s.length;n<r;n+=2){var o=e.exec(s[n]);o&&i.push(new c({functionName:o[3]||void 0,fileName:o[2],lineNumber:o[1],source:s[n]}))}return i},parseOpera11:function(t){return t.stack.split("\n").filter(function(t){return!!t.match(e)&&!t.match(/^Error created at/)},this).map(function(t){var e,s=t.split("@"),i=this.extractLocation(s.pop()),s=s.shift()||"",n=s.replace(/<anonymous function(: (\w+))?>/,"$2").replace(/\([^)]*\)/g,"")||void 0,s=void 0===(e=s.match(/\(([^)]*)\)/)?s.replace(/^[^(]+\(([^)]*)\)$/,"$1"):e)||"[arguments not available]"===e?void 0:e.split(",");return new c({functionName:n,args:s,fileName:i[0],lineNumber:i[1],columnNumber:i[2],source:t})},this)}}})},"./node_modules/stackframe/stackframe.js":function(t,e){var s,i;!function(){"use strict";i=[],void 0!==(i="function"==typeof(s=function(){"use strict";function s(t){return!isNaN(parseFloat(t))&&isFinite(t)}function i(t){return t.charAt(0).toUpperCase()+t.substring(1)}function t(t){return function(){return this[t]}}var e=["isConstructor","isEval","isNative","isToplevel"],n=["columnNumber","lineNumber"],r=["fileName","functionName","source"],o,c,d=e.concat(n,r,["args"],["evalOrigin"]);function l(t){if(!t)return;for(var e=0;e<d.length;e++)if(t[d[e]]!==undefined)this["set"+i(d[e])](t[d[e]])}l.prototype={getArgs:function(){return this.args},setArgs:function(t){if(Object.prototype.toString.call(t)!=="[object Array]")throw new TypeError("Args must be an Array");this.args=t},getEvalOrigin:function(){return this.evalOrigin},setEvalOrigin:function(t){if(t instanceof l)this.evalOrigin=t;else if(t instanceof Object)this.evalOrigin=new l(t);else throw new TypeError("Eval Origin must be an Object or StackFrame")},toString:function(){var t=this.getFileName()||"";var e=this.getLineNumber()||"";var s=this.getColumnNumber()||"";var i=this.getFunctionName()||"";if(this.getIsEval()){if(t)return"[eval] ("+t+":"+e+":"+s+")";return"[eval]:"+e+":"+s}if(i)return i+" ("+t+":"+e+":"+s+")";return t+":"+e+":"+s}},l.fromString=function t(e){var s=e.indexOf("(");var i=e.lastIndexOf(")");var n=e.substring(0,s);var r=e.substring(s+1,i).split(",");var o=e.substring(i+1);if(o.indexOf("@")===0){var c=/@(.+?)(?::(\d+))?(?::(\d+))?$/.exec(o,"");var d=c[1];var u=c[2];var a=c[3]}return new l({functionName:n,args:r||undefined,fileName:d,lineNumber:u||undefined,columnNumber:a||undefined})};for(var u=0;u<e.length;u++){l.prototype["get"+i(e[u])]=t(e[u]);l.prototype["set"+i(e[u])]=function(e){return function(t){this[e]=Boolean(t)}}(e[u])}for(var a=0;a<n.length;a++){l.prototype["get"+i(n[a])]=t(n[a]);l.prototype["set"+i(n[a])]=function(e){return function(t){if(!s(t))throw new TypeError(e+" must be a Number");this[e]=Number(t)}}(n[a])}for(var h=0;h<r.length;h++){l.prototype["get"+i(r[h])]=t(r[h]);l.prototype["set"+i(r[h])]=function(e){return function(t){this[e]=String(t)}}(r[h])}return l})?s.apply(e,i):s)&&(t.exports=i)}()},"./src/_utils/base-64.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.arrayBufferToBase64=e.base64ToArrayBuffer=void 0;const i=s("./src/sdk/utils.ts");e.base64ToArrayBuffer=function(t){t=(t+"=".repeat((4-t.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/");const e=(0,i.atobShim)(t),s=new Uint8Array(e.length);for(let t=0;t<e.length;++t)s[t]=e.charCodeAt(t);return s},e.arrayBufferToBase64=function(t){return t=new Uint8Array(t),window.btoa(String.fromCharCode.apply(null,t)).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}},"./src/_utils/consent.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.buildSdkConsentEventData=e.buildSdkConsentContext=void 0;const i=s("./src/sdk/enums/consent.enum.ts");e.buildSdkConsentContext=function(t,e=!1){return{required:t=t.consentRequired||!1,status:t&&e?i.ConsentStatus.CONFIRMED:i.ConsentStatus.UNCONFIRMED}},e.buildSdkConsentEventData=function(t){return{[i.ConsentEventKeys.CONSENT_REQUIRED]:t.consent.required,[i.ConsentEventKeys.CONSENT_STATUS]:t.consent.status}}},"./src/_utils/domain-matching.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.domainMatchPredicate=void 0;const r=s("./src/_utils/global-env.ts");e.domainMatchPredicate=function(t){var e=(i=(0,r.getLocation)()).protocol+"//"+i.hostname,s=i.protocol+"//"+i.host,i=i.href;/^\*/.test(t)&&(t="."+t);const n=new RegExp(`^(http[s]?://)?${t}$`,"i");return n.test(e)||n.test(s)||n.test(i)}},"./src/_utils/global-env.ts":(t,e)=>{"use strict";function s(){return"WorkerGlobalScope"in self}function i(){return window.self!==window.top&&window.frameElement&&"about:blank"===window.frameElement.src}function n(){return i()?top:s()?self:window}Object.defineProperty(e,"__esModule",{value:!0}),e.getDocument=e.getNavigator=e.getLocation=e.getSelf=e.inSourcelessIFrameScope=e.inWorkerGlobalScope=void 0,e.inWorkerGlobalScope=s,e.inSourcelessIFrameScope=i,e.getSelf=n,e.getLocation=function(){return n().location||{}},e.getNavigator=function(){return n().navigator||{}},e.getDocument=function(){return n().document||{}}},"./src/_utils/permissions.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.getNotificationPermissions=void 0;const o=s("./src/_utils/global-env.ts");e.getNotificationPermissions=function(r){return i(this,void 0,void 0,function*(){const e=o.getSelf(),t=o.getNavigator();var s,i={permission:"default"};let n=i;if(!(navigator.vendor.match(/apple/i)&&!navigator.userAgent.match(/crios/i)&&!navigator.userAgent.match(/fxios/i)&&!navigator.userAgent.match(/Opera|OPT\//))||"PushManager"in e)try{"permissions"in t&&"query"in t.permissions?(s=yield t.permissions.query({name:"notifications"}),n.permission="prompt"===s.state?"default":s.state):n.permission=e.Notification.permission}catch(t){n.permission=e.Notification.permission}else{if(!r||!r.websitePushId)throw new Error("websitePushId must be provided for Safari permission check.");n=e.safari.pushNotification.permission(r.websitePushId)}return n=n||i})}},"./src/_utils/service-worker-registration.ts":function(t,e,s){"use strict";var n=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.createPushSubscription=e.getPushSubscription=e.getPushlyServiceWorkerRegistration=e.getServiceWorkerRegistrations=e.getPushlyWorkerConfig=void 0;const o=s("./src/_utils/base-64.ts"),c=s("./src/_utils/permissions.ts"),u=s("./src/sdk/services/logging.service.ts"),a=s("./src/sdk/exceptions/worker-registration.exception.ts"),l=s("./src/_utils/global-env.ts");function h(t){var e=(0,l.getLocation)();const s=e.protocol+"//"+e.hostname+(e.port?":"+e.port:"");let i=t.app.loadConfig.sw?t.app.loadConfig.sw.replace(/^\//,""):null,n=(i&&!i.includes(s)&&(i="/"+i),t.app.loadConfig.swScope?t.app.loadConfig.swScope.replace(/^\//,""):null);n&&!n.includes(s)&&(n="/"+n);const r=i||"/pushly-sdk-worker.js";var e=r.substr(0,r.lastIndexOf("/")+1)||"/",o=t.domain.hasFlag("USE_ROOT_SW_SCOPE");let c=e;return n?c=n:o&&(c="/"),{scope:c.includes(s)?c:""+s.replace(/\/$/,"")+c,installationPath:`${r}${r.includes("?")?"&":"?"}domain_key=`+t.domainKey}}function v(e){return n(this,void 0,void 0,function*(){let t=[];return t=e.env.isPushManagerInScope()?yield(0,l.getSelf)().navigator.serviceWorker.getRegistrations():t})}function p(s,t){var e=new Promise(t=>{let e=setTimeout(()=>{clearTimeout(e),t(null)},s)});return Promise.race([t,e])}function i(d){return n(this,void 0,void 0,function*(){var t,e=(0,l.getSelf)();let s=null;if(d.env.isPushManagerInScope()){const o=h(d);for(t of yield v(d)){yield p(50,e.navigator.serviceWorker.ready);var i=t.scope;const c=(t.active||{}).scriptURL||"";var n=i===o.scope,r=-1!==c.indexOf(o.installationPath.split("?")[0]);if(n&&r){if(s=t,!d.domain.shouldUnregisterNonPushlyWorkers())break}else if(!n&&d.domain.shouldUnregisterNonPushlyWorkers()&&(yield t.unregister(),u.Logger.info("removed worker: "+JSON.stringify({scope:i,path:c}))),n&&!r&&!d.domain.shouldReplaceExistingWorkerInPushlyScope())throw new a.WorkerRegistrationException(new Error(`Implementation Error. An existing, non-push, service worker was found at scope: ${o.scope}.`))}}return s})}e.getPushlyWorkerConfig=h,e.getServiceWorkerRegistrations=v,e.getPushlyServiceWorkerRegistration=i,e.getPushSubscription=function(r){return n(this,void 0,void 0,function*(){let e=null;if(r.env.isPushManagerInScope()&&"granted"===(yield(0,c.getNotificationPermissions)()).permission){const n=yield i(r);if(n)try{e=yield new Promise((e,s)=>{const i=setTimeout(s,5e3);n.pushManager.getSubscription().then(t=>{clearTimeout(i),t?e(t):n.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:(0,o.base64ToArrayBuffer)(r.domain.vapidPublicKey)}).then(t=>{e(t)}).catch(t=>{s(t),clearTimeout(i)})}).catch(t=>{s(t),clearTimeout(i)})})}catch(t){try{e=yield n.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:(0,o.base64ToArrayBuffer)(r.domain.vapidPublicKey)})}catch(t){u.Logger.warn(t)}}}return e})},e.createPushSubscription=function(s,i){return n(this,void 0,void 0,function*(){let t=null;var e=(0,l.getSelf)();return s.env.isPushManagerInScope()&&i&&"granted"===(yield(0,c.getNotificationPermissions)()).permission&&(yield p(50,e.navigator.serviceWorker.ready),t=yield i.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:(0,o.base64ToArrayBuffer)(s.domain.vapidPublicKey)})),t})}},"./src/_utils/validate-only-instance-of-sdk.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.validateOnlyInstanceOfSdk=void 0;const i=s("./src/sdk/enums/exception-message.enum.ts"),n=s("./src/sdk/exceptions/exit.exception.ts");e.validateOnlyInstanceOfSdk=t=>{var e=window.PushlySDK;if(e&&"object"==typeof e&&void 0!==e.iid&&e.iid!==t.iid)throw new n.ExitException(i.ExceptionMessage.DUPLICATE_SDK_INSTANCE);if(t.context.app&&t.context.app.isLoaded)throw new n.ExitException(i.ExceptionMessage.SDK_ALREADY_LOADED)}},"./src/common/constants.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EVENT_JITTER_MAX_MILLISECONDS=void 0,e.EVENT_JITTER_MAX_MILLISECONDS=7e3},"./src/common/data-providers/api.data-provider.ts":function(t,e,s){"use strict";var c=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.ApiDataProvider=void 0;const d=s("./src/common/utils.ts"),u=s("./src/common/constants.ts");e.ApiDataProvider=class{static get(t,e){return c(this,void 0,void 0,function*(){return this.exec(t,"GET",{},void 0,e)})}static post(t,e={},s){return c(this,void 0,void 0,function*(){return this.exec(t,"POST",{"content-type":"text/plain"},e,s)})}static exec(s,i,n,r,o){return c(this,void 0,void 0,function*(){let e=null;try{if(o){let t=0;t="object"==typeof o&&"ms"in o?o.ms:u.EVENT_JITTER_MAX_MILLISECONDS,yield d.delayRandom(t)}const t={method:i,headers:n};if("GET"!==i&&r&&(t.body="string"!=typeof r?JSON.stringify(r):r),(e=yield d.retryFetch(s,t)).ok){let t;try{t=yield e.json()}catch(t){}return t}throw new Error("Endpoint returned with status "+e.statusText)}catch(t){throw(t=t||{}).response=e,t}})}}},"./src/common/md5.ts":(t,e)=>{"use strict";function r(t,e){var s=o(t[0],r=t[1],n=t[2],i=t[3],e[0],7,-680876936),i=o(i,s,r,n,e[1],12,-389564586),n=o(n,i,s,r,e[2],17,606105819),r=o(r,n,i,s,e[3],22,-1044525330);s=o(s,r,n,i,e[4],7,-176418897),i=o(i,s,r,n,e[5],12,1200080426),n=o(n,i,s,r,e[6],17,-1473231341),r=o(r,n,i,s,e[7],22,-45705983),s=o(s,r,n,i,e[8],7,1770035416),i=o(i,s,r,n,e[9],12,-1958414417),n=o(n,i,s,r,e[10],17,-42063),r=o(r,n,i,s,e[11],22,-1990404162),s=o(s,r,n,i,e[12],7,1804603682),i=o(i,s,r,n,e[13],12,-40341101),n=o(n,i,s,r,e[14],17,-1502002290),s=d(s,r=o(r,n,i,s,e[15],22,1236535329),n,i,e[1],5,-165796510),i=d(i,s,r,n,e[6],9,-1069501632),n=d(n,i,s,r,e[11],14,643717713),r=d(r,n,i,s,e[0],20,-373897302),s=d(s,r,n,i,e[5],5,-701558691),i=d(i,s,r,n,e[10],9,38016083),n=d(n,i,s,r,e[15],14,-660478335),r=d(r,n,i,s,e[4],20,-405537848),s=d(s,r,n,i,e[9],5,568446438),i=d(i,s,r,n,e[14],9,-1019803690),n=d(n,i,s,r,e[3],14,-187363961),r=d(r,n,i,s,e[8],20,1163531501),s=d(s,r,n,i,e[13],5,-1444681467),i=d(i,s,r,n,e[2],9,-51403784),n=d(n,i,s,r,e[7],14,1735328473),s=u(s,r=d(r,n,i,s,e[12],20,-1926607734),n,i,e[5],4,-378558),i=u(i,s,r,n,e[8],11,-2022574463),n=u(n,i,s,r,e[11],16,1839030562),r=u(r,n,i,s,e[14],23,-35309556),s=u(s,r,n,i,e[1],4,-1530992060),i=u(i,s,r,n,e[4],11,1272893353),n=u(n,i,s,r,e[7],16,-155497632),r=u(r,n,i,s,e[10],23,-1094730640),s=u(s,r,n,i,e[13],4,681279174),i=u(i,s,r,n,e[0],11,-358537222),n=u(n,i,s,r,e[3],16,-722521979),r=u(r,n,i,s,e[6],23,76029189),s=u(s,r,n,i,e[9],4,-640364487),i=u(i,s,r,n,e[12],11,-421815835),n=u(n,i,s,r,e[15],16,530742520),s=a(s,r=u(r,n,i,s,e[2],23,-995338651),n,i,e[0],6,-198630844),i=a(i,s,r,n,e[7],10,1126891415),n=a(n,i,s,r,e[14],15,-1416354905),r=a(r,n,i,s,e[5],21,-57434055),s=a(s,r,n,i,e[12],6,1700485571),i=a(i,s,r,n,e[3],10,-1894986606),n=a(n,i,s,r,e[10],15,-1051523),r=a(r,n,i,s,e[1],21,-2054922799),s=a(s,r,n,i,e[8],6,1873313359),i=a(i,s,r,n,e[15],10,-30611744),n=a(n,i,s,r,e[6],15,-1560198380),r=a(r,n,i,s,e[13],21,1309151649),s=a(s,r,n,i,e[4],6,-145523070),i=a(i,s,r,n,e[11],10,-1120210379),n=a(n,i,s,r,e[2],15,718787259),r=a(r,n,i,s,e[9],21,-343485551),t[0]=h(s,t[0]),t[1]=h(r,t[1]),t[2]=h(n,t[2]),t[3]=h(i,t[3])}function c(t,e,s,i,n,r){return e=h(h(e,t),h(i,r)),h(e<<n|e>>>32-n,s)}function o(t,e,s,i,n,r,o){return c(e&s|~e&i,t,e,n,r,o)}function d(t,e,s,i,n,r,o){return c(e&i|s&~i,t,e,n,r,o)}function u(t,e,s,i,n,r,o){return c(e^s^i,t,e,n,r,o)}function a(t,e,s,i,n,r,o){return c(s^(e|~i),t,e,n,r,o)}function s(t){for(var e=t.length,s=[1732584193,-271733879,-1732584194,271733878],i=64;i<=t.length;i+=64)r(s,function(t){var e,s=[];for(e=0;e<64;e+=4)s[e>>2]=t.charCodeAt(e)+(t.charCodeAt(e+1)<<8)+(t.charCodeAt(e+2)<<16)+(t.charCodeAt(e+3)<<24);return s}(t.substring(i-64,i)));t=t.substring(i-64);var n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<t.length;i++)n[i>>2]|=t.charCodeAt(i)<<(i%4<<3);if(n[i>>2]|=128<<(i%4<<3),55<i)for(r(s,n),i=0;i<16;i++)n[i]=0;return n[14]=8*e,r(s,n),s}Object.defineProperty(e,"__esModule",{value:!0}),e.MD5=void 0;var i="0123456789abcdef".split("");function n(t){for(var e=0;e<t.length;e++)t[e]=function(t){for(var e="",s=0;s<4;s++)e+=i[t>>8*s+4&15]+i[t>>8*s&15];return e}(t[e]);return t.join("")}function l(t){return n(s(t))}e.MD5=l;let h=(t,e)=>t+e&4294967295;"5d41402abc4b2a76b9719d911017c592"!=l("hello")&&(h=(t,e)=>{var s=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(s>>16)<<16|65535&s})},"./src/common/utils.ts":function(t,u){"use strict";var a=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(u,"__esModule",{value:!0}),u.retryFetch=u.delayRandom=u.delay=u.awaitUntil=u.buildRegexFromArray=u.tryParseInt=u.randomString=void 0,u.randomString=(e=32)=>{var s="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let i="";for(let t=0;t<e;t++)i+=s[Math.floor(Math.random()*s.length)];return/undefined/i.test(i)&&"crypto"in self&&"getRandomValues"in crypto&&"Uint32Array"in self&&(i=crypto.getRandomValues(new Uint32Array(4)).join("")),i=/undefined/i.test(i)?"INVALID_RANDOM_STRING":i},u.tryParseInt=t=>{t=String(t);let e;try{isNaN(t)||(e=parseInt(t,10))}catch(t){}return e},u.buildRegexFromArray=t=>new RegExp(t.map(t=>`(${t})`).join("|"),"i"),u.awaitUntil=(n,r,o)=>a(void 0,void 0,void 0,function*(){return new Promise((e,t)=>{let s=!1;const i=setTimeout(()=>{s=!0,void 0!==o?e(o):t()},r);n.then(t=>{clearTimeout(i),s||e(t)})})}),u.delay=(s=0)=>a(void 0,void 0,void 0,function*(){return new Promise((t,e)=>{setTimeout(()=>t(),s)})});u.delayRandom=(t=0)=>a(void 0,void 0,void 0,function*(){return void 0!==t&&0<t&&(t=Math.round(Math.random()*t)),yield(0,u.delay)(t),t}),u.retryFetch=function i(n,r,o,c=8,d=800){return a(this,void 0,void 0,function*(){let t=null;var e,s=e=>a(this,void 0,void 0,function*(){var t=c-1;if(t<=0)throw e instanceof Error?e:new Error(e);return yield(0,u.delay)(d),o&&o(t),i(n,r,o,t,2*d)});try{return(t=yield fetch(n,r)).ok?t:(e=yield t.text(),s(`Retry fetch failed, ${t.status}, on url: ${n}. response object: `+e))}catch(t){return s(t)}})}},"./src/sdk/constants.ts":function(t,e,s){"use strict";var i=this&&this.__createBinding||(Object.create?function(t,e,s,i){void 0===i&&(i=s);var n=Object.getOwnPropertyDescriptor(e,s);n&&("get"in n?e.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,i,n)}:function(t,e,s,i){t[i=void 0===i?s:i]=e[s]}),n=this&&this.__exportStar||function(t,e){for(var s in t)"default"===s||Object.prototype.hasOwnProperty.call(e,s)||i(e,t,s)};Object.defineProperty(e,"__esModule",{value:!0}),e.UNCAUGHT_ERROR_BLACKLIST=e.DEFAULT_CLASSNAME_PROMPT_BTN_DISMISS=e.DEFAULT_CLASSNAME_PROMPT_BTN_ALLOW=e.DEFAULT_CLASSNAME_PROMPT_CUSTOM=e.DEFAULT_CLASSNAME_PROMPT_VISIBLE=e.DEFAULT_CLASSNAME_PROMPT_ELIGIBLE=e.DEFAULT_CLASSNAME_PROMPT_INELIGIBLE=e.DEFAULT_CLASSNAME_SUBSCRIPTION_DISMISSED=e.DEFAULT_CLASSNAME_SUBSCRIPTION_DENIED=e.DEFAULT_CLASSNAME_SUBSCRIPTION_FALSE=e.DEFAULT_CLASSNAME_SUBSCRIPTION_TRUE=e.DEFAULT_CLASSNAME_SUBSCRIPTION_NONE=e.DEFAULT_CLASSNAME_WEB_PUSH_SUPPORTED=e.DEFAULT_CLASSNAME_WEB_PUSH_UNSUPPORTED=e.MOBILE_MAX_SIZE=e.ENV_NAME_PRODUCTION=e.ENV_NAME_STAGING=e.ENV_NAME_DEV=e.ENV_NAME_LOCAL_PRODUCTION=e.ENV_NAME_LOCAL=e.PUSHLY_SETTINGS_CACHED_COOKIE_TIMEOUT=e.PUSHLY_STORE_NAME=e.PUSHLY_DB_NAME=e.PUSHLY_PROMPT_ID_QS=e.PUSHLY_SUBSCRIBED_URL_QS=e.PUSHLY_DOMAIN_KEY_QS=e.PUSHLY_PROMPT_DISMISSED_COOKIE_TIMEOUT=e.PUSHLY_UNIQUE_USER_FIRST_APPEARANCE_QS=e.PUSHLY_UNIQUE_USER_ID_QS=e.PUSHLY_SDK_APPLICATION_NAME=e.INJECTED_DOMAIN_SETTINGS=e.DOMAIN_SETTINGS_INJECTION_FAILED=e.APNS_URL=e.PROXY_URL=e.SW_DEPENDENCY_URL=e.CSS_URL=e.ALLOW_ENDPOINT=e.SETTINGS_ENDPOINT=e.EVENTS_ENDPOINT=e.PUSHLY_APPLICATION_VERSION=e.ENV_NAME=void 0,e.ENV_NAME="production",e.PUSHLY_APPLICATION_VERSION="adcbc6b1752e2e459ac0f3575efa111bc62c2be1",e.EVENTS_ENDPOINT="https://k.p-n.io/event-stream",e.SETTINGS_ENDPOINT="https://cdn.p-n.io/domain-settings",e.ALLOW_ENDPOINT="https://k.p-n.io/allow",e.CSS_URL="https://cdn.p-n.io/pushly-sdk.min.css",e.SW_DEPENDENCY_URL="https://cdn.p-n.io/pushly-sw.min.js",e.PROXY_URL="https://notifications.p-n.io",e.APNS_URL="https://cdn.p-n.io/apns",e.DOMAIN_SETTINGS_INJECTION_FAILED=/{{INJECTED_DOMAIN_SETTINGS}}/i,e.INJECTED_DOMAIN_SETTINGS={"domain": {"id": 12149, "name": "forbes.com", "domain_key": "qmhdz0KFKfsfhQQeCP5Js1NFta1P8jkwbf05", "integration_type": "direct", "custom_allow_domain": null, "frequency_caps": {"prompt": {"occurrences": 1, "fcap_seconds": 604800, "display_metric": "days"}}, "global_prompt_settings": null, "flags": ["FEAT_CUSTOM_VAPID", "FEAT_VAPID_ONLY", "REPLACE_EXISTING_WORKERS", "USE_ROOT_SW_SCOPE"], "custom_sdk_package_name": null, "vapid_public_key": "BJdOWbKbyFwt3bOoHlyU0RJE1sLzBYI16hOgmKUTirAIT1F-ReJDqNjrVmit429UYrDUjA0If_2FTwDPNEj-y3U", "additional_subscription_data": null, "whitelist_domains": ["www.forbes.com"], "sdk_event_only_domains": [], "apns_configuration": null, "domain_integrations": null}, "prompts": [{"id": 18735, "domain_id": 12149, "style": "NATIVE", "config": {"theme": {"position": {"mobile": "enabled", "desktop": "enabled"}}, "behavior": {"delay_seconds": 0, "cookie_length_seconds": 604800}}, "is_auto_show": false, "weight": 100, "conditions_json": {"visitor": {"time_on_page_seconds": 4}}, "prompt_group_id": 20607, "name": "4 Sec Delay"}, {"id": 11938, "domain_id": 12149, "style": "NATIVE", "config": {"theme": {"position": {"mobile": "enabled", "desktop": "enabled"}}, "behavior": {"delay_seconds": 0}}, "is_auto_show": false, "weight": 100, "conditions_json": {"visitor": {"time_on_page_seconds": 8}}, "prompt_group_id": 14270, "name": null}], "prompt_groups": [{"id": 14270, "domain_id": 12149, "name": "Native", "is_active": true, "priority": 1, "display_to_pct": 100, "conditions_json": {"display": {"mobile": "enabled", "desktop": "enabled"}}}, {"id": 20607, "domain_id": 12149, "name": "1-Step AB Test", "is_active": true, "priority": 0, "display_to_pct": 100, "conditions_json": {"display": {"mobile": "enabled", "desktop": "enabled"}}}]},n(s("./src/common/constants.ts"),e),e.PUSHLY_SDK_APPLICATION_NAME="pushly-sdk",e.PUSHLY_UNIQUE_USER_ID_QS="pushly_unique_user_id",e.PUSHLY_UNIQUE_USER_FIRST_APPEARANCE_QS="pushly_unique_user_first_appearance",e.PUSHLY_PROMPT_DISMISSED_COOKIE_TIMEOUT=7,e.PUSHLY_DOMAIN_KEY_QS="pushly_domain_key",e.PUSHLY_SUBSCRIBED_URL_QS="pushly_subscribed_url",e.PUSHLY_PROMPT_ID_QS="pushly_prompt_id",e.PUSHLY_DB_NAME="pushly_db",e.PUSHLY_STORE_NAME="pushly_store",e.PUSHLY_SETTINGS_CACHED_COOKIE_TIMEOUT=1/24/12,e.ENV_NAME_LOCAL="local",e.ENV_NAME_LOCAL_PRODUCTION="local-production",e.ENV_NAME_DEV="dev",e.ENV_NAME_STAGING="staging",e.ENV_NAME_PRODUCTION="production",e.MOBILE_MAX_SIZE=768,e.DEFAULT_CLASSNAME_WEB_PUSH_UNSUPPORTED="pushly-web-push-unsupported",e.DEFAULT_CLASSNAME_WEB_PUSH_SUPPORTED="pushly-web-push-supported",e.DEFAULT_CLASSNAME_SUBSCRIPTION_NONE="pushly-subscription-none",e.DEFAULT_CLASSNAME_SUBSCRIPTION_TRUE="pushly-subscription-subscribed",e.DEFAULT_CLASSNAME_SUBSCRIPTION_FALSE="pushly-subscription-unsubscribed",e.DEFAULT_CLASSNAME_SUBSCRIPTION_DENIED="pushly-subscription-denied",e.DEFAULT_CLASSNAME_SUBSCRIPTION_DISMISSED="pushly-subscription-dismissed",e.DEFAULT_CLASSNAME_PROMPT_INELIGIBLE="pushly-prompt-ineligible",e.DEFAULT_CLASSNAME_PROMPT_ELIGIBLE="pushly-prompt-eligible",e.DEFAULT_CLASSNAME_PROMPT_VISIBLE="pushly-prompt-visible",e.DEFAULT_CLASSNAME_PROMPT_CUSTOM="pushly-prompt-custom",e.DEFAULT_CLASSNAME_PROMPT_BTN_ALLOW="pushly-prompt-buttons-allow",e.DEFAULT_CLASSNAME_PROMPT_BTN_DISMISS="pushly-prompt-buttons-dismiss",e.UNCAUGHT_ERROR_BLACKLIST=["^UnknownError","^NotAllowedError$","^AbortError$","^QuotaExceededError$","Only secure origins are allowed"]},"./src/sdk/cross-frame-messenger/base-messenger.ts":function(t,e,s){"use strict";var o=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.BaseMessenger=void 0;const c=s("./src/sdk/models/events/event.model.ts"),d=s("./src/sdk/services/logging.service.ts");class i extends s("./src/sdk/models/events/eventable.model.ts").EventableModel{constructor(){super(),this.portListeners={}}sendToPort(e,s,i=null,n=null,r=!1){try{var o=n||crypto.getRandomValues(new Uint8Array(10)).join("");e.postMessage({id:o,topic:s,data:i,isReply:r});let t=new Promise(t=>t());if(!r){let e=void 0;t=new Promise(t=>e=t),this.portListeners[o]=e}return t}catch(t){d.Logger.error(t)}}listenToPort(e){e.onmessage=t=>{this.handleMessageEvent(t,e)}}handleMessageEvent(t,e){const s=t.ports[0]||e;try{if(t.data&&t.data.topic){const n=t.data.topic;var i=t.data.data;const r=t.data.id;r in this.portListeners?(this.portListeners[r](i),delete this.portListeners[r]):this.dispatch(new c.EventModel(n,{port:s,data:i,reply:t=>o(this,void 0,void 0,function*(){yield this.sendToPort(s,n,t,r,!0)})}))}}catch(t){d.Logger.warn(t)}}}e.BaseMessenger=i},"./src/sdk/cross-frame-messenger/messenger-client-connection-pool.ts":function(t,e,s){"use strict";var r=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.MessengerClientConnectionPool=void 0;const o=s("./src/sdk/cross-frame-messenger/models/connection-pool-record.ts"),c=s("./src/sdk/cross-frame-messenger/messenger-client.ts"),d=s("./src/sdk/services/logging.service.ts");class u{checkout(n){return r(this,void 0,void 0,function*(){d.Logger.debug("MessengerClientConnectionPool checking out "+n);let i;return n in u.connections?(d.Logger.debug("Returning existing connection"),i=u.connections[n]):(d.Logger.debug("Creating new connection"),(i=new o.ConnectionPoolRecord).checkouts=0,i.messengerClient=new Promise((e,s)=>r(this,void 0,void 0,function*(){const t=new c.MessengerClient;try{i.close=yield t.connectUrl(n),e(t)}catch(t){d.Logger.warn(t),delete u.connections[n],s(t)}})),u.connections[n]=i),i.checkouts+=1,i.messengerClient})}release(s){return r(this,void 0,void 0,function*(){for(const t in u.connections){const e=u.connections[t];if((yield e.messengerClient)===s){d.Logger.debug("MessengerClientConnectionPool releasing connection to "+t),--e.checkouts,e.checkouts<1&&(d.Logger.debug("MessengerClientConnectionPool closing connection to "+t),e.close(),delete u.connections[t]);break}}})}}(e.MessengerClientConnectionPool=u).connections={}},"./src/sdk/cross-frame-messenger/messenger-client.ts":function(t,e,s){"use strict";var o=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})},i=(Object.defineProperty(e,"__esModule",{value:!0}),e.MessengerClient=void 0,s("./src/sdk/cross-frame-messenger/base-messenger.ts"));const a=s("./src/common/utils.ts"),l=s("./src/sdk/enums/messenger-topic.enum.ts"),c=s("./src/sdk/exceptions/no-connection.exception.ts"),h=s("./src/sdk/exceptions/no-response.exception.ts"),v=s("./src/sdk/services/logging.service.ts");class n extends i.BaseMessenger{connect(d,u=3){return o(this,void 0,void 0,function*(){this.port&&(v.Logger.warn("ClientMessenger reused. Existing port closed."),this.close());let t,s=null,i=1,n=!1;do{t&&t.close();var r=new MessageChannel,o=((t=r.port1).onmessage=this.handleMessageEvent.bind(this),crypto.getRandomValues(new Uint8Array(10)).join(""));let e=void 0;var c=new Promise(t=>e=t);this.portListeners[o]=e,d.postMessage({id:o,topic:l.MessengerTopic.CONNECT_HANDSHAKE},"*",[r.port2]),u&&(s=yield(0,a.awaitUntil)(c,500*i,null),i+=1,n=!s&&i<=u)}while(n);if(!s&&u)throw new h.NoResponseException(new Error("Failed to connect"));return this.port=t,this.close.bind(this)})}connectUrl(n,r=3){return o(this,void 0,void 0,function*(){const i=document.createElement("div");return i.setAttribute("style","display:none;position:absolute;overflow:hidden;width:1px;height:1px;bottom:0;left:0"),new Promise((e,s)=>o(this,void 0,void 0,function*(){try{v.Logger.info("Creating iframe "+n);const t=document.createElement("iframe");if(t.width="1px",t.height="1px",t.setAttribute("style","width:1px;height:1px;display:none;"),t.src=n,i.appendChild(t),document.body.appendChild(i),yield(0,a.delay)(300),t.contentWindow)try{e(yield this.connect(t.contentWindow,r)),this.connectedHost=new URL(n).hostname,this.connectedElement=i}catch(t){s(t)}else s(new c.NoConnectionException(new Error("iframe failed to load "+n)))}catch(t){throw document.body.removeChild(i),t}}))})}close(){this.port.close(),this.connectedElement&&document.body.removeChild(this.connectedElement),this.connectedHost=null,this.connectedElement=null,this.port=null}send(e,s=null){return o(this,void 0,void 0,function*(){if(!this.port)throw new c.NoConnectionException(new Error("MessengerClient::send called before connection opened."));var t=(0,a.randomString)();return this.sendToPort(this.port,e,s,t,!1)})}sendTimeout(t,e=null,s){return o(this,void 0,void 0,function*(){return(0,a.awaitUntil)(this.send(t,e),s)})}}e.MessengerClient=n},"./src/sdk/cross-frame-messenger/messenger-server.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})},n=(Object.defineProperty(e,"__esModule",{value:!0}),e.MessengerServer=void 0,s("./src/sdk/cross-frame-messenger/base-messenger.ts"));const r=s("./src/sdk/enums/messenger-topic.enum.ts"),o=s("./src/sdk/data-providers/event.data-provider.ts"),c=s("./src/sdk/enums/event-type.enum.ts"),d=s("./src/sdk/services/logging.service.ts");class u extends n.BaseMessenger{constructor(){super(),this.ready=new Promise((t,e)=>{o.EventManager.once(c.EventType.APPLICATION_READY,()=>{d.Logger.info("Application is ready"),t()})})}accept(){window.addEventListener("message",this.handleMessageEvent.bind(this)),this.watch(r.MessengerTopic.CONNECT_HANDSHAKE,this.handleHandshakeEvent.bind(this))}handleHandshakeEvent(t){return i(this,void 0,void 0,function*(){return this.listenToPort(t.port),yield this.ready,t.reply(!0)})}}(e.MessengerServer=u).global=new u},"./src/sdk/cross-frame-messenger/models/connection-pool-record.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ConnectionPoolRecord=void 0;e.ConnectionPoolRecord=class{constructor(){this.checkouts=0}}},"./src/sdk/data-providers/abstract-permission.data-provider.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.AbstractPermissionDataProvider=void 0;const n=s("./src/_utils/base-64.ts"),r=s("./src/_utils/service-worker-registration.ts"),o=s("./src/_utils/global-env.ts");e.AbstractPermissionDataProvider=class{constructor(t){this.context=t,this.context=t}getLocalPermissions(){return i(this,void 0,void 0,function*(){let e={permission:"default",host:(0,o.getSelf)().location.hostname,subscription:null,applicationServerKey:null};if(this.context.env.isSafari()&&!this.context.env.isPushManagerInScope()){if(!this.context.domain.getWebsitePushId())throw new Error("websitePushId must be provided for Safari permission check.");e.permission=self.safari.pushNotification.permission(this.context.domain.getWebsitePushId()).permission||e}else{try{let t=(yield navigator.permissions.query({name:"notifications"})).state;"prompt"===t&&(t="default"),e.permission=t}catch(t){e.permission=(0,o.getSelf)().Notification?(0,o.getSelf)().Notification.permission.toString():e.permission}const t=yield(0,r.getPushSubscription)(this.context);t&&(e.subscription=t.toJSON(),e.applicationServerKey=(0,n.arrayBufferToBase64)(t.options.applicationServerKey))}return e})}unregisterWorker(){return i(this,void 0,void 0,function*(){let t=!1;if(this.context.env.isPushManagerInScope())try{const e=yield(0,r.getPushlyServiceWorkerRegistration)(this.context);e&&(t=yield e.unregister())}catch(t){}return t})}isSafari(){return navigator.vendor.match(/apple/i)&&!navigator.userAgent.match(/crios/i)&&!navigator.userAgent.match(/fxios/i)&&!navigator.userAgent.match(/Opera|OPT\//)}}},"./src/sdk/data-providers/abstract-session.data-provider.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AbstractSessionDataProvider=void 0;e.AbstractSessionDataProvider=class{}},"./src/sdk/data-providers/brokered-permission.data-provider.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})},n=(Object.defineProperty(e,"__esModule",{value:!0}),e.BrokeredPermissionDataProvider=void 0,s("./src/sdk/data-providers/abstract-permission.data-provider.ts"));const d=s("./src/sdk/data-providers/cookie.data-provider.ts"),r=s("./src/common/utils.ts"),o=s("./src/sdk/cross-frame-messenger/messenger-client-connection-pool.ts"),u=s("./src/_utils/global-env.ts"),c=s("./src/sdk/enums/messenger-topic.enum.ts"),a=s("./src/sdk/exceptions/no-response.exception.ts"),l=s("./src/sdk/services/logging.service.ts"),h=s("./src/sdk/enums/permission-broker-topic.enum.ts");class v extends n.AbstractPermissionDataProvider{constructor(t){super(t),this.messengerClientConnectionPool=new o.MessengerClientConnectionPool}getPushPermission(){return i(this,void 0,void 0,function*(){const t=[(0,u.getSelf)().location.hostname];var e=yield this.getLocalPermissions();let s;if("default"===e.permission&&(l.Logger.info("BrokeredPermissionDataProvider: Local permissions are: "+e.permission),this.messengerClient&&(t.push(this.messengerClient.connectedHost),s=yield v.getCalculatedPermissions(this.messengerClient)),!s||"default"===s.permission)){var i,n=d.CookieDataProvider.get("_pnpds");if(n&&-1===t.indexOf(n)&&(t.push(n),i=this.context.app.getBrokeredFrameMessengerPath(n),yield this.messengerClientConnectionPool.release(this.messengerClient),this.messengerClient=yield this.messengerClientConnectionPool.checkout(i),s=(yield v.getCalculatedPermissions(this.messengerClient))||s,l.Logger.info(`BrokeredPermissionDataProvider: ${n} permissions are: `+s.permission)),!s||"default"===s.permission)for(const c of this.context.domain.whitelistDomains)if(d.CookieDataProvider.getDomain(c)===d.CookieDataProvider.getDomain()&&-1===t.indexOf(c)){var r=this.context.app.getBrokeredFrameMessengerPath(c);if(yield this.messengerClientConnectionPool.release(this.messengerClient),this.messengerClient=yield this.messengerClientConnectionPool.checkout(r),s=(yield v.getCalculatedPermissions(this.messengerClient))||s,l.Logger.info(`BrokeredPermissionDataProvider: ${c} permissions are: `+s.permission),"default"!==s.permission)break}}let o;return s&&"default"!==s.permission?(o=s,d.CookieDataProvider.set("_pnpds",s.host)):o=e,l.Logger.info("BrokeredPermissionDataProvider: Calculated permissions are: "+o.permission),o})}removeRegistration(){return i(this,void 0,void 0,function*(){const t=[(0,u.getSelf)().location.hostname];let e=yield this.unregisterWorker();if(!e&&(this.messengerClient&&(t.push(this.messengerClient.connectedHost),e=yield v.sendUnregisterRequest(this.messengerClient)),!e)){var s=d.CookieDataProvider.get("_pnpds");if(s&&-1===t.indexOf(s)&&(t.push(s),s=this.context.app.getBrokeredFrameMessengerPath(s),yield this.messengerClientConnectionPool.release(this.messengerClient),this.messengerClient=yield this.messengerClientConnectionPool.checkout(s),e=(yield v.sendUnregisterRequest(this.messengerClient))||e),!e)for(const n of this.context.domain.whitelistDomains)if(d.CookieDataProvider.getDomain(n)===d.CookieDataProvider.getDomain()&&-1===t.indexOf(n)){var i=this.context.app.getBrokeredFrameMessengerPath(n);if(yield this.messengerClientConnectionPool.release(this.messengerClient),this.messengerClient=yield this.messengerClientConnectionPool.checkout(i),e=(yield v.sendUnregisterRequest(this.messengerClient))||e)break}}return l.Logger.info("BrokeredPermissionDataProvider: Registration removed "+e),e})}static getCalculatedPermissions(e){return i(this,void 0,void 0,function*(){try{const t=yield(0,r.awaitUntil)(e.send(h.PermissionBrokerTopic.PERMISSION_GET_PUSH_PERMISSION),500);return t&&"denied"===t.permission&&"blocked"!==d.CookieDataProvider.get("_pnss")&&(t.permission="default"),t}catch(t){throw new a.NoResponseException(new Error("Failed to get calculated permissions due to timeout."))}})}static sendUnregisterRequest(e){return i(this,void 0,void 0,function*(){let t=!1;try{t=yield(0,r.awaitUntil)(e.send(c.MessengerTopic.SERVICE_WORKER_UNREGISTER),500)}catch(t){}return t})}}e.BrokeredPermissionDataProvider=v},"./src/sdk/data-providers/brokered-session.data-provider.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})},n=(Object.defineProperty(e,"__esModule",{value:!0}),e.BrokeredSessionDataProvider=void 0,s("./src/sdk/data-providers/abstract-session.data-provider.ts"));const r=s("./src/sdk/enums/session-broker-topic.enum.ts");class o extends n.AbstractSessionDataProvider{constructor(t){super(),this.messengerClient=t}set(t,e){return i(this,void 0,void 0,function*(){return this.messengerClient.send(r.SessionBrokerTopic.SESSION_SET,[t,e])})}get(t){return i(this,void 0,void 0,function*(){return this.messengerClient.send(r.SessionBrokerTopic.SESSION_GET,[t])})}remove(t){return i(this,void 0,void 0,function*(){return this.messengerClient.send(r.SessionBrokerTopic.SESSION_REMOVE,[t])})}getCurrentPageViews(){return i(this,void 0,void 0,function*(){return this.messengerClient.send(r.SessionBrokerTopic.SESSION_GET_CURRENT_PAGE_VIEWS)})}getCurrentTotalPageViews(){return i(this,void 0,void 0,function*(){return this.messengerClient.send(r.SessionBrokerTopic.SESSION_GET_CURRENT_TOTAL_PAGE_VIEWS)})}setRootDomainPermissionData(t){return i(this,void 0,void 0,function*(){return this.messengerClient.send(r.SessionBrokerTopic.SESSION_SET,["rdpData",t])})}getRootDomainPermissionData(){return i(this,void 0,void 0,function*(){return this.messengerClient.send(r.SessionBrokerTopic.SESSION_GET,["rdpData"])})}clearRootDomainPermissionData(){return i(this,void 0,void 0,function*(){return this.messengerClient.send(r.SessionBrokerTopic.SESSION_REMOVE,["rdpData"])})}getCurrentSession(){return i(this,void 0,void 0,function*(){return this.messengerClient.send(r.SessionBrokerTopic.SESSION_GET_CURRENT_SESSION)})}}e.BrokeredSessionDataProvider=o},"./src/sdk/data-providers/cookie.data-provider.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CookieDataProvider=void 0;const o=s("./src/_utils/global-env.ts"),n=s("./src/sdk/services/logging.service.ts");function c(){return!("WorkerGlobalScope"in self)}e.CookieDataProvider=class{static get isIsolatedMode(){return!!this.domain&&this.domain.hasFlag("USE_ISOLATED_COOKIE_STORAGE_LOCATION")}static get document(){return(0,o.getDocument)()}static get location(){return(0,o.getLocation)()}static getDomain(t){let e=t||(0,o.getSelf)().location.hostname;return this.isIsolatedMode||(e=(t=>{const e=(0,o.getDocument)();let s,i,n="_sw_tld_check=cookie",r=(t||e.location.hostname).split(".");for(s=r.length-2;0<=s;s--)if(i=r.slice(s).join("."),e.cookie=n+";domain=."+i+";SameSite=strict;",-1<e.cookie.indexOf(n))return e.cookie=n.split("=")[0]+"=;domain=."+i+";SameSite=strict;expires=Thu, 01 Jan 1970 00:00:01 GMT;",i})(t))||"localhost"!==(e=(0,o.getSelf)().location.hostname)&&(e="."+e.split(".").splice(-2).join(".")),e}static set(e,s,i=730,n="d"){if(c()){null==s&&(i=-1);try{const o=new Date;var r=this.getDomain();let t=1;switch(n){case"d":case"days":t=86400;break;case"h":case"hours":t=3600;break;case"m":case"minutes":t=60}return o.setTime(o.getTime()+i*t*1e3),this.document.cookie=`${this.buildName(e)}=${s};expires=${o.toUTCString()};path=/;domain=${r};SameSite=Strict`,s}catch(t){}}}static setWithRawExpires(t,e,s){if(c())try{var i=this.getDomain();return this.document.cookie=this.buildName(t)+`=${e};expires=${s};path=/;domain=${i};SameSite=Strict`,e}catch(t){n.Logger.warn(t)}}static get(i,t=null){if(c()){var n=this.document.cookie.split(";");for(let s=0;s<n.length;s++){let t=n[s],e=t.split("=");if(e[0].trim()===this.buildName(i))return e[1].trim()}return t}}static getmv(t,e=null,s=null){let i=this.get(t,null);return null===i&&null!==s&&this.has(s)&&(i=this.get(s,e),this.clear(s),null!==i&&this.set(t,i)),i||e}static clear(t){return this.set(t,null,-1)}static has(t){return null!==this.get(t)}static buildName(t){return this.isIsolatedMode?t+"_"+this.domain.domainKey.substr(-8):t}}},"./src/sdk/data-providers/event.data-provider.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.EventManager=e.EventDataProvider=void 0;const n=s("./src/sdk/enums/messenger-topic.enum.ts"),r=s("./src/sdk/enums/amp-message-topic.enum.ts"),o=s("./src/sdk/enums/event-type.enum.ts"),c=s("./src/sdk/exceptions/invalid-event.exception.ts"),d=s("./src/sdk/enums/session-broker-topic.enum.ts"),u=s("./src/sdk/enums/permission-broker-topic.enum.ts"),a=s("./src/sdk/utils.ts");class l{constructor(){this.listeners={}}on(t,e){var s;const i=[];for(s of Array.isArray(t)?t:[t]){s=s.trim(),this.validateEventType(s);let t=(0,a.randomString)();var n=s.split(".");n&&2===n.length&&(s=n[0],t=n[1]),this.listeners[s]=this.listeners[s]||{},this.listeners[s][t]=e,i.push(this.unregisterCallback(s,t))}return Array.isArray(t)?i:i[0]}once(t,s){const e=Array.isArray(t)?t:[t],i=[];return e.forEach(t=>{t=t.trim();this.validateEventType(t);let e;e=this.on(t,t=>{null!=t?s(t):s(),e()}),i.push(e)}),Array.isArray(t)?i:i[0]}dispatch(r){return i(this,void 0,void 0,function*(){this.validateEventType(r.type);var t,e,s=this.listeners[r.type]||{};const i=[];for(t of Object.keys(s)){const n=s[t];null!=r.data?(e=Array.isArray(r.data)?r.data:[r.data],i.push(n(...e))):i.push(n())}yield Promise.all(i)})}unregisterCallback(t,e){return()=>{this.listeners[t][e]&&delete this.listeners[t][e]}}validateEventType(t){const e=[].concat(Object.keys(o.EventType).map(t=>o.EventType[t]),Object.keys(n.MessengerTopic).map(t=>n.MessengerTopic[t]),Object.keys(r.AmpMessageTopic).map(t=>r.AmpMessageTopic[t]),Object.keys(d.SessionBrokerTopic).map(t=>d.SessionBrokerTopic[t]),Object.keys(u.PermissionBrokerTopic).map(t=>u.PermissionBrokerTopic[t]));if(-1===e.indexOf(t))throw new c.InvalidEventException(t)}}e.EventDataProvider=l,e.EventManager=new l},"./src/sdk/data-providers/local-permission.data-provider.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})},s=(Object.defineProperty(e,"__esModule",{value:!0}),e.LocalPermissionDataProvider=void 0,s("./src/sdk/data-providers/abstract-permission.data-provider.ts"));class n extends s.AbstractPermissionDataProvider{getPushPermission(){return i(this,void 0,void 0,function*(){return this.getLocalPermissions()})}removeRegistration(){return i(this,void 0,void 0,function*(){return this.unregisterWorker()})}}e.LocalPermissionDataProvider=n},"./src/sdk/data-providers/local-session.data-provider.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})},n=(Object.defineProperty(e,"__esModule",{value:!0}),e.LocalSessionDataProvider=void 0,s("./src/sdk/data-providers/abstract-session.data-provider.ts"));const r=s("./src/_utils/global-env.ts"),o=s("./src/sdk/services/logging.service.ts"),c="pushly-session";class d extends n.AbstractSessionDataProvider{set(e,s){return i(this,void 0,void 0,function*(){const t=yield this.getCurrentSession();t[e]=s,d.store.setItem(c,JSON.stringify(t))})}get(t){return i(this,void 0,void 0,function*(){return(yield this.getCurrentSession())[t]})}remove(t){return i(this,void 0,void 0,function*(){return d.store.removeItem(t)})}getCurrentTotalPageViews(){return i(this,void 0,void 0,function*(){return((yield this.getCurrentSession()).pageViews||[]).length})}setRootDomainPermissionData(t){return i(this,void 0,void 0,function*(){yield this.set("rdpData",t)})}getRootDomainPermissionData(){return i(this,void 0,void 0,function*(){return this.get("rdpData")})}clearRootDomainPermissionData(){return i(this,void 0,void 0,function*(){yield this.remove("rdpData")})}getCurrentPageViews(){return i(this,void 0,void 0,function*(){return(yield this.getCurrentSession()).pageViews})}getCurrentSession(){return i(this,void 0,void 0,function*(){var e={sessionStart:Date.now(),pageViews:[]};const s=d.store;let i=s.getItem(c);if(i)try{i=JSON.parse(i)}catch(t){o.Logger.warn("Corrupt session encountered. Resetting current session."),i=Object.assign({},e),s.setItem(c,JSON.stringify(i))}else i=Object.assign({},e),s.setItem(c,JSON.stringify(i));return i.sessionStart||(o.Logger.warn("Corrupt session encountered. Resetting current session."),i=Object.assign({},e),s.setItem(c,JSON.stringify(i))),i})}static get store(){return(0,r.getSelf)().sessionStorage}}e.LocalSessionDataProvider=d},"./src/sdk/enums/amp-message-topic.enum.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AmpMessageTopic=void 0,(e=e.AmpMessageTopic||(e.AmpMessageTopic={})).CONNECT_HANDSHAKE="topic-connect-handshake",e.NOTIFICATION_PERMISSION_STATE="topic-notification-permission-state",e.SERVICE_WORKER_STATE="topic-service-worker-state",e.SERVICE_WORKER_REGISTRATION="topic-service-worker-registration",e.SERVICE_WORKER_QUERY="topic-service-worker-query",e.STORAGE_GET="topic-storage-get"},"./src/sdk/enums/amp-worker-message-topic.enum.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AmpWorkerMessageTopic=void 0,(e=e.AmpWorkerMessageTopic||(e.AmpWorkerMessageTopic={})).AMP_SUBSCRIPTION_STATE="amp-web-push-subscription-state",e.AMP_SUBSCRIBE="amp-web-push-subscribe",e.AMP_UNSUBSCRIBE="amp-web-push-unsubscribe"},"./src/sdk/enums/bell-prompt-display-behavior.enum.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.BellPromptDisplayBehavior=void 0,(e=e.BellPromptDisplayBehavior||(e.BellPromptDisplayBehavior={})).ALWAYS="ALWAYS",e.PRE_SUBSCRIPTION="PRE_SUBSCRIPTION",e.POST_SUBSCRIPTION="POST_SUBSCRIPTION"},"./src/sdk/enums/consent.enum.ts":(t,e)=>{"use strict";var s;Object.defineProperty(e,"__esModule",{value:!0}),e.ConsentStatus=e.ConsentEventKeys=void 0,(s=e.ConsentEventKeys||(e.ConsentEventKeys={})).CONSENT_REQUIRED="ca_rq",s.CONSENT_STATUS="ca_st",(s=e.ConsentStatus||(e.ConsentStatus={}))[s.UNCONFIRMED=0]="UNCONFIRMED",s[s.CONFIRMED=1]="CONFIRMED"},"./src/sdk/enums/debug-cookie-code.enum.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DebugCookieCode=void 0,(e=e.DebugCookieCode||(e.DebugCookieCode={})).sdk_impression="si",e.load_failed="lf",e.web_push_unsupported="unsp",e.mixed_integration="mxi",e.apns_not_configured="apl0",e.apns_not_enabled="apl1",e.apns_invalid_config="apl2",e.host_not_whitelisted="wlx",e.no_eligible_prompts="prx",e.platform_disabled_mobile="pldm",e.platform_disabled_desktop="pldd",e.prompt_ineligible_fcap="prif",e.user_permission_denied="updn",e.user_permission_dismissed="updm",e.user_permission_granted="upgr",e.user_ineligible="ui",e.referrer_allow="rfa",e.referrer_ignore="rfi",e.referrer_block="rfb"},"./src/sdk/enums/event-type.enum.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EventType=void 0,(e=e.EventType||(e.EventType={})).CONFIRM_CONSENT="confirm_consent",e.EXISTING_SUBSCRIPTION_DETECTED="existing_subscription_detected",e.APPLICATION_LOAD="load",e.APPLICATION_LOADED="loaded",e.APPLICATION_LOAD_ERROR="load_error",e.APPLICATION_LOAD_FAILED="load_failed",e.APPLICATION_READY="ready",e.APPLICATION_ERROR="error",e.EXIT_PERMISSIONS_DISMISSED="permission_previously_dismissed",e.EXIT_PERMISSIONS_DENIED="permission_previousy_denied",e.WEB_PUSH_SUPPORTED="web_push_supported",e.WEB_PUSH_NOT_SUPPORTED="web_push_unsupported",e.WEB_PUSH_NOT_CONFIGURED="web_push_not_configured",e.REQUEST_USER_DELETION="request_user_deletion",e.REVERT_USER_DELETION="revert_user_deletion",e.USER_DELETION_REQUEST="user_deletion_request",e.DOMAIN_APNS_NOT_CONFIGURED="apns_not_configured",e.DOMAIN_APNS_NOT_ENABLED="apns_not_enabled",e.DOMAIN_APNS_INVALID_CONFIG="apns_invalid_config",e.PROFILE_UPDATE="profile",e.PROFILE_UPDATE_EXTERNAL_ID="external_id",e.PROFILE_UPDATE_TAGS="tag",e.PROFILE_UPDATE_USER_EVENT="event",e.PROFILE_APPEND="profile_append",e.PROFILE_REMOVE="profile_remove",e.PAGE_TAG_VISIT="page_tag_visit",e.PROXY_PERMISSION_DIALOG_LOAD="proxy_permission_dialog",e.PROXY_FRAME_HELPER_LOAD="proxy_frame_helper",e.AMP_FRAME_HELPER_LOAD="amp_frame_helper",e.AMP_PERMISSION_DIALOG_LOAD="amp_permission_dialog",e.AMP_HANDSHAKE="handshake",e.AMP_CONNECT="connect",e.FLOW_LOADED="flow_loaded",e.BROKERED_DATA_SERVER_LOAD="brokered_data_server",e.NO_ELIGIBLE_PROMPTS="no_eligible_prompts",e.PROMPT_ELIGIBLE="prompt_eligible",e.PROMPT_INELIGIBLE="prompt_ineligible",e.PROMPT_SHOW="show_prompt",e.PROMPT_SHOWN="prompt_shown",e.PROMPT_ALLOWED="prompt_allowed",e.PROMPT_DISMISSED="prompt_dismissed",e.PROMPT_HIDE="prompt_hide",e.PROMPT_DISABLED="prompt_disabled",e.FOLLOW_SHOWN="prompt_shown",e.FOLLOWED="followed",e.SW_INSTALLED="sw_installed",e.SW_SETUP_COMPLETE="sw_setup_complete",e.REGISTRATION_ATTEMPT="attempt_registration",e.REGISTRATION_SUBSCRIBED="subscribed",e.REGISTRATION_UNSUBSCRIBED="unsubscribed",e.REGISTRATION_MIGRATED="migrated",e.LEGACY_PERMISSION_DIALOG_SHOWN="permission_prompted",e.PERMISSION_DIALOG_SHOWN="permission_shown",e.LEGACY_PERMISSION_GRANTED="permission_accepted",e.PERMISSION_GRANTED="permission_allowed",e.PERMISSION_DISMISSED="permission_dismissed",e.PERMISSION_DENIED="permission_denied",e.FCM_TOKEN_REFRESH="token_refreshed",e.VIEW_ITEM="view_item",e.SAVE_ITEM="save_item",e.ADD_TO_CART="add_to_cart",e.UPDATE_CART_ITEM="update_cart_item",e.PURCHASE="purchase"},"./src/sdk/enums/exception-message.enum.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ExceptionMessage=void 0,(e=e.ExceptionMessage||(e.ExceptionMessage={})).ENV_NOT_SUPPORTED="Environment is not supported.",e.USER_ABORT_REQUESTED="Aborting execution due to user request.",e.FLOW_NOT_SUPPORTED_IN_EVENT_MODE="Current flow is not supported in event only mode.",e.SDK_ALREADY_LOADED="SDK has already been loaded.",e.DUPLICATE_SDK_INSTANCE="Another instance of the Pushly SDK is already running.",e.WORKER_LOAD_FAILED="ServiceWorker could not be loaded.",e.MIGRATION_FAILED="Pushly data migration failed.",e.DOMAIN_KEY_NOT_SPECIFIED="Domain key must be specified",e.DOMAIN_UNABLE_TO_LOAD="Domain settings could not be loaded.",e.DOMAIN_APNS_NOT_CONFIGURED="Domain is not configured for use with Safari.",e.DOMAIN_APNS_NOT_ENABLED="Domain is currently disabled on Safari.",e.DOMAIN_APNS_INVALID_CONFIG="Domain configuration is invalid.",e.MIXED_INTEGRATION="Domain was configured to use both a proxy integration and native prompt.",e.HOST_NOT_WHITELISTED="Current host is not whitelisted for use",e.EXISTING_SUBSCRIPTION_DETECTED="An existing Pushly subscription has been detected",e.DIRECT_INTEGRATION_NOT_SECURE="Environment is not secure. The ServiceWorker cannot be loaded.",e.USER_UNABLE_TO_LOAD="User could not be initialized.",e.USER_INVALID_PUSH_PACKAGE="Subscription state cannot be determined.",e.USER_STATE_DENIED="Subscription state is currently set to denied.",e.USER_STATE_DISMISSED="Subscription state is currently set to dismissed.",e.USER_STATE_UNSUBBED="Subscription state is currently set to unsubscribed.",e.FAILED_TO_GET_GRANTED_TOKEN="Failed to fetch token from subscription endpoint after permission was granted. Exiting flow.",e.APNS_FAILED_TO_GET_GRANTED_TOKEN="Failed to fetch token from APNS after permission was granted. Exiting flow.",e.INVALID_TOKEN_TYPE="Token is not a valid string"},"./src/sdk/enums/integration-type.enum.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.IntegrationType=void 0,(e=e.IntegrationType||(e.IntegrationType={})).DIRECT="direct",e.PROXY="proxy"},"./src/sdk/enums/messenger-topic.enum.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.MessengerTopic=void 0,(e=e.MessengerTopic||(e.MessengerTopic={})).CONNECT_HANDSHAKE="topic-connect-handshake",e.SERVICE_WORKER_UNREGISTER="topic-service-worker-unregister"},"./src/sdk/enums/notification-permission-state.enum.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.NotificationPermissionState=void 0,(e=e.NotificationPermissionState||(e.NotificationPermissionState={})).DEFAULT="default",e.GRANTED="granted",e.DENIED="denied"},"./src/sdk/enums/permission-broker-topic.enum.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PermissionBrokerTopic=void 0,(e.PermissionBrokerTopic||(e.PermissionBrokerTopic={})).PERMISSION_GET_PUSH_PERMISSION="permission-get-push-permission"},"./src/sdk/enums/prompt-referrer-condition.enum.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PromptReferrerCondition=void 0,(e=e.PromptReferrerCondition||(e.PromptReferrerCondition={})).ALLOW="allow",e.IGNORE="ignore",e.BLOCK="block"},"./src/sdk/enums/prompt-style.enum.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PromptStyle=void 0,(e=e.PromptStyle||(e.PromptStyle={})).Native="NATIVE",e.Custom="PUBLISHER_CUSTOM",e.Slide="SLIDE",e.Bell="BELL"},"./src/sdk/enums/runtime-environment.enum.ts":(t,e)=>{"use strict";var s,i;Object.defineProperty(e,"__esModule",{value:!0}),e.RuntimeEnvironmentName=e.RuntimeEnvironment=void 0,(i=s=e.RuntimeEnvironment||(e.RuntimeEnvironment={}))[i.DIRECT=100]="DIRECT",i[i.PROXY=200]="PROXY",i[i.PROXY_PERMISSION_DIALOG=201]="PROXY_PERMISSION_DIALOG",i[i.PROXY_FRAME_HELPER=202]="PROXY_FRAME_HELPER",i[i.AMP=300]="AMP",i[i.AMP_PERMISSION_DIALOG=301]="AMP_PERMISSION_DIALOG",i[i.AMP_FRAME_HELPER=302]="AMP_FRAME_HELPER",i[i.BROKERED_DATA_SERVER=400]="BROKERED_DATA_SERVER",i[i.SERVICE_WORKER=1e3]="SERVICE_WORKER",e.RuntimeEnvironmentName={[s.DIRECT]:"Direct",[s.PROXY]:"Proxy",[s.PROXY_PERMISSION_DIALOG]:"Proxy Permission Dialog",[s.PROXY_FRAME_HELPER]:"Proxy Frame Helper",[s.AMP]:"AMP",[s.AMP_PERMISSION_DIALOG]:"AMP Permission Dialog",[s.AMP_FRAME_HELPER]:"AMP Frame Helper",[s.BROKERED_DATA_SERVER]:"Brokered Data Server",[s.SERVICE_WORKER]:"Service Worker"}},"./src/sdk/enums/session-broker-topic.enum.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SessionBrokerTopic=void 0,(e=e.SessionBrokerTopic||(e.SessionBrokerTopic={})).SESSION_GET="session-get",e.SESSION_SET="session-set",e.SESSION_REMOVE="session-remove",e.SESSION_GET_CURRENT_PAGE_VIEWS="session-get-current-page-views",e.SESSION_GET_CURRENT_TOTAL_PAGE_VIEWS="session-get-current-total-page-views",e.SESSION_GET_CURRENT_SESSION="session-get-current-session"},"./src/sdk/enums/steamable-event-type.enum.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.StreamableEventType=void 0,(e=e.StreamableEventType||(e.StreamableEventType={})).ERROR="error",e.UDR="udr",e.ANONYMOUS_PAGE_VIEW="anonymous_view_page",e.PAGE_VIEW="view_page",e.PAGE_TAG_VISITS="page_tag_visit",e.PROMPT_SHOWN="prompt_shown",e.PROMPT_ALLOWED="prompt_allow",e.PROMPT_DISMISSED="prompt_dismiss",e.PROMPT_NOT_SHOWN="prompt_not_shown",e.FOLLOW_SHOWN="follow_shown",e.FOLLOWED="follow",e.PERMISSION_PROMPTED="permission_prompted",e.PERMISSION_ACCEPTED="permission_accepted",e.PERMISSION_DENIED="permission_denied",e.PERMISSION_DISMISSED="permission_dismissed",e.SUBSCRIBED="subscribed",e.MIGRATED="migrated",e.SUBSCRIPTION_CHANGED="subscription_changed",e.TOKEN_REFRESHED="token_refreshed",e.UNSUBSCRIBED="unsubscribed",e.MANUAL_UNSUBSCRIBED="manual_unsubscribed",e.PROXY_WINDOW_BLOCKED="proxy_window_blocked",e.PROXY_WINDOW_OPENED="proxy_window_opened",e.PROXY_WINDOW_CLOSED="proxy_window_closed",e.PROFILE_UPDATE="profile",e.PROFILE_APPEND="profile_append",e.PROFILE_REMOVE="profile_remove",e.SDK_IMPRESSION="sdk_impression",e.VIEW_ITEM="view_item",e.SAVE_ITEM="save_item",e.ADD_TO_CART="add_to_cart",e.UPDATE_CART_ITEM="update_cart_item",e.PURCHASE="purchase"},"./src/sdk/enums/trackable-setting.enum.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TrackableSetting=void 0,(e=e.TrackableSetting||(e.TrackableSetting={})).ALL="all",e.LOCATION="location",e.BROWSER="browser",e.PAGE_VIEW="page_view"},"./src/sdk/exceptions/domain-load.exception.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DomainLoadException=void 0;var i=s("./src/sdk/exceptions/pushly.exception.ts");const n=s("./src/sdk/enums/exception-message.enum.ts"),r=["Failed to Fetch","Retry fetch failed","NetworkError when attempting to fetch","Network request failed","The internet connection appears to be offline","A server with the specified hostname could not be found"];class o extends i.PushlyException{constructor(t){super(t,n.ExceptionMessage.DOMAIN_UNABLE_TO_LOAD,o),this.blacklistedErrors=r,this.name="DomainLoadException"}}e.DomainLoadException=o},"./src/sdk/exceptions/exit.exception.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ExitException=void 0;class i extends s("./src/sdk/exceptions/pushly.exception.ts").PushlyException{constructor(t,e){"string"==typeof t&&(e=t,t=null),super(t,e,i),this.name="ExitException"}}e.ExitException=i},"./src/sdk/exceptions/fail.exception.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.FailException=void 0;class i extends s("./src/sdk/exceptions/pushly.exception.ts").PushlyException{constructor(t,e){"string"==typeof t&&(e=t,t=null),super(t,e,i),this.name="FailException"}}e.FailException=i},"./src/sdk/exceptions/invalid-event.exception.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.InvalidEventException=void 0;class i extends s("./src/sdk/exceptions/pushly.exception.ts").PushlyException{constructor(t){super(null,`Invalid event '${t}' specified.`,i),this.name="InvalidEventException"}}e.InvalidEventException=i},"./src/sdk/exceptions/no-connection.exception.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.NoConnectionException=void 0;class i extends s("./src/sdk/exceptions/pushly.exception.ts").PushlyException{constructor(t){super(t),this.name="NoConnectionException"}}e.NoConnectionException=i},"./src/sdk/exceptions/no-response.exception.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.NoResponseException=void 0;class i extends s("./src/sdk/exceptions/pushly.exception.ts").PushlyException{constructor(t){super(t),this.name="NoResponseException"}}e.NoResponseException=i},"./src/sdk/exceptions/profile.exception.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ProfileException=void 0;class i extends s("./src/sdk/exceptions/pushly.exception.ts").PushlyException{constructor(t,e){"string"==typeof t&&(e=t,t=null),super(t,e,i),this.name="ProfileException"}}e.ProfileException=i},"./src/sdk/exceptions/pushly.exception.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PushlyException=void 0;const n=s("./src/common/utils.ts"),r=["Invalid argument","",""," ","Ungltiges Argument","Nieprawidowy argument","Ongeldig argument","Ogiltigt argument","Argumento invlido","Argomento non valido","Virheellinen argumentti","Argument non valide"];class i extends Error{constructor(t,e,s=i){super(e||t.message),this.isPushlyException=!0,this.suppressed=!1,this.blacklistedErrors=[],this.name="PushlyException",this.originError=t;try{Object.setPrototypeOf(this,s.prototype)}catch(t){}}shouldSuppress(){if(this.suppressed)return!0;let t=this.suppressed;var e=this.originError||this;if(!t&&0<this.blacklistedErrors.length){const s=(0,n.buildRegexFromArray)(this.blacklistedErrors);t=s.test(this.name)||s.test(this.message)||s.test(e.name)||s.test(e.message)}if(!t){const i=(0,n.buildRegexFromArray)(r);t=i.test(this.name)||i.test(this.message)||i.test(e.name)||i.test(e.message)}return t}}e.PushlyException=i},"./src/sdk/exceptions/worker-registration.exception.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.WorkerRegistrationException=void 0;var i=s("./src/sdk/exceptions/pushly.exception.ts");const n=s("./src/sdk/enums/exception-message.enum.ts"),r=["ServiceWorker script evaluation failed","An unknown error occurred when fetching the script","Encountered an error during installation","Operation has been aborted","Operation was aborted","ServiceWorker cannot be started","Timed out while trying to start the service worker","Worker system has shutdown","Could not find a renderer process to run a service worker","The user denied permission to use Service Worker","An attempt was made to use an object that is not, or is no longer, usable","Request to fetch the script was interrupted","HTTP response code .?(4|5)[\\d]{2}.? was received","An SSL certificate error occurred","An SSL error has occurred","SecurityError","Please ensure that .messagingSenderId. is set correctly","The expression cannot be converted to return the specified type"];class o extends i.PushlyException{constructor(t){super(t,n.ExceptionMessage.WORKER_LOAD_FAILED,o),this.blacklistedErrors=r,this.name="WorkerRegistrationException"}}e.WorkerRegistrationException=o},"./src/sdk/factories/data-provider-factory.ts":function(t,e,s){"use strict";var c=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.DataProviderFactory=void 0;const i=s("./src/sdk/data-providers/local-session.data-provider.ts"),d=s("./src/sdk/data-providers/brokered-session.data-provider.ts"),n=s("./src/sdk/data-providers/brokered-permission.data-provider.ts"),r=s("./src/sdk/data-providers/local-permission.data-provider.ts"),u=s("./src/sdk/cross-frame-messenger/messenger-client-connection-pool.ts"),a=s("./src/_utils/global-env.ts"),l=s("./src/sdk/enums/runtime-environment.enum.ts"),h=s("./src/sdk/services/logging.service.ts");class o{static getSessionDataProvider(o){return c(this,void 0,void 0,function*(){if(!this.sessionDataProvider){const r=o.domain.whitelistDomains?o.domain.whitelistDomains[0]:(0,a.getSelf)().location.hostname;o.runtimeEnvironment!==l.RuntimeEnvironment.BROKERED_DATA_SERVER&&o.domain.hasFlag("FEAT_USE_DATA_BROKER")&&r!==(0,a.getSelf)().location.hostname?(h.Logger.info("Using BrokeredSessionDataProvider"),this.sessionDataProvider=new Promise((i,n)=>c(this,void 0,void 0,function*(){var t=o.app.getBrokeredFrameMessengerPath(r);try{const s=new u.MessengerClientConnectionPool;var e=yield s.checkout(t);i(new d.BrokeredSessionDataProvider(e))}catch(t){n(t)}}))):(h.Logger.info("Using LocalSessionDataProvider"),this.sessionDataProvider=Promise.resolve(new i.LocalSessionDataProvider))}return this.sessionDataProvider})}static getPermissionDataProvider(s){return c(this,void 0,void 0,function*(){return this.permissionDataProvider||(s.runtimeEnvironment!==l.RuntimeEnvironment.BROKERED_DATA_SERVER&&s.domain.hasFlag("FEAT_USE_DATA_BROKER")&&!s.env.isSafari()?(h.Logger.info("Using BrokeredPermissionDataProvider"),this.permissionDataProvider=new Promise((t,e)=>c(this,void 0,void 0,function*(){t(new n.BrokeredPermissionDataProvider(s))}))):(h.Logger.info("Using LocalPermissionDataProvider"),this.permissionDataProvider=Promise.resolve(new r.LocalPermissionDataProvider(s)))),this.permissionDataProvider})}}(e.DataProviderFactory=o).permissionDataProvider=null,o.sessionDataProvider=null},"./src/sdk/factories/flow.factory.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.FlowFactory=void 0;const n=s("./src/sdk/flows/proxy.flow.ts"),r=s("./src/sdk/flows/amp-frame-helper.flow.ts"),o=s("./src/sdk/enums/exception-message.enum.ts"),c=s("./src/sdk/enums/runtime-environment.enum.ts"),d=s("./src/sdk/flows/direct.flow.ts"),u=s("./src/sdk/flows/brokered-data-server.flow.ts"),a=s("./src/sdk/flows/proxy-permission-dialog.flow.ts"),l=s("./src/sdk/exceptions/exit.exception.ts"),h=s("./src/sdk/flows/amp-permission-dialog.flow.ts");e.FlowFactory=class{static getFlow(t){let e=t.env.primaryRuntimeEnvironment;var s=t.env.subRuntimeEnvironment;s&&(e=s);const i={[c.RuntimeEnvironment.DIRECT]:d.DirectFlow,[c.RuntimeEnvironment.PROXY]:n.ProxyFlow,[c.RuntimeEnvironment.PROXY_PERMISSION_DIALOG]:a.ProxyPermissionDialogFlow,[c.RuntimeEnvironment.AMP_PERMISSION_DIALOG]:h.AmpPermissionDialogFlow,[c.RuntimeEnvironment.AMP_FRAME_HELPER]:r.AmpFrameHelperFlow,[c.RuntimeEnvironment.BROKERED_DATA_SERVER]:u.BrokeredDataServerFlow}[e];if(t.domain.isEventOnlyMode()&&i!==d.DirectFlow)throw new l.ExitException(o.ExceptionMessage.FLOW_NOT_SUPPORTED_IN_EVENT_MODE);return new i(t)}}},"./src/sdk/factories/prompt.factory.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PromptFactory=void 0;const l=s("./src/sdk/enums/prompt-style.enum.ts"),i=s("./src/sdk/prompts/native.prompt.ts"),n=s("./src/sdk/prompts/custom.prompt.ts"),h=s("./src/sdk/services/logging.service.ts");var r=s("./src/sdk/models/events/eventable.model.ts");const o=s("./src/sdk/prompts/slide.prompt.ts"),c=s("./src/sdk/prompts/bell.prompt.ts");class d extends r.EventableModel{static getPrompts(s,t={}){const i=[],e=this._selectEligiblePrompts(s,t);return 0<e.length?e.forEach(t=>{const e=this._selectPromptClass(t.prompt.style);i.push(new e(s,t))}):(this.debugPromptNotShown(s,"no_eligible_prompts"),h.Logger.info("No eligible prompts found")),i}static getPromptById(t,e){const s={};let i;if(s.prompt=t.domain.prompts.find(t=>t.id.toString()===e.toString()),s.prompt&&(s.group=t.domain.promptGroups.find(t=>t.id.toString()===s.prompt.prompt_group_id.toString())),s.group){const n=this._selectPromptClass(s.prompt.style);i=new n(t,s)}return i}static _selectPromptClass(t){return{[l.PromptStyle.Native]:i.NativePrompt,[l.PromptStyle.Slide]:o.SlidePrompt,[l.PromptStyle.Bell]:c.BellPrompt,[l.PromptStyle.Custom]:n.CustomPrompt}[t]}static _selectEligiblePrompts(r,t=0){const o=[],c=r.user.env.location.href||"",d=r.user.env.getCurrentMetaKeywords(),u=r.user.env.getDeviceType(),e=r.domain.promptGroups,a=r.domain.prompts,s=e.sort((t,e)=>t.priority>e.priority?1:t.priority<e.priority?-1:0);s.some(s=>{let t=!1,i=(r.env.requires2Step()&&(t=!0,h.Logger.info("Browser requiring 2-step detected. Filtering prompts for 2-Step experience.")),a.filter(t=>t.prompt_group_id===s.id));if(0<(i=t?i.filter(t=>t.style!==l.PromptStyle.Native):i).length){let t=!0,e;var n;return(t=s.conditions_json&&!(e=this._validatePromptConditions(r,s,u,c,d)).matched?!1:t)?(n=1===i.length?i[0]:this._pickWeightedRandomPrompt(i),o.push({group:s,prompt:n}),!0):!(!e||!e.stopEvaluation)||void 0}});let i;var n;return(i=(i=0<o.length?o[0]:i)&&i.group&&void 0!==i.group.display_to_pct&&(n=i.group.display_to_pct)<100&&n<Math.floor(100*Math.random())?void 0:i)?[i]:[]}static _validatePromptConditions(t,e,s,i,n){let r={matched:!0,stopEvaluation:!1};var o;return e.conditions_json&&(o=e.conditions_json.display||{},e=e.conditions_json.page||{},(r=this._validateDisplayConditions(o,s)).matched&&(o=this._validateMetaKeywordConditions(e,n),r.matched=o.matched),r.matched&&(s=this._validatePageUrlConditions(e,i),r.matched=s.matched)),r.stopEvaluation&&r.stopEvaluationReason&&this.debugPromptNotShown(t,r.stopEvaluationReason),r}static _validateDisplayConditions(t,e){const s={matched:!0,stopEvaluation:!1};return(t.mobile||t.desktop)&&(!(e="desktop"===e)&&s.matched&&t.mobile&&("pass"===t.mobile&&(s.matched=!1),"disabled"===t.mobile&&(s.matched=!1,s.stopEvaluation=!0,s.stopEvaluationReason="platform_disabled_mobile")),e&&s.matched&&t.desktop&&("pass"===t.desktop&&(s.matched=!1),"disabled"===t.desktop&&(s.matched=!1,s.stopEvaluation=!0,s.stopEvaluationReason="platform_disabled_desktop"))),s}static _validateMetaKeywordConditions(t,s){const i={matched:!0,stopEvaluation:!1};if(i.matched&&Array.isArray(t.keywords))if(0===s.length)i.matched=!1;else{let e=!1;t.keywords.some(t=>{if(-1!==s.indexOf(t))return e=!0}),i.matched=e}return i}static _validatePageUrlConditions(t,i){const e={matched:!0,stopEvaluation:!1};if(e.matched&&t.excluded_page_urls){let s=!1;Array.isArray(t.excluded_page_urls)&&0<t.excluded_page_urls.length&&t.excluded_page_urls.some(t=>{const e=new RegExp(this._prepareRgxUrl(t),"i");if(e.test(i))return s=!0}),e.matched=!s}if(e.matched&&t.page_urls){let s=!1;Array.isArray(t.page_urls)&&0<t.page_urls.length?t.page_urls.some(t=>{const e=new RegExp(this._prepareRgxUrl(t),"i");if(e.test(i))return s=!0}):s=!0,e.matched=s}return e}static _prepareRgxUrl(t){return t.replace(/\?/g,"\\?").replace(/\+|%20/g,"(?:\\+|%20)")}static _pickWeightedRandomPrompt(t){const e=[];for(var s of t)for(let t=0;t<s.weight;t++)e.push(s);return e[Math.floor(Math.random()*e.length)]}}e.PromptFactory=d},"./src/sdk/flows/amp-frame-helper.flow.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.AmpFrameHelperFlow=void 0;const n=s("./src/sdk/message-servers/amp-frame-helper-server.ts");var r=s("./src/sdk/flows/base.flow.ts");const o=s("./src/sdk/models/events/event.model.ts"),c=s("./src/sdk/enums/event-type.enum.ts"),d=s("./src/sdk/services/worker.service.ts");class u extends r.BaseFlow{constructor(t){super(t,!1)}_wireEvents(){this.ampFrameHelperServer=new n.AmpFrameHelperServer(this.context)}run(){return i(this,void 0,void 0,function*(){yield d.WorkerService.registerWorker(this.context),yield this.dispatch(new o.EventModel(c.EventType.FLOW_LOADED))})}}e.AmpFrameHelperFlow=u},"./src/sdk/flows/amp-permission-dialog.flow.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.AmpPermissionDialogFlow=void 0;const n=s("./src/sdk/constants.ts");var r=s("./src/sdk/flows/base.flow.ts");const o=s("./src/sdk/cross-frame-messenger/messenger-client.ts"),c=s("./src/common/utils.ts"),d=s("./src/sdk/models/events/event.model.ts"),u=s("./src/sdk/enums/amp-message-topic.enum.ts"),a=s("./src/sdk/enums/event-type.enum.ts"),l=s("./src/sdk/enums/notification-permission-state.enum.ts"),h=s("./src/sdk/services/registration.service.ts"),v=s("./src/sdk/services/logging.service.ts"),p=s("./src/sdk/services/worker.service.ts");class m extends r.BaseFlow{_wireEvents(){var t=this.handlePermissionGranted.bind(this),e=this.handlePermissionDenied.bind(this);this.watch(a.EventType.REGISTRATION_SUBSCRIBED,t),this.watch(a.EventType.PERMISSION_DENIED,e),this.watch(a.EventType.PERMISSION_DISMISSED,e)}run(){return i(this,void 0,void 0,function*(){this.messengerClient=new o.MessengerClient,yield this.messengerClient.connect(window.opener,0),yield p.WorkerService.registerWorker(this.context),this.loadLanternShark(),yield this.dispatch(new d.EventModel(a.EventType.FLOW_LOADED))})}loadLanternShark(){var t=this.context.domain.domainKey;const e=document.createElement("iframe");t=n.PROXY_URL+`/amp/${t}?pushly_domain_key=`+t;e.addEventListener("load",()=>i(this,void 0,void 0,function*(){try{this.initializeDialogContent(e.contentWindow),yield h.RegistrationService.performManualRegistrationAttempt(this.context,999)}catch(t){v.Logger.error(this.context,t)}})),e.setAttribute("src",t),e.setAttribute("frame-border","0"),e.setAttribute("style","width: 100vw; height: 100vh; border: none;"),document.body.appendChild(e)}initializeDialogContent(t){t.postMessage({action:"lite-reboot",data:{context:this.context}},"*")}handlePermissionGranted(){return i(this,void 0,void 0,function*(){try{yield(0,c.awaitUntil)(this.messengerClient.send(u.AmpMessageTopic.NOTIFICATION_PERMISSION_STATE,l.NotificationPermissionState.GRANTED),500)}catch(t){}window.close()})}handlePermissionDenied(){return i(this,void 0,void 0,function*(){try{yield(0,c.awaitUntil)(this.messengerClient.send(u.AmpMessageTopic.NOTIFICATION_PERMISSION_STATE,l.NotificationPermissionState.DENIED),500)}catch(t){}window.close()})}}e.AmpPermissionDialogFlow=m},"./src/sdk/flows/base.flow.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.BaseFlow=void 0;const c=s("./src/sdk/utils.ts"),n=s("./src/sdk/models/events/subscriber-streamable-event.model.ts"),r=s("./src/sdk/models/events/base-streamable-event.model.ts"),o=s("./src/sdk/enums/steamable-event-type.enum.ts"),d=s("./src/sdk/factories/data-provider-factory.ts");class u extends s("./src/sdk/models/events/eventable.model.ts").EventableModel{constructor(t,e=!0){super(),this.context=t,this.isPromptableFlow=e,this._wireEvents()}_startPageChangeTracker(e){let s;const t=()=>i(this,void 0,void 0,function*(){var t=this.context.env.location.href;t!=s&&(this._logSessionPageView(t),(yield this.context.user.isSubscribed(this.context))?this.post(new n.SubscriberStreamableEventModel(o.StreamableEventType.PAGE_VIEW,{meta:{subscription_data:e}},this.context)):-1!==this.context.domain.flags.indexOf("FEAT_INFORMED_CONTENT")&&this.post(new r.BaseStreamableEventModel(o.StreamableEventType.ANONYMOUS_PAGE_VIEW,{meta:{page_url:t}},this.context))),s=t});setInterval(()=>t(),100),t()}_logSessionPageView(o){return i(this,void 0,void 0,function*(){try{const r=yield d.DataProviderFactory.getSessionDataProvider(this.context);var t,e=(0,c.hashFromString)(o),s=(yield r.getCurrentSession()).pageViews||[],i=0===s.length,n=!i&&s[s.length-1]!==e;(i||n)&&(t=[...s,e],yield r.set("pageViews",t))}catch(t){}})}}e.BaseFlow=u},"./src/sdk/flows/brokered-data-server.flow.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})},n=(Object.defineProperty(e,"__esModule",{value:!0}),e.BrokeredDataServerFlow=void 0,s("./src/sdk/flows/base.flow.ts"));const r=s("./src/sdk/message-servers/brokered-session-server.ts"),o=s("./src/sdk/message-servers/brokered-permission-server.ts"),c=s("./src/sdk/models/events/event.model.ts"),d=s("./src/sdk/enums/event-type.enum.ts"),u=s("./src/sdk/cross-frame-messenger/messenger-server.ts"),a=s("./src/sdk/services/registration.service.ts");class l extends n.BaseFlow{constructor(t){super(t,!1)}_wireEvents(){this.brokeredSessionServer=new r.BrokeredSessionServer(u.MessengerServer.global),this.brokeredPermissionServer=new o.BrokeredPermissionServer(this.context,u.MessengerServer.global)}run(){return i(this,void 0,void 0,function*(){yield a.RegistrationService.tryMigration(this.context,!1),yield this.dispatch(new c.EventModel(d.EventType.FLOW_LOADED))})}}e.BrokeredDataServerFlow=l},"./src/sdk/flows/direct.flow.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})},n=(Object.defineProperty(e,"__esModule",{value:!0}),e.DirectFlow=void 0,s("./src/sdk/flows/base.flow.ts"));const r=s("./src/_utils/global-env.ts"),o=s("./src/sdk/models/events/event.model.ts"),c=s("./src/sdk/enums/exception-message.enum.ts"),d=s("./src/sdk/enums/runtime-environment.enum.ts"),u=s("./src/sdk/enums/event-type.enum.ts"),a=s("./src/sdk/services/registration.service.ts"),l=s("./src/sdk/exceptions/exit.exception.ts"),h=s("./src/sdk/services/worker.service.ts"),v=s("./src/sdk/constants.ts"),p=s("./src/sdk/services/logging.service.ts");class m extends n.BaseFlow{_wireEvents(){}run(){return i(this,void 0,void 0,function*(){var t=yield this.context.user.getComputedPushPermission(this.context);if(!this.context.domain.isEventOnlyMode()&&this.context.env.primaryRuntimeEnvironment!==d.RuntimeEnvironment.PROXY){if(this.context.env.isPushManagerInScope()){if(!this.context.env.isHTTPS()&&!this.context.env.isDevMode())throw new l.ExitException(c.ExceptionMessage.DIRECT_INTEGRATION_NOT_SECURE);this.context.domain.shouldUseVapid()&&!(yield this.context.user.isSubscribed(this.context))||t.host===(0,r.getSelf)().location.hostname&&(yield h.WorkerService.registerWorker(this.context))}yield a.RegistrationService.tryMigration(this.context)}this._startPageChangeTracker(t.subscription),yield this._initStylesheet(),yield this.dispatch(new o.EventModel(u.EventType.FLOW_LOADED))})}_initStylesheet(){return i(this,void 0,void 0,function*(){const i=this.context.env,n=i.document;yield new Promise((t,e)=>{const s=n.createElement("link");s.rel="stylesheet",s.type="text/css",s.href=v.CSS_URL+"?domain_key="+this.context.domain.domainKey,i.isLocal()&&i.isHTTPS()&&/http:/i.test(s.href)&&(s.href=s.href.replace("http:","https:")),s.addEventListener("load",()=>t()),n.head.appendChild(s)}).then(()=>{}).catch(t=>p.Logger.warn(t))})}}e.DirectFlow=m},"./src/sdk/flows/proxy-permission-dialog.flow.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})},n=(Object.defineProperty(e,"__esModule",{value:!0}),e.ProxyPermissionDialogFlow=void 0,s("./src/sdk/flows/base.flow.ts"));const r=s("./src/sdk/models/events/event.model.ts"),o=s("./src/sdk/enums/event-type.enum.ts"),c=s("./src/sdk/services/logging.service.ts"),d=s("./src/sdk/services/worker.service.ts");class u extends n.BaseFlow{_wireEvents(){var t=this._handlePermissionPrompted.bind(this),e=this._handlePermissionGranted.bind(this),s=this._handlePermissionDismissed.bind(this),i=this._handlePermissionDenied.bind(this);this.watch(o.EventType.PERMISSION_DIALOG_SHOWN,t),this.watch(o.EventType.REGISTRATION_SUBSCRIBED,e),this.watch(o.EventType.PERMISSION_DISMISSED,s),this.watch(o.EventType.PERMISSION_DENIED,i)}run(){return i(this,void 0,void 0,function*(){this.context.env.isPushManagerInScope()&&(yield d.WorkerService.registerWorker(this.context)),yield this.dispatch(new r.EventModel(o.EventType.FLOW_LOADED))})}_handlePermissionPrompted(){return i(this,void 0,void 0,function*(){this._postMessage(o.EventType.PERMISSION_DIALOG_SHOWN,void 0,!1)})}_handlePermissionGranted(t){return i(this,void 0,void 0,function*(){this._postMessage(o.EventType.REGISTRATION_SUBSCRIBED,t)})}_handlePermissionDismissed(){return i(this,void 0,void 0,function*(){this._postMessage(o.EventType.PERMISSION_DISMISSED)})}_handlePermissionDenied(){return i(this,void 0,void 0,function*(){this._postMessage(o.EventType.PERMISSION_DENIED)})}_postMessage(t,e,s=!0){try{window.opener.postMessage({action:t,data:e},"*")}catch(t){c.Logger.warn(t)}finally{s&&this._closeWindow()}}_closeWindow(){setTimeout(()=>{window.close()})}}e.ProxyPermissionDialogFlow=u},"./src/sdk/flows/proxy.flow.ts":function(t,e,s){"use strict";var n=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})},i=(Object.defineProperty(e,"__esModule",{value:!0}),e.ProxyFlow=void 0,s("./src/sdk/flows/direct.flow.ts"));const r=s("./src/sdk/models/events/event.model.ts"),o=s("./src/sdk/services/user.service.ts"),c=s("./src/sdk/enums/event-type.enum.ts"),d=s("./src/sdk/services/logging.service.ts");class u extends i.DirectFlow{_wireEvents(){var t=this._handleWindowMessage.bind(this);window.addEventListener("message",t)}run(){const t=Object.create(null,{run:{get:()=>super.run}});return n(this,void 0,void 0,function*(){yield o.UserService.reloadUserWithCachePriority(this.context.user),yield t.run.call(this)})}_handleWindowMessage(i){return n(this,void 0,void 0,function*(){try{var t=this.context.domain;if(-1!==i.origin.indexOf(t.customAllowDomain)){var e=i.data.action,s=i.data.data;switch(d.Logger.info("Got message from proxy window: "+e),e){case c.EventType.PERMISSION_DIALOG_SHOWN:yield this._handlePermissionPrompted();break;case c.EventType.REGISTRATION_SUBSCRIBED:yield this._handlePermissionAccepted(s);break;case c.EventType.PERMISSION_DISMISSED:yield this._handlePermissionDismissed();break;case c.EventType.PERMISSION_DENIED:yield this._handlePermissionDenied()}yield this.dispatch(new r.EventModel(e,s))}}catch(t){d.Logger.error(this.context,t)}})}_handlePermissionPrompted(){return n(this,void 0,void 0,function*(){this.dispatch(new r.EventModel(c.EventType.PERMISSION_DIALOG_SHOWN,this._buildClientFeedbackEventPack(this.context.user.lastSeenPromptId)))})}_handlePermissionAccepted(t){return n(this,void 0,void 0,function*(){this.dispatch(new r.EventModel(c.EventType.PERMISSION_GRANTED,this._buildClientFeedbackEventPack(this.context.user.lastSeenPromptId))),yield o.UserService.setSubscriptionState(this.context.user,"subscribed",t)})}_handlePermissionDismissed(){return n(this,void 0,void 0,function*(){this.dispatch(new r.EventModel(c.EventType.PERMISSION_DISMISSED,this._buildClientFeedbackEventPack(this.context.user.lastSeenPromptId))),yield o.UserService.setSubscriptionState(this.context.user,"dismissed")})}_handlePermissionDenied(){return n(this,void 0,void 0,function*(){this.dispatch(new r.EventModel(c.EventType.PERMISSION_DENIED,this._buildClientFeedbackEventPack(this.context.user.lastSeenPromptId))),yield o.UserService.setSubscriptionState(this.context.user,"blocked")})}_buildClientFeedbackEventPack(t=null,e=[]){return{prompt:{id:t,keywords:e}}}}e.ProxyFlow=u},"./src/sdk/message-servers/abstract-message-server.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AbstractMessageServer=void 0;const i=s("./src/sdk/services/logging.service.ts");class n extends s("./src/sdk/models/events/eventable.model.ts").EventableModel{andReply(t){return e=>{t(e.data).then(t=>{e.reply(t)}).catch(t=>{i.Logger.warn("MessageServerError encountered:",t)})}}}e.AbstractMessageServer=n},"./src/sdk/message-servers/amp-frame-helper-server.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})},n=(Object.defineProperty(e,"__esModule",{value:!0}),e.AmpFrameHelperServer=void 0,s("./src/sdk/message-servers/abstract-message-server.ts"));const r=s("./src/sdk/cross-frame-messenger/messenger-server.ts"),o=s("./src/sdk/enums/amp-message-topic.enum.ts"),c=s("./src/sdk/models/events/event.model.ts"),d=s("./src/sdk/enums/amp-worker-message-topic.enum.ts"),u=s("./src/sdk/services/user.service.ts"),a=s("./src/sdk/enums/event-type.enum.ts"),l=s("./src/sdk/enums/notification-permission-state.enum.ts"),h=s("./src/sdk/services/registration.service.ts");class v extends n.AbstractMessageServer{constructor(t){super(),this.context=t,this.bindEvents()}bindEvents(){r.MessengerServer.global.watch(o.AmpMessageTopic.NOTIFICATION_PERMISSION_STATE,this.andReply(this.handlePermissionStateMessage.bind(this))),r.MessengerServer.global.watch(o.AmpMessageTopic.SERVICE_WORKER_STATE,this.andReply(this.handleWorkerStateMessage.bind(this))),r.MessengerServer.global.watch(o.AmpMessageTopic.SERVICE_WORKER_REGISTRATION,this.andReply(this.handleWorkerRegistrationMessage.bind(this))),r.MessengerServer.global.watch(o.AmpMessageTopic.SERVICE_WORKER_QUERY,this.andReply(this.handleWorkerQueryMessage.bind(this))),r.MessengerServer.global.watch(o.AmpMessageTopic.STORAGE_GET,this.andReply(this.handleStorageGetMessage.bind(this)))}handlePermissionStateMessage(){return i(this,void 0,void 0,function*(){return{success:!0,result:!0}})}handleWorkerStateMessage(){return i(this,void 0,void 0,function*(){return{success:!0,result:{isControllingFrame:!!window.navigator.serviceWorker.controller,url:window.navigator.serviceWorker.controller?window.navigator.serviceWorker.controller.scriptURL.split("?")[0]:null,state:window.navigator.serviceWorker.controller?window.navigator.serviceWorker.controller.state:null}}})}handleWorkerRegistrationMessage(){return i(this,void 0,void 0,function*(){return{success:!0,result:null}})}handleWorkerQueryMessage(s){return i(this,void 0,void 0,function*(){const t=this.context.user;let e=null;switch(s.topic){case d.AmpWorkerMessageTopic.AMP_SUBSCRIPTION_STATE:e=yield t.isSubscribed(this.context);break;case d.AmpWorkerMessageTopic.AMP_UNSUBSCRIBE:yield h.RegistrationService.unsubscribe(this.context);break;case d.AmpWorkerMessageTopic.AMP_SUBSCRIBE:}return{success:!0,result:e}})}handleStorageGetMessage(){return i(this,void 0,void 0,function*(){const t=this.context.user;let e=l.NotificationPermissionState.DEFAULT;return(yield t.isSubscribed(this.context))&&(e=l.NotificationPermissionState.GRANTED,"subscribed"!==t.subscriberState&&(yield u.UserService.reloadUserWithCachePriority(t),yield this.dispatch(new c.EventModel(a.EventType.REGISTRATION_SUBSCRIBED,t.token)))),(t.isBlocked()||t.isDismissed())&&(e=l.NotificationPermissionState.DENIED,"none"===t.subscriberState&&(yield this.dispatch(new c.EventModel(a.EventType.PERMISSION_DENIED)))),{success:!0,result:e}})}}e.AmpFrameHelperServer=v},"./src/sdk/message-servers/brokered-permission-server.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.BrokeredPermissionServer=void 0;const i=s("./src/sdk/data-providers/local-permission.data-provider.ts");var n=s("./src/sdk/message-servers/abstract-message-server.ts");const r=s("./src/sdk/enums/messenger-topic.enum.ts"),o=s("./src/sdk/enums/permission-broker-topic.enum.ts");class c extends n.AbstractMessageServer{constructor(t,e){super(),this.context=t,this.messengerServer=e,this.dataProvider=new i.LocalPermissionDataProvider(t),this.bindEvents()}bindEvents(){this.messengerServer.watch(o.PermissionBrokerTopic.PERMISSION_GET_PUSH_PERMISSION,this.andReply(this.dataProvider.getPushPermission.bind(this.dataProvider))),this.messengerServer.watch(r.MessengerTopic.SERVICE_WORKER_UNREGISTER,this.andReply(this.dataProvider.removeRegistration.bind(this.dataProvider)))}}e.BrokeredPermissionServer=c},"./src/sdk/message-servers/brokered-session-server.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})},n=(Object.defineProperty(e,"__esModule",{value:!0}),e.BrokeredSessionServer=void 0,s("./src/sdk/message-servers/abstract-message-server.ts"));const r=s("./src/sdk/data-providers/local-session.data-provider.ts"),o=s("./src/sdk/enums/session-broker-topic.enum.ts");class c extends n.AbstractMessageServer{constructor(t){super(),this.messengerServer=t,this.dataProvider=new r.LocalSessionDataProvider,this.bindEvents()}bindEvents(){this.messengerServer.watch(o.SessionBrokerTopic.SESSION_GET,this.andReply(this.dataProvider.get.bind(this.dataProvider))),this.messengerServer.watch(o.SessionBrokerTopic.SESSION_REMOVE,this.andReply(this.dataProvider.remove.bind(this.dataProvider))),this.messengerServer.watch(o.SessionBrokerTopic.SESSION_GET_CURRENT_PAGE_VIEWS,this.andReply(this.dataProvider.getCurrentPageViews.bind(this.dataProvider))),this.messengerServer.watch(o.SessionBrokerTopic.SESSION_GET_CURRENT_TOTAL_PAGE_VIEWS,this.andReply(this.dataProvider.getCurrentTotalPageViews.bind(this.dataProvider))),this.messengerServer.watch(o.SessionBrokerTopic.SESSION_GET_CURRENT_SESSION,this.andReply(this.dataProvider.getCurrentSession.bind(this.dataProvider))),this.messengerServer.watch(o.SessionBrokerTopic.SESSION_SET,this.andReply(t=>i(this,void 0,void 0,function*(){return this.dataProvider.set(t[0],t[1])})))}}e.BrokeredSessionServer=c},"./src/sdk/models/application/app.model.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AppModel=void 0;const i=s("./src/sdk/constants.ts");e.AppModel=class{constructor(){this.env=i.ENV_NAME,this.version=i.PUSHLY_APPLICATION_VERSION,this.classNames={},this.isLoaded=!1,this.isReady=!1,this.isDisabled=!1,this.isVisibleLoggingEnabled=!1,this.isEventOnlyMode=!1,this.mode="production"}getBrokeredFrameMessengerPath(t){return this.loadConfig.frameMessenger?"https://"+t+this.loadConfig.frameMessenger:this.loadConfig.sw?`https://${t}${this.loadConfig.sw.substr(0,this.loadConfig.sw.lastIndexOf("/"))}/pushly-frame-messenger.html`:`https://${t}/pn-brokered-data-server.html`}}},"./src/sdk/models/application/environment.model.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.EnvironmentModel=void 0;const n=s("./src/sdk/data-providers/local-permission.data-provider.ts"),r=s("./src/_utils/global-env.ts"),o=s("./src/sdk/utils.ts"),c=s("./src/sdk/factories/data-provider-factory.ts");e.EnvironmentModel=class{constructor(){this.mode="production"}get scope(){return(0,r.getSelf)()}get navigator(){return(0,r.getNavigator)()}get location(){return(0,r.getLocation)()}get document(){return(0,r.getDocument)()}get referrer(){return(0,r.getDocument)().referrer}get userAgent(){return(0,r.getNavigator)().userAgent}getDeviceType(){let t;return t=navigator.userAgentData?navigator.userAgentData.mobile?"mobile":"desktop":/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)?"mobile":"desktop"}getCurrentMetaTags(){let t;const e=this.document;return t=e?e.getElementsByTagName("meta"):t}getCurrentMetaKeywords(){let t=[];var e=this.getCurrentMetaTags();if(e&&e.keywords){const s=e.keywords;e=s.content.split(",").map(t=>t.toString().trim().toLowerCase());e&&0<e.length&&(t=e)}return t}getQueryString(){return(0,o.parseQueryString)(this.location.search)}getGlobalScope(){return this.inSourcelessIFrame()?top:this.inWorkerGlobalScope()?self:window}inWorkerGlobalScope(){return"WorkerGlobalScope"in self}inSourcelessIFrame(){return window.self!==window.top&&window.frameElement&&"about:blank"===window.frameElement.src}requires2Step(){return!!this.isSafari()||(!navigator.userAgentData||(navigator.userAgentData.brands.forEach(t=>{if(t.brand.indexOf("irefox"))return!0}),!1))}isSafari(){return navigator.vendor.match(/apple/i)&&!navigator.userAgent.match(/crios/i)&&!navigator.userAgent.match(/fxios/i)&&!navigator.userAgent.match(/Opera|OPT\//)}isSafariPushCapable(){return this.isSafari()&&"pushNotification"in this.scope.safari}isPushManagerInScope(){return"PushManager"in this.scope}isArrayFullySupported(){return"Array"in this.scope&&"from"in Array&&"some"in[]}isDevMode(){return"development"===this.mode}isHTTPS(){return"https:"===this.location.protocol}isLocal(){return"localhost"===this.location.hostname||"127.0.0.1"===this.location.hostname}getLocalPushPermission(e){return i(this,void 0,void 0,function*(){const t=yield new n.LocalPermissionDataProvider(e);return yield t.getPushPermission()})}getComputedPushPermission(e){return i(this,void 0,void 0,function*(){const t=yield c.DataProviderFactory.getPermissionDataProvider(e);return yield t.getPushPermission()})}isPushSupported(){return i(this,void 0,void 0,function*(){let e="location"in this.scope;if(e||(this.unsupportedReason="self.location not accessible"),!e||(e="navigator"in this.scope)||(this.unsupportedReason="self.navigator not accessible"),!e||(e="userAgent"in this.navigator)||(this.unsupportedReason="self.userAgent not accessible"),!e||(e=this.navigator.cookieEnabled)||(this.unsupportedReason="self.navigator.cookieEnabled is FALSE"),!e||(e="Notification"in this.scope)||(this.unsupportedReason="self.Notification not accessible"),!e||(e=this.isArrayFullySupported())||(this.unsupportedReason="required Array functionality not accessible"),!e||(e=!!this.location.host)||(this.unsupportedReason="self.location.host is undefined"),!e||(e=!!this.location.hostname)||(this.unsupportedReason="self.location.hostname is undefined"),e)try{e=!!this.location.hostname.split("")}catch(t){e=!1,this.unsupportedReason="self.location.hostname is not a valid String"}if(e){const s=/bot|HeadlessChrome|googlebot|crawler|spider|robot|crawling/im;(e=!s.test(this.navigator.userAgent))||(this.unsupportedReason="self.navigator.userAgent is recognizedBot"),!e||(e=!s.test(this.navigator.appVersion))||(this.unsupportedReason="self.navigator.appVersion is recognizedBot"),!e||(e=!s.test(this.navigator.appCodeName))||(this.unsupportedReason="self.navigator.appCodeName is recognizedBot"),!e||(e=!s.test(this.navigator.product))||(this.unsupportedReason="self.navigator.product is recognizedBot")}const t=/iphone|ipad/i;if(!e||(e=!t.test(this.navigator.userAgent))||(this.unsupportedReason="self.navigator.userAgent is iDevice"),!e||(e=!(this.navigator.platform&&t.test(this.navigator.platform)))||(this.unsupportedReason="self.navigator.platform is iDevice"),e&&this.isSafari()&&!this.isPushManagerInScope())!e||(e=this.isSafariPushCapable())||(this.unsupportedReason="self.safari.pushNotification is not accessible");else if(!e||(e="PushManager"in this.scope)||(this.unsupportedReason="self.PushManager is not accessible"),!e||(e="PushSubscription"in this.scope)||(this.unsupportedReason="self.PushSubscription is not accessible"),!e||(e=this.scope.PushSubscription.prototype.hasOwnProperty("getKey"))||(this.unsupportedReason="self.PushSubscription.prototype.getKey is not accessible"),(this.isHTTPS()||this.isDevMode())&&(e&&!(e="ServiceWorker"in this.scope)&&(this.unsupportedReason="self.ServiceWorker is not accessible"),e&&!(e="serviceWorker"in this.navigator)&&(this.unsupportedReason="self.navigator.serviceWorker is not accessible"),e&&!(e="ServiceWorkerRegistration"in this.scope)&&(this.unsupportedReason="self.ServiceWorkerRegistration is not accessible"),e&&!(e=this.scope.ServiceWorkerRegistration.prototype.hasOwnProperty("showNotification"))&&(this.unsupportedReason="self.ServiceWorkerRegistration.prototype.showNotification is not accessible"),e))try{yield this.navigator.serviceWorker.getRegistration()}catch(t){e=!1,this.unsupportedReason="call to self.navigator.serviceWorker.getRegistration() failed"}return e})}}},"./src/sdk/models/context.model.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ContextModel=void 0;e.ContextModel=class{constructor(){this.clock=0,this.t=!1}}},"./src/sdk/models/domains/domain.model.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DomainModel=e.DomainFrequencyCapMetric=void 0;const r=s("./src/_utils/domain-matching.ts"),i=s("./src/_utils/global-env.ts");(s=e.DomainFrequencyCapMetric||(e.DomainFrequencyCapMetric={})).DAYS="days",s.HOURS="hours",s.MINUTES="minutes";e.DomainModel=class{constructor(){this.flags=[],this.additionalSubscriptionData=[],this.promptGroups=[],this.prompts=[],this.isCached=!1}shouldReplaceExistingWorkerInPushlyScope(){return this.hasFlag("REPLACE_EXISTING_WORKERS")}shouldUnregisterNonPushlyWorkers(){return this.hasFlag("UNREGISTER_ALL_NON_PUSHLY_WORKERS")}shouldUseCustomVapidKey(){return!!this.vapidPublicKey}shouldUseVapid(){return"PushManager"in(0,i.getSelf)()}hasFlag(t){return Array.isArray(this.flags)&&-1!==this.flags.indexOf(t.toString().toUpperCase())}hasApnsConfig(){return!!this.apnsConfiguration}isApnsConfigEnabled(){return this.hasApnsConfig()&&!0===this.apnsConfiguration.is_active}getPushPackageSettings(){return(this.apnsConfiguration||{}).push_package||{}}getWebsitePushId(){return this.getPushPackageSettings().website_push_id}isEventOnlyMode(){const t=this.whitelistDomains||[],e=this.sdkEventOnlyDomains||["oceans3.deepbluedev.com"];var s=this.hasFlag("FEAT_SDK_EVENT_ONLY_DOMAINS"),i=t.some(r.domainMatchPredicate),n=e.some(r.domainMatchPredicate);return s&&i&&n}}},"./src/sdk/models/domains/global-prompt-referrer-conditions.model.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GlobalPromptReferrerConditionsModel=void 0;const i=s("./src/sdk/enums/prompt-referrer-condition.enum.ts").PromptReferrerCondition.IGNORE;e.GlobalPromptReferrerConditionsModel=class n{constructor(){this.persist_ttl_seconds=259200}static parse(t){const e=new n;return t=t||{},e.enabled=t.enabled||!1,e.persist_ttl_seconds=t.persist_ttl_seconds||e.persist_ttl_seconds,e.when_self=t.when_self||i,e.when_blank=t.when_blank||i,e.allowed=t.allowed||void 0,e.blocked=t.blocked||void 0,e}}},"./src/sdk/models/events/base-streamable-event.model.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.BaseStreamableEventModel=void 0;const n=s("./src/sdk/constants.ts"),r=s("./src/sdk/utils.ts");e.BaseStreamableEventModel=class{constructor(t,e,s){this.type=t,this.additionalData=e,this.context=s,this.id=(0,r.randomString)(),this.eventDate=(new Date).toISOString()}getPostData(){return i(this,void 0,void 0,function*(){return Object.assign(Object.assign({},this.additionalData),{action:this.type,domain_id:this.context.domain.id,event_date:this.eventDate,meta:Object.assign(Object.assign({},this.additionalData.meta||{}),{event_id:this.id,source:{application:n.PUSHLY_SDK_APPLICATION_NAME,version:n.PUSHLY_APPLICATION_VERSION}})})})}getRequestObject(t){return i(this,void 0,void 0,function*(){return{endpoint:t||n.EVENTS_ENDPOINT,method:"POST",headers:{"content-type":"text/plain"},body:JSON.stringify(yield this.getPostData())}})}}},"./src/sdk/models/events/event.model.ts":(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EventModel=void 0;e.EventModel=class{constructor(t,...e){this.type=t,this.data=e}}},"./src/sdk/models/events/eventable.model.ts":function(t,e,s){"use strict";var n=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.EventableModel=void 0;const m=s("./src/sdk/models/events/subscriber-streamable-event.model.ts"),f=s("./src/sdk/enums/debug-cookie-code.enum.ts"),i=s("./src/_utils/global-env.ts"),r=s("./src/sdk/utils.ts"),o=s("./src/common/data-providers/api.data-provider.ts"),y=s("./src/sdk/data-providers/cookie.data-provider.ts"),b=s("./src/sdk/enums/steamable-event-type.enum.ts"),c=s("./src/sdk/data-providers/event.data-provider.ts");class d{constructor(){this.e=(0,r.randomString)()}static post(e,s){return n(this,void 0,void 0,function*(){var t=yield e.getRequestObject(s);return o.ApiDataProvider.exec(t.endpoint,t.method,t.headers,t.body,!1)})}static debug(l,h,v,p,t){return n(this,void 0,void 0,function*(){try{const u=(0,i.getDocument)();if(l.domain&&l.domain.hasFlag("SDK_DEBUG_EVENTS")){let t=!0,e="_pndbg",s=String(h),i={};h===b.StreamableEventType.PROMPT_NOT_SHOWN&&(e="_pndbgpr",s=v,i={prompt_not_shown_reason:v||"unknown"},p&&(i.error_message=p));var n=new RegExp(e+"=([^;]+)","i"),r=u.cookie.match(n),o=(e=>{try{return e in f.DebugCookieCode?f.DebugCookieCode[e]:e&&""!==String(e).trim()?e.split("_").map(t=>t[0]).join(""):e}catch(t){return e}})(s);if(r&&r[1]&&(r[1]!==s&&r[1]!==o||(t=!1)),s=o,t){const a=new Date;var c=Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate()+1),d=new Date(c).toUTCString();return yield y.CookieDataProvider.setWithRawExpires(e,s,d),this.post(new m.SubscriberStreamableEventModel(h,{meta:i},l))}}}catch(t){}})}static debugPromptNotShown(t,e,s){return n(this,void 0,void 0,function*(){return this.debug(t,b.StreamableEventType.PROMPT_NOT_SHOWN,e,s)})}watch(t,e){return c.EventManager.on(t,e)}watchOnce(t,e){return c.EventManager.once(t,e)}unwatch(t,e){c.EventManager.unregisterCallback(t,e)}dispatch(t){return n(this,void 0,void 0,function*(){yield c.EventManager.dispatch(t)})}post(t,e){return n(this,void 0,void 0,function*(){return d.post(t,e)})}debug(t,e,s,i){return n(this,void 0,void 0,function*(){return d.debug(t,e,s,null,i)})}debugPromptNotShown(t,e,s){return n(this,void 0,void 0,function*(){return d.debugPromptNotShown(t,e,s)})}}e.EventableModel=d},"./src/sdk/models/events/subscriber-streamable-event.model.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.SubscriberStreamableEventModel=void 0;const h=s("./src/_utils/consent.ts");var n=s("./src/sdk/models/events/base-streamable-event.model.ts");const v=s("./src/_utils/global-env.ts"),p=s("./src/sdk/utils.ts"),m=s("./src/sdk/data-providers/cookie.data-provider.ts");class r extends n.BaseStreamableEventModel{getPostData(){const l=Object.create(null,{getPostData:{get:()=>super.getPostData}});return i(this,void 0,void 0,function*(){var t=yield l.getPostData.call(this);let e,s,i,n,r,o,c,d,u;if(this.context.user){s=this.context.user.doNotTrackFlags,i=this.context.user.puuid,n=this.context.user.externalId,r=this.context.user.token,o=this.context.user.lastSeenPromptId;var a=(0,v.getLocation)();c=this.context.user.isPageViewTrackable()?a.href:void 0;try{d=Intl.DateTimeFormat().resolvedOptions().locale,u=this.context.user.isLocationTrackable()?Intl.DateTimeFormat().resolvedOptions().timeZone:void 0}catch(t){}}if(!i)try{let t=m.CookieDataProvider.get("pushly.user_puuid");t||(t=(0,p.randomString)(),m.CookieDataProvider.set("pushly.user_puuid",t)),i=t}catch(t){}if(i&&/undefined/i.test(i.toString())&&(i=(0,p.randomString)(),m.CookieDataProvider.set("pushly.user_puuid",i)),e=Object.assign(Object.assign(Object.assign(Object.assign({},t),{domain_key:this.context.domainKey,do_not_track:s}),(0,h.buildSdkConsentEventData)(this.context)),{meta:Object.assign(Object.assign({},t.meta),{pushly_unique_user_id:i,external_id:n})}),this.context.env.isSafari()&&!this.context.env.isPushManagerInScope()?e.meta.apns_token=r:!!this.context.domain&&this.context.domain.shouldUseVapid()||(e.meta.fcm_subscription_id=r),e.meta){let t=e.meta;t.prompt_id=t.promptId||t.prompt_id,t.prompt_id||(t.prompt_id=o),delete t.promptId}return e.meta.page_url=c,e.meta.language=d,e.meta.time_zone=u,e})}}e.SubscriberStreamableEventModel=r},"./src/sdk/models/users/user.model.ts":function(t,e){"use strict";var s=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.UserModel=void 0;e.UserModel=class i{constructor(){this.doNotTrackFlags=[],this.subscriberState="none",this.isInUdr=!1}static of(t){const e=new i;return Object.assign(e,t),e.subscriberState||(e.subscriberState="none"),e}isUnsubscribed(t){return s(this,void 0,void 0,function*(){return"unsubscribed"===this.subscriberState&&"default"===(yield this.getComputedPushPermission(t)).permission||this.isInUdr})}getComputedPushPermission(t){return s(this,void 0,void 0,function*(){return this._computedPushPermission||(this._computedPushPermission=yield this.env.getComputedPushPermission(t)),this._computedPushPermission})}getLocalPushPermission(t,e=!1){return s(this,void 0,void 0,function*(){return this._localPushPermission&&!e||(this._localPushPermission=yield this.env.getLocalPushPermission(t)),this._localPushPermission})}setPushPermission(t){this._localPushPermission=t,this._computedPushPermission=t}isSubscribed(t){return s(this,void 0,void 0,function*(){return("subscribed"===this.subscriberState||"granted"===(yield this.getComputedPushPermission(t)).permission)&&!this.isInUdr})}isDismissed(){return"dismissed"===this.subscriberState}isBlocked(){return"blocked"===this.subscriberState}isEligibleToPrompt(t){return s(this,void 0,void 0,function*(){return!(yield this.isSubscribed(t))&&!this.isDismissed()&&!this.isBlocked()})}isLocationTrackable(){return-1===(this.doNotTrackFlags||[]).indexOf("location")&&!this.isInUdr}isPageViewTrackable(){return-1===(this.doNotTrackFlags||[]).indexOf("page_view")&&!this.isInUdr}}},"./src/sdk/prompts/base.prompt.ts":function(t,e,s){"use strict";var u=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.BasePrompt=void 0;const a=s("./src/sdk/utils.ts"),i=s("./src/sdk/enums/prompt-style.enum.ts"),n=s("./src/sdk/models/events/event.model.ts"),r=s("./src/sdk/enums/event-type.enum.ts"),l=s("./src/sdk/services/user.service.ts"),d=s("./src/sdk/enums/prompt-referrer-condition.enum.ts"),o=s("./src/sdk/models/domains/global-prompt-referrer-conditions.model.ts"),c=s("./src/sdk/factories/data-provider-factory.ts"),h=s("./src/sdk/services/logging.service.ts");class v extends s("./src/sdk/models/events/eventable.model.ts").EventableModel{constructor(t,e,s=!0){super(),this.context=t,this.settings=e,this.envSupported=s,this.userReferrerIsAllowed=!0,this.bypassEligibilityCheck=!1,s&&(h.Logger.info(`Preloading ${this.style} prompt ${this.promptId}, `+this.name),this._wireEvents())}get groupId(){return this.settings.group.id}get promptId(){return this.settings.prompt.id}get style(){return this.settings.prompt.style}get name(){let t=this.settings.group.name;return t=this.settings.prompt.name?t+" - "+this.settings.prompt.name:t}get promptConfig(){return this.settings.prompt.config||{}}get promptConditions(){return this.settings.prompt.conditions_json||{}}isNativePrompt(){return this.style===i.PromptStyle.Native}isSlidePrompt(){return this.style===i.PromptStyle.Slide}isBellPrompt(){return this.style===i.PromptStyle.Bell}get isUserSubscribed(){return this.context.user.isSubscribed(this.context)}run(t){return u(this,void 0,void 0,function*(){this.bypassEligibilityCheck=!!t&&!!t.bypassEligibilityCheck,this.userReferrerIsAllowed=yield this._evaluateCurrentReferrer()})}_attemptToShow(){return u(this,void 0,void 0,function*(){yield(0,a.delay)(Math.floor(50*Math.random()))})}_show(){return u(this,void 0,void 0,function*(){h.Logger.info(`Showing prompt ${this.promptId}, `+this.name),this.dispatch(new n.EventModel(r.EventType.PROMPT_SHOWN,this._buildDispatchEventPack())),this._incrementUserPromptCount(),yield this._setLastSeenPromptId()})}_buildDispatchEventPack(){return u(this,void 0,void 0,function*(){return{prompt:{id:this.promptId,keywords:[]},subscribed:this.isUserSubscribed}})}_buildPostEventPack(){return u(this,void 0,void 0,function*(){return{meta:{promptId:this.promptId,subscribed:yield this.isUserSubscribed}}})}_incrementUserPromptCount(){try{var t=this.isNativePrompt()||this.isSlidePrompt(),e=!!this.context.domain&&!!this.context.domain.frequencyCaps&&!!this.context.domain.frequencyCaps.prompt;if(t&&e){var s,i=this.context.domain.frequencyCaps.prompt.fcap_seconds;if(0<i){const n=this.context.user.promptCountState;let t=0,e=new Date;e.setTime(e.getTime()+1e3*i),!n||2===(s=n.split("|")).length&&(t=parseInt(s[0],10),e=s[1]),e instanceof Date&&(e=e.toUTCString()),l.UserService.setPromptState(this.context.user,i,t+1+"|"+e,e)}}}catch(t){h.Logger.warn("Encountered an error while updating prompt frequency cap",t)}}_setLastSeenPromptId(){return u(this,void 0,void 0,function*(){(yield this.isUserSubscribed)||(yield l.UserService.setLastSeenPromptId(this.context.user,this.promptId))})}_canShow(){return u(this,void 0,void 0,function*(){var t=this._isPlacementEnabled();return(yield this._isUserEligibleToPrompt())&&t})}_isPlacementEnabled(){let t=!1;var e="desktop"===this.context.env.getDeviceType(),s=this.promptConfig.position||{},i="disabled"!==s.desktop,s="disabled"!==s.mobile;return t=e&&i||!e&&s?!0:t}_isCustomOrBaseSubStateEligible(){return u(this,void 0,void 0,function*(){var t=yield this.context.user.getComputedPushPermission(this.context);return this.style===i.PromptStyle.Custom||"denied"!==t.permission})}_isUserEligibleToPrompt(){return u(this,void 0,void 0,function*(){let e=!1;if(this.bypassEligibilityCheck)e=yield this._isCustomOrBaseSubStateEligible();else{const i=this.context.user;var s=yield this.context.user.isEligibleToPrompt(this.context),s=this.isBellPrompt()||s;let t=!0;s&&(this.isNativePrompt()||this.isSlidePrompt())&&(t=this._evaluateFcapConditions()),this.userReferrerIsAllowed?s?t?e=!0:this.debugPromptNotShown(this.context,"prompt_ineligible_fcap"):i.isBlocked()?this.debugPromptNotShown(this.context,"user_permission_denied"):i.isDismissed()?this.debugPromptNotShown(this.context,"user_permission_dismissed"):(yield i.isSubscribed(this.context))?this.debugPromptNotShown(this.context,"user_permission_granted"):this.debugPromptNotShown(this.context,"user_ineligible"):this.debugPromptNotShown(this.context,"referrer_"+this.userReferrerState)}return e})}_evaluateRunConditions(){return u(this,void 0,void 0,function*(){return new Promise(d=>u(this,void 0,void 0,function*(){const i=this.promptConfig.behavior||{},n=this.promptConditions.visitor||{},r=!!n.time_on_page_seconds,s=!!n.session_page_views,o=!!n.session_time_on_site_seconds,t=new Promise(e=>u(this,void 0,void 0,function*(){if(s)if(yield this._evaluateSessionPageViewConditions())e();else{h.Logger.info(`Prompt condition: Page views [at least ${n.session_page_views} pages]`);const t=setInterval(()=>u(this,void 0,void 0,function*(){(yield this._evaluateSessionPageViewConditions())&&(clearInterval(t),e())}),1e3)}else e()})),e=new Promise(e=>u(this,void 0,void 0,function*(){if(o)if(yield this._evaluateSessionTimeOnSiteConditions())e();else{h.Logger.info(`Prompt condition: Time on site [at least ${n.session_time_on_site_seconds} seconds]`);const t=setInterval(()=>u(this,void 0,void 0,function*(){(yield this._evaluateSessionTimeOnSiteConditions())&&(clearInterval(t),e())}),1e3)}else e()})),c=new Promise(s=>u(this,void 0,void 0,function*(){var t=self._swclk_||0;let e=i.delay_seconds||0;r&&(e=n.time_on_page_seconds||0,h.Logger.info(`Prompt condition: Time on page [at least ${e} seconds]`)),(e=e>t?e-t:0)<0&&(e=0),yield(0,a.delay)(1e3*e),s()}));yield Promise.all([t.then(()=>{s&&h.Logger.info("Prompt condition: Page views [satisfied]")}),e.then(()=>{o&&h.Logger.info("Prompt condition: Time on site [satisfied]")}),c.then(()=>{r&&h.Logger.info("Prompt condition: Time on page [satisfied]")})]),d()}))})}_evaluateSessionPageViewConditions(){return u(this,void 0,void 0,function*(){const t=yield c.DataProviderFactory.getSessionDataProvider(this.context);let e=!1;var s=this.promptConditions.visitor.session_page_views,i=yield t.getCurrentTotalPageViews();return e=s<=i?!0:e})}_evaluateSessionTimeOnSiteConditions(){return u(this,void 0,void 0,function*(){const t=yield c.DataProviderFactory.getSessionDataProvider(this.context);let e=!1;var s=Date.now(),i=(yield t.getCurrentSession()).sessionStart,n=this.promptConditions.visitor.session_time_on_site_seconds;return e=n<=(s-i)/1e3?!0:e})}_evaluateFcapConditions(){let t=!0,e=0;try{var s=this.isNativePrompt()||this.isSlidePrompt(),i=!!this.context.domain&&!!this.context.domain.frequencyCaps&&!!this.context.domain.frequencyCaps.prompt;if(s)if(i){var n=this.context.domain.frequencyCaps.prompt;const d=this.context.user.promptCountState;var r=this.context.user.promptFcapSeconds;if(String(r)!==String(n.fcap_seconds))l.UserService.clearPromptFcapState();else if(d){var o=d.split("|");if(2===o.length){var c=o[1];if(((0,a.tryParseInt)(o[0])||0)>=n.occurrences){t=!1;try{e=Math.floor((Date.parse(c)-(new Date).getTime())/1e3)}catch(t){}}}}}else l.UserService.clearPromptFcapState()}catch(t){h.Logger.warn("Encountered an error while checking prompt frequency cap")}return t||h.Logger.info("Prompt frequency cap has been met"+(0<e?` - ${e} seconds remain`:"")),t}_evaluateCurrentReferrer(){return u(this,void 0,void 0,function*(){let t=!0;var e;return!0!==this.bypassEligibilityCheck&&(e=this.context.domain.globalPromptSettings)&&e.referrers&&(e=e.referrers,(e=o.GlobalPromptReferrerConditionsModel.parse(e)).enabled&&(e=yield this._evaluateReferrerConditions(e),this.userReferrerState=e.referrerResponse,t=e.pass)),t||h.Logger.info(`Based on client referrer, prompt, ${this.promptId}, is currently disabled`),t})}_evaluateReferrerConditions(o){return u(this,void 0,void 0,function*(){let t={pass:!0,referrerResponse:d.PromptReferrerCondition.ALLOW},e=this.context.env.referrer;var s=this.context.user.lastReferrerState,i=yield this._evaluateExistingReferrerState(o,s,e),s=!(e=s&&!i.updateRequired?i.referrer:e)||""===e;const n=String(e);var r=!s&&-1!==n.indexOf(this.context.domain.name);return!((t=s?v._evaluateSimpleReferrerCondition(o.when_blank,t):r?v._evaluateSimpleReferrerCondition(o.when_self,t):this._evaluateExternalReferrerConditions(o,t,e)).referrerResponse===d.PromptReferrerCondition.IGNORE)&&i.updateRequired&&(yield l.UserService.setLastReferrerState(this.context.user,n)),t})}_evaluateExistingReferrerState(i,n,r){return u(this,void 0,void 0,function*(){const t={referrer:r,updateRequired:!1};if(n&&n.lastSetAt){const s=new Date;var e=(s.getTime()-n.lastSetAt)/1e3;(i.persist_ttl_seconds||0)<e?(yield l.UserService.clearLastReferrerState(this.context.user),t.updateRequired=!0):t.referrer=n.referrer}return t})}static _evaluateSimpleReferrerCondition(t,e){const s=Object.assign({},e);switch(t){case d.PromptReferrerCondition.IGNORE:s.pass=!1,s.referrerResponse=d.PromptReferrerCondition.IGNORE;break;case d.PromptReferrerCondition.BLOCK:s.pass=!1,s.referrerResponse=d.PromptReferrerCondition.BLOCK}return s}_evaluateExternalReferrerConditions(t,e,s){const i=Object.assign({},e);let n=!0,r=!0,o=!1,c=!1;t.allowed&&(Array.isArray(t.allowed.contains)&&(r=t.allowed.contains.some(t=>-1!==s.indexOf(t))),Array.isArray(t.allowed.exact)&&(n=t.allowed.exact.some(t=>s===t))),t.blocked&&(Array.isArray(t.blocked.contains)&&(c=t.blocked.contains.some(t=>-1!==s.indexOf(t))),Array.isArray(t.blocked.exact)&&(o=t.blocked.exact.some(t=>s===t)));e=n||r,t=o||c;return e&&!t||(i.pass=!1,i.referrerResponse=d.PromptReferrerCondition.BLOCK),i}}e.BasePrompt=v},"./src/sdk/prompts/bell.prompt.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})},n=(Object.defineProperty(e,"__esModule",{value:!0}),e.BellPrompt=void 0,s("./src/sdk/prompts/dom.prompt.ts"));const r=s("./src/sdk/constants.ts"),o=s("./src/sdk/models/events/event.model.ts"),c=s("./src/sdk/enums/event-type.enum.ts"),d=s("./src/sdk/services/logging.service.ts"),u=s("./src/sdk/enums/bell-prompt-display-behavior.enum.ts"),a={"top-left":"d-top-left","top-right":"d-top-right","bottom-right":"d-bottom-right","bottom-left":"d-bottom-left",disabled:"d-disabled"},l={"top-left":"m-top-left","top-right":"m-top-right","bottom-right":"m-bottom-right","bottom-left":"m-bottom-left",disabled:"m-disabled"};let h=null;class v extends n.DomPrompt{_wireEvents(){var t=this._handleFlowLoaded.bind(this),e=this._handleShowPrompt.bind(this),s=this._handleHidePrompt.bind(this),i=this._handleSubscription.bind(this),n=this._handleUnsubscription.bind(this),r=[c.EventType.REGISTRATION_SUBSCRIBED,c.EventType.REGISTRATION_MIGRATED],o=[c.EventType.PERMISSION_DISMISSED,c.EventType.PERMISSION_DENIED];this.watch(c.EventType.FLOW_LOADED,t),this.watch(c.EventType.PROMPT_SHOW,e),this.watch(o,s),this.watch(r,i),this.watch(c.EventType.REGISTRATION_UNSUBSCRIBED,n)}_wireElementEvents(){var t=this._handleButtonMouseOver.bind(this),e=this._handleButtonMouseOut.bind(this),s=this._handleButtonClick.bind(this),i=this._handleWindowResize.bind(this);this.svgBtn.addEventListener("mouseover",t),this.svgBtn.addEventListener("mouseout",e),this.svgBtn.addEventListener("click",s),!0===this.promptConfig.preview_mode&&this.svgBtn.removeEventListener("click",s),this.context.env.scope.addEventListener("resize",i)}attachToDom(e){const s=Object.create(null,{attachToDom:{get:()=>super.attachToDom}});return i(this,void 0,void 0,function*(){var t;yield s.attachToDom.call(this,e),this.parentReady&&(t=yield this._buildTemplate(),this.parent.appendChild(t),this._wireElementEvents())})}run(t={}){const e=Object.create(null,{run:{get:()=>super.run}});return i(this,void 0,void 0,function*(){yield e.run.call(this,t),(yield this._canShow())?(this.dispatch(new o.EventModel(c.EventType.PROMPT_ELIGIBLE,this._buildDispatchEventPack())),yield this._evaluateDisplayBehavior(!!this.bypassEligibilityCheck)):this.dispatch(new o.EventModel(c.EventType.PROMPT_INELIGIBLE,this._buildDispatchEventPack()))})}_attemptToShow(e=!1){return i(this,void 0,void 0,function*(){var t=this.settings.prompt.is_auto_show||e;this._isPlacementEnabled()?(yield this._canShow())&&t&&(yield this._evaluateRunConditions(),yield this._show()):d.Logger.info("Current prompt is not enabled for this placement")})}_show(){const t=Object.create(null,{_show:{get:()=>super._show}});return i(this,void 0,void 0,function*(){yield t._show.call(this)})}_buildTemplate(){return i(this,void 0,void 0,function*(){if(!this.element){const t=["pushly_bell",(yield this.isUserSubscribed)?"subscribed":"not-subscribed",this.promptConfig.managed?"managed":"non-managed",a[this.promptTheme.position.desktop],l[this.promptTheme.position.mobile]];this.element=this._createDivElement({className:t.join(" ")}),this.svgBtn=this._createSvgElement("0 0 512 512"),this.svgBtn.innerHTML=`
<circle fill="${this.promptTheme.primary_color}" cx="256" cy="256" r="255.059" />
<path fill="${this.promptTheme.accent_color}" d="M256,46.349C140.398,46.349,46.349,140.398,46.349,256c0,115.603,94.049,209.651,209.651,209.651
    c115.603,0,209.651-94.049,209.651-209.651C465.651,140.398,371.603,46.349,256,46.349z M256,450.411
    c-107.198,0-194.41-87.213-194.41-194.411c0-107.198,87.212-194.41,194.41-194.41c107.198,0,194.411,87.212,194.411,194.41
    C450.411,363.198,363.198,450.411,256,450.411z" />
<g>
    <path fill="${this.promptTheme.accent_color}" d="M341.024,293.378v-58.851c0-41.452-28.823-76.096-67.492-85.197c-0.235-10.897-9.101-19.647-20.033-19.647
        c-10.941,0-19.847,8.789-20.076,19.647c-38.669,9.101-67.495,43.745-67.495,85.197v58.851c-14.569,0-26.369,11.797-26.369,26.365
        v18.603h227.829v-18.603C367.389,305.175,355.596,293.378,341.024,293.378z" />
    <path fill="${this.promptTheme.accent_color}" d="M253.5,381.699c17.454,0,32.062-11.757,36.661-27.781h-73.376C221.393,369.942,236,381.699,253.5,381.699z" />
</g>
        `.trim(),this.tooltipContainer=this._createDivElement({className:"pushly_bell-tooltip-container"}),this.tooltipContainer.innerHTML=`
<div class="pushly_bell-tooltip pushly_bell-tooltip-subscribed" ${this.promptTheme.tooltip.subscribed?"":'style="display: none;"'}>
    <div class="pushly_bell-tooltip-arrow" style="background-color: ${this.promptTheme.primary_color};"></div>
    <div class="pushly_bell-tooltip-text" style="background-color: ${this.promptTheme.primary_color}; color: ${this.promptTheme.accent_color};">${this.promptTheme.tooltip.subscribed}</div>
</div>
<div class="pushly_bell-tooltip pushly_bell-tooltip-notsubscribed" ${this.promptTheme.tooltip.unsubscribed?"":'style="display: none;"'}>
    <div class="pushly_bell-tooltip-arrow" style="background-color: ${this.promptTheme.primary_color};"></div>
    <div class="pushly_bell-tooltip-text" style="background-color: ${this.promptTheme.primary_color}; color: ${this.promptTheme.accent_color};">${this.promptTheme.tooltip.unsubscribed}</div>
</div>
        `.trim(),this.element.appendChild(this.svgBtn),this.element.appendChild(this.tooltipContainer),this._updateSize()}return this.element})}_updateSize(){let t=this.promptTheme.size;this.context.env.scope.innerWidth<r.MOBILE_MAX_SIZE&&this.promptTheme.mobile_size&&(t=this.promptTheme.mobile_size),this.svgBtn.setAttribute("height",t),this.svgBtn.style.height=t,this.svgBtn.setAttribute("width",t),this.svgBtn.style.width=t}_handleFlowLoaded(){return i(this,void 0,void 0,function*(){yield this.run()})}_handleShowPrompt(){return i(this,void 0,void 0,function*(){this.context.app.loadConfig.manualPromptMode||this.element.classList.contains(r.DEFAULT_CLASSNAME_PROMPT_VISIBLE)||(yield this._evaluateDisplayBehavior(!0))})}_handleHidePrompt(){return i(this,void 0,void 0,function*(){yield this._hide()})}_handleSubscription(){return i(this,void 0,void 0,function*(){return this.element.classList.add("subscribed"),this._evaluateDisplayBehavior()})}_handleUnsubscription(){return i(this,void 0,void 0,function*(){return this.element.classList.remove("subscribed"),this._evaluateDisplayBehavior()})}_evaluateDisplayBehavior(n=!1){return i(this,void 0,void 0,function*(){var t,e,s=yield this.isUserSubscribed,i=this.promptConfig.behavior;i&&(t=i.display_behavior===u.BellPromptDisplayBehavior.PRE_SUBSCRIPTION,e=i.display_behavior===u.BellPromptDisplayBehavior.POST_SUBSCRIPTION,i.display_behavior===u.BellPromptDisplayBehavior.ALWAYS?(d.Logger.info("Bell prompt display mode: always.","User Subscribed: "+(s?"true":"false")),yield this._attemptToShow()):t?(d.Logger.info("Bell prompt display mode: pre-subscription.","User Subscribed: "+(s?"true":"false")),s?yield this._hide():yield this._attemptToShow(n)):e&&(d.Logger.info("Bell prompt display mode: post-subscription.","User Subscribed: "+(s?"true":"false")),s?yield this._attemptToShow(n):yield this._hide()))})}_handleButtonClick(){return i(this,void 0,void 0,function*(){(yield this.isUserSubscribed)||(yield this._allow())})}_handleButtonMouseOver(){return i(this,void 0,void 0,function*(){this.element.classList.add("hover")})}_handleButtonMouseOut(){return i(this,void 0,void 0,function*(){this.element.classList.remove("hover")})}_handleWindowResize(){return i(this,void 0,void 0,function*(){h&&clearTimeout(h),h=setTimeout(()=>{h=null,this._updateSize()},50)})}}e.BellPrompt=v},"./src/sdk/prompts/custom.prompt.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})},n=(Object.defineProperty(e,"__esModule",{value:!0}),e.CustomPrompt=void 0,s("./src/sdk/prompts/dom.prompt.ts"));const r=s("./src/sdk/constants.ts"),o=s("./src/sdk/models/events/event.model.ts"),c=s("./src/sdk/enums/event-type.enum.ts"),d=s("./src/sdk/services/logging.service.ts");class u extends n.DomPrompt{constructor(){super(...arguments),this.allowBtns=[],this.dismissBtns=[]}_wireEvents(){var t=this._handleShowPrompt.bind(this),e=this._handlePermissionGranted.bind(this),s=this._handlePermissionDismissed.bind(this),i=this._handlePermissionDenied.bind(this),n=[c.EventType.REGISTRATION_SUBSCRIBED,c.EventType.REGISTRATION_MIGRATED,c.EventType.PERMISSION_GRANTED,c.EventType.FOLLOWED],r=[c.EventType.PROMPT_DISMISSED,c.EventType.PERMISSION_DISMISSED],o=[c.EventType.PERMISSION_DENIED];this.watch(c.EventType.PROMPT_SHOW,t),this.watch(n,e),this.watch(r,s),this.watch(o,i)}_locateAndAssignElement(){const e=setInterval(()=>i(this,void 0,void 0,function*(){var t=this.parent.getElementsByClassName(r.DEFAULT_CLASSNAME_PROMPT_CUSTOM);t&&0<t.length&&(clearInterval(e),this.element=t[0],this.envSupported?(this._setSupportedClassname(),yield this._setInitialSubscriptionClassname(),this._resolveKeywords(),this._assignButtonElements()):this._setUnsupportedClassname())}),500)}attachToDom(){const t=Object.create(null,{attachToDom:{get:()=>super.attachToDom}});return i(this,void 0,void 0,function*(){yield t.attachToDom.call(this),yield this._locateAndAssignElement()})}runInUnsupportedMode(){return i(this,void 0,void 0,function*(){yield this.attachToDom()})}_run(){return i(this,void 0,void 0,function*(){d.Logger.info("Custom prompt ready"),(yield this._isUserEligibleToPrompt())?(this._setEligibleClassnames(),this.dispatch(new o.EventModel(c.EventType.PROMPT_ELIGIBLE,this._buildDispatchEventPack()))):(this._setIneligibleClassnames(),this.dispatch(new o.EventModel(c.EventType.PROMPT_INELIGIBLE,this._buildDispatchEventPack())))})}_attemptToShow(t=0){return i(this,void 0,void 0,function*(){this.bypassEligibilityCheck&&this._setEligibleClassnames(),(yield this._isUserEligibleToPrompt())?this._setEligibleClassnames():this._setIneligibleClassnames()})}_show(){return i(this,void 0,void 0,function*(){})}_assignButtonElements(){return i(this,void 0,void 0,function*(){var t=this.element.getElementsByClassName(r.DEFAULT_CLASSNAME_PROMPT_BTN_ALLOW),e=this.element.getElementsByClassName(r.DEFAULT_CLASSNAME_PROMPT_BTN_DISMISS);t&&0<t.length?Array.from(t).forEach(t=>{t.addEventListener("click",this._allow.bind(this)),this.allowBtns.push(t)}):d.Logger.warn("Prompt allow button cannot be located"),e&&0<e.length?Array.from(e).forEach(t=>{t.addEventListener("click",this._dismiss.bind(this)),this.dismissBtns.push(t)}):d.Logger.warn("Prompt dismiss button cannot be located"),yield this._run()})}_getConfigClassNames(){const t=this.context.app.classNames||{};return t.webPushUnsupported=t.webPushUnsupported||r.DEFAULT_CLASSNAME_WEB_PUSH_UNSUPPORTED,t.webPushSupported=t.webPushSupported||r.DEFAULT_CLASSNAME_WEB_PUSH_SUPPORTED,t.subscriptionNone=t.subscriptionNone||r.DEFAULT_CLASSNAME_SUBSCRIPTION_NONE,t.subscriptionSubscribed=t.subscriptionSubscribed||r.DEFAULT_CLASSNAME_SUBSCRIPTION_TRUE,t.subscriptionUnsubscribed=t.subscriptionUnsubscribed||r.DEFAULT_CLASSNAME_SUBSCRIPTION_FALSE,t.subscriptionDenied=t.subscriptionDenied||r.DEFAULT_CLASSNAME_SUBSCRIPTION_DENIED,t.subscriptionDismissed=t.subscriptionDismissed||r.DEFAULT_CLASSNAME_SUBSCRIPTION_DISMISSED,t.promptIneligible=t.promptIneligible||r.DEFAULT_CLASSNAME_PROMPT_INELIGIBLE,t.promptEligible=t.promptEligible||r.DEFAULT_CLASSNAME_PROMPT_ELIGIBLE,t}_setInitialSubscriptionClassname(){return i(this,void 0,void 0,function*(){this.context.user.isBlocked()?this._setDeniedClassnames():this.context.user.isDismissed()?this._setDismissedClassnames():(yield this.isUserSubscribed)?this._setSubscribedClassnames():this._setNoSubscriptionClassnames()})}_setPromptCompositeSubscribedClassnames(){this._setIneligibleClassnames(),this._setSubscribedClassnames(),this.element.classList.remove(r.DEFAULT_CLASSNAME_PROMPT_VISIBLE)}_setSubscriptionDismissedClassnames(){this._setIneligibleClassnames(),this._setDismissedClassnames(),this.element.classList.remove(r.DEFAULT_CLASSNAME_PROMPT_VISIBLE)}_setSubscriptionDeniedClassnames(){this._setIneligibleClassnames(),this._setDeniedClassnames(),this.element.classList.remove(r.DEFAULT_CLASSNAME_PROMPT_VISIBLE)}_setUnsupportedClassname(){var t=this._getConfigClassNames();this.element.classList.add(t.webPushUnsupported),this.element.classList.remove(t.webPushSupported)}_setSupportedClassname(){var t=this._getConfigClassNames();this.element.classList.add(t.webPushSupported),this.element.classList.remove(t.webPushUnsupported)}_setEligibleClassnames(){var t=this._getConfigClassNames();this.element.classList.remove(t.promptIneligible),this.element.classList.add(t.promptEligible)}_setIneligibleClassnames(){var t=this._getConfigClassNames();this.element.classList.remove(t.promptEligible),this.element.classList.add(t.promptIneligible)}_setNoSubscriptionClassnames(){var t=this._getConfigClassNames();this.element.classList.add(t.subscriptionNone),this.element.classList.remove(t.subscriptionSubscribed,t.subscriptionDismissed,t.subscriptionDenied,t.subscriptionUnsubscribed)}_setSubscribedClassnames(){var t=this._getConfigClassNames();this.element.classList.add(t.subscriptionSubscribed),this.element.classList.remove(t.subscriptionNone,t.subscriptionDismissed,t.subscriptionDenied,t.subscriptionUnsubscribed)}_setDismissedClassnames(){var t=this._getConfigClassNames();this.element.classList.add(t.subscriptionDismissed),this.element.classList.remove(t.subscriptionNone,t.subscriptionSubscribed,t.subscriptionDenied,t.subscriptionUnsubscribed)}_setDeniedClassnames(){var t=this._getConfigClassNames();this.element.classList.add(t.subscriptionDenied),this.element.classList.remove(t.subscriptionNone,t.subscriptionSubscribed,t.subscriptionDismissed,t.subscriptionUnsubscribed)}_handleShowPrompt(){return i(this,void 0,void 0,function*(){var t;this.context.app.loadConfig.manualPromptMode||(t=yield this._isUserEligibleToPrompt(),!this.element.classList.contains(r.DEFAULT_CLASSNAME_PROMPT_VISIBLE)&&t&&(yield this._attemptToShow(!0)))})}_handlePermissionGranted(){return i(this,void 0,void 0,function*(){this._setPromptCompositeSubscribedClassnames(),yield this._hide()})}_handlePermissionDismissed(){return i(this,void 0,void 0,function*(){this._setSubscriptionDismissedClassnames(),yield this._hide()})}_handlePermissionDenied(){return i(this,void 0,void 0,function*(){this._setSubscriptionDeniedClassnames(),yield this._hide()})}}e.CustomPrompt=u},"./src/sdk/prompts/dom.prompt.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})},n=(Object.defineProperty(e,"__esModule",{value:!0}),e.DomPrompt=void 0,s("./src/sdk/prompts/base.prompt.ts"));const r=s("./src/sdk/constants.ts"),o=s("./src/sdk/models/events/subscriber-streamable-event.model.ts"),c=s("./src/sdk/models/events/event.model.ts"),d=s("./src/sdk/enums/prompt-style.enum.ts"),u=s("./src/sdk/enums/steamable-event-type.enum.ts"),a=s("./src/sdk/enums/event-type.enum.ts"),l=s("./src/sdk/services/user.service.ts"),h=s("./src/sdk/services/logging.service.ts"),v=s("./src/sdk/utils.ts");let p=0;class m extends n.BasePrompt{constructor(t,e,s=!0){super(t,e,s),this.parentReady=!1,this._handlePromptAllowedError=t=>i(this,void 0,void 0,function*(){/prompting has been disabled/i.test(String(t))&&this.dispatch(new c.EventModel(a.EventType.PROMPT_DISABLED,yield this._buildDispatchEventPack(),this.context,this,{message:t}))}),s&&this._wireRenderEvent()}_wireRenderEvent(){var t=this._handleFlowLoadedRender.bind(this);this.watchOnce(a.EventType.FLOW_LOADED,t)}get promptTheme(){return this.promptConfig.theme||{}}attachToDom(e){return i(this,void 0,void 0,function*(){var t;this.element||(t=this.context.env.document.body,this.parent=e||t,this.parent?this.parentReady=!0:p<5?(h.Logger.info(`Prompt parent element, ${String(this.parent)}, could not be resolved. Attempts: `+p),p++,yield(0,v.delay)(100*p*2),yield this.attachToDom(e)):h.Logger.warn(`Prompt parent element, ${String(this.parent)}, unavailable`))})}_canShow(){const e=Object.create(null,{_canShow:{get:()=>super._canShow}});return i(this,void 0,void 0,function*(){var t=yield e._canShow.call(this);return!!this.element&&t})}_show(){return i(this,void 0,void 0,function*(){h.Logger.info(`Showing prompt ${this.promptId}, `+this.name),this._incrementUserPromptCount(),yield this._setLastSeenPromptId(),this._addVisibleClassName();const t=yield this._buildPostEventPack();this._hasKeywords()&&(t.meta.keywords=this.keywords),(yield this.isUserSubscribed)?this.style===d.PromptStyle.Custom&&(this.dispatch(new c.EventModel(a.EventType.FOLLOW_SHOWN,yield this._buildDispatchEventPack())),this.post(new o.SubscriberStreamableEventModel(u.StreamableEventType.FOLLOW_SHOWN,t,this.context))):(this.dispatch(new c.EventModel(a.EventType.PROMPT_SHOWN,yield this._buildDispatchEventPack())),this.post(new o.SubscriberStreamableEventModel(u.StreamableEventType.PROMPT_SHOWN,t,this.context)))})}_hide(){return i(this,void 0,void 0,function*(){this._removeVisibleClassName(),this.dispatch(new c.EventModel(a.EventType.PROMPT_HIDE,yield this._buildDispatchEventPack()))})}_allow(t){return i(this,void 0,void 0,function*(){const t=yield this._buildPostEventPack();this._hasKeywords()&&(t.meta.keywords=this.keywords),(yield this.isUserSubscribed)?this.style===d.PromptStyle.Custom&&(this.dispatch(new c.EventModel(a.EventType.FOLLOWED,this._buildDispatchEventPack())),this.post(new o.SubscriberStreamableEventModel(u.StreamableEventType.FOLLOWED,t,this.context))):(this.dispatch(new c.EventModel(a.EventType.PROMPT_ALLOWED,this._buildDispatchEventPack(),this.context,this)).catch(this._handlePromptAllowedError),this.post(new o.SubscriberStreamableEventModel(u.StreamableEventType.PROMPT_ALLOWED,t,this.context)))})}_dismiss(t){return i(this,void 0,void 0,function*(){this.dispatch(new c.EventModel(a.EventType.PROMPT_DISMISSED,this._buildDispatchEventPack())),this.post(new o.SubscriberStreamableEventModel(u.StreamableEventType.PROMPT_DISMISSED,yield this._buildPostEventPack(),this.context)),yield l.UserService.setPromptDismissed(this.context.user,this),this._hide()})}_addVisibleClassName(){this.element&&this.element.classList.add(r.DEFAULT_CLASSNAME_PROMPT_VISIBLE)}_removeVisibleClassName(){this.element&&this.element.classList.remove(r.DEFAULT_CLASSNAME_PROMPT_VISIBLE)}_resolveKeywords(){try{if(this.element){const e=(this.element.dataset||{}).keywords||"";if(""!==e.trim()){const s=e.toString().split(",");var t=s.map(t=>t.toString().trim());this.keywords=[...Array.from(new Set(t))]}}}catch(t){h.Logger.warn("Could not resolve prompt keywords - "+t.message)}}_hasKeywords(){return!!this.keywords&&Array.isArray(this.keywords)&&0<this.keywords.length}_buildDispatchEventPack(){const e=Object.create(null,{_buildDispatchEventPack:{get:()=>super._buildDispatchEventPack}});return i(this,void 0,void 0,function*(){const t=yield e._buildDispatchEventPack.call(this);return t.keywords=this.keywords||[],t})}_handleFlowLoadedRender(){return i(this,void 0,void 0,function*(){yield this.attachToDom()})}_createDivElement(t={}){return this._createDomElement("div",t)}_createButtonElement(t={}){return this._createDomElement("button",t)}_createImgElement(t){const e=this._createDomElement("img");return t&&(e.src=t),e}_createSvgElement(t){const e=this.context.env.document.createElementNS("http://www.w3.org/2000/svg","svg");return e.setAttribute("viewBox",t),e}_createDomElement(t,e={}){const s=this.context.env.document.createElement(t);return e.className&&s.setAttribute("class",e.className),e.style&&s.setAttribute("style",e.style),e.innerText&&(s.innerText=e.innerText),s}}e.DomPrompt=m},"./src/sdk/prompts/native.prompt.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})},n=(Object.defineProperty(e,"__esModule",{value:!0}),e.NativePrompt=void 0,s("./src/sdk/prompts/base.prompt.ts"));const r=s("./src/sdk/models/events/event.model.ts"),o=s("./src/sdk/enums/exception-message.enum.ts"),c=s("./src/sdk/enums/runtime-environment.enum.ts"),d=s("./src/sdk/enums/event-type.enum.ts"),u=s("./src/sdk/services/logging.service.ts"),a=s("./src/sdk/enums/integration-type.enum.ts"),l=s("./src/sdk/exceptions/fail.exception.ts");class h extends n.BasePrompt{constructor(){super(...arguments),this.shown=!1}_wireEvents(){var t=this._handleFlowLoaded.bind(this),e=this._handleShowPrompt.bind(this);this.watch(d.EventType.FLOW_LOADED,t),this.watch(d.EventType.PROMPT_SHOW,e)}_handleFlowLoaded(){return i(this,void 0,void 0,function*(){yield this.run()})}_handleShowPrompt(){return i(this,void 0,void 0,function*(){this.context.app.loadConfig.manualPromptMode||(yield this._attemptToShow(!0))})}run(t={}){const e=Object.create(null,{run:{get:()=>super.run}});return i(this,void 0,void 0,function*(){this.shown||(yield e.run.call(this,t),this._runMixedIntegrationCheck(),(yield this._canShow())?(this.dispatch(new r.EventModel(d.EventType.PROMPT_ELIGIBLE,this._buildDispatchEventPack())),yield this._attemptToShow(!!t.bypassEligibilityCheck)):this.dispatch(new r.EventModel(d.EventType.PROMPT_INELIGIBLE,this._buildDispatchEventPack())))})}_canShow(){const s=Object.create(null,{_canShow:{get:()=>super._canShow}});return i(this,void 0,void 0,function*(){var t=yield s._canShow.call(this),e=(yield this.context.user.getComputedPushPermission(this.context)).subscription;return t&&!e||u.Logger.debug("Native prompt cannot show due to current subscription state."),t&&!e})}_attemptToShow(e=!1){const s=Object.create(null,{_attemptToShow:{get:()=>super._attemptToShow}});return i(this,void 0,void 0,function*(){var t;yield s._attemptToShow.call(this),this.shown||(t=this.settings.prompt.is_auto_show||e,this._isPlacementEnabled()?(yield this._canShow())&&t&&(yield this._evaluateRunConditions(),(yield this._canShow())&&(yield this._show())):u.Logger.info("Current prompt is not enabled for this placement"))})}_show(){const t=Object.create(null,{_show:{get:()=>super._show}});return i(this,void 0,void 0,function*(){this.shown||(yield t._show.call(this),this.shown=!0,yield this.dispatch(new r.EventModel(d.EventType.PROMPT_ALLOWED,this._buildDispatchEventPack(),this.context,this)))})}_runMixedIntegrationCheck(){var t=this.context.domain.integrationType;if(this.context.env.primaryRuntimeEnvironment===c.RuntimeEnvironment.DIRECT&&t===a.IntegrationType.PROXY)throw this.debugPromptNotShown(this.context,"mixed_integration"),new l.FailException(null,o.ExceptionMessage.MIXED_INTEGRATION)}}e.NativePrompt=h},"./src/sdk/prompts/slide.prompt.ts":function(t,e,s){"use strict";var r=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})},i=(Object.defineProperty(e,"__esModule",{value:!0}),e.SlidePrompt=void 0,s("./src/sdk/prompts/dom.prompt.ts"));const n=s("./src/sdk/constants.ts"),o=s("./src/sdk/models/events/event.model.ts"),c=s("./src/sdk/enums/event-type.enum.ts"),d=s("./src/sdk/services/logging.service.ts"),u={top:"d-top",bottom:"d-bottom",disabled:"d-disabled"},a={top:"m-top",bottom:"m-bottom",disabled:"m-disabled"};class l extends i.DomPrompt{constructor(){super(...arguments),this.shown=!1}get promptImage(){return this.promptTheme.image}_wireEvents(){var t=this._handleFlowLoaded.bind(this),e=this._handlePromptHide.bind(this),s=this._handleShowPrompt.bind(this),i=[c.EventType.PROMPT_ALLOWED,c.EventType.PROMPT_DISMISSED,c.EventType.PERMISSION_DIALOG_SHOWN,c.EventType.PERMISSION_DENIED,c.EventType.REGISTRATION_SUBSCRIBED,c.EventType.REGISTRATION_MIGRATED];this.watch(c.EventType.FLOW_LOADED,t),this.watch(i,e),this.watch(c.EventType.PROMPT_SHOW,s)}_handleFlowLoaded(){return r(this,void 0,void 0,function*(){yield this.run()})}_handlePromptHide(){return r(this,void 0,void 0,function*(){yield this._hide()})}_handleShowPrompt(){return r(this,void 0,void 0,function*(){this.context.app.loadConfig.manualPromptMode||this.element&&!this.element.classList.contains(n.DEFAULT_CLASSNAME_PROMPT_VISIBLE)&&(yield this._attemptToShow(!0))})}_wireElementEvents(){this.allowBtn.addEventListener("click",this._allow.bind(this)),this.dismissBtn.addEventListener("click",this._dismiss.bind(this))}attachToDom(i){const n=Object.create(null,{attachToDom:{get:()=>super.attachToDom}});return r(this,void 0,void 0,function*(){if(yield n.attachToDom.call(this,i),this.parentReady){var t=this._buildTemplate();const e=["pushly_popover","pushly-prompt-window",this.promptTheme.layout||"normal",this.promptConfig.managed?"managed":"non-managed",u[this.promptTheme.position.desktop],a[this.promptTheme.position.mobile]],s=this.element=this._createDivElement({className:e.join(" ")});s.appendChild(t),this.element&&this.parent.appendChild(this.element),this._wireElementEvents()}})}_buildTemplate(){const t=this._createDivElement({className:"pushly_popover-box pushly-prompt-slide",style:"background-color: "+this.promptTheme.background_color}),e=this._createDivElement({className:"pushly_popover-first pushly-prompt-icon"});t.appendChild(e),this.promptImage?(n=this._createImgElement(this.promptImage),e.appendChild(n)):e.style.display="none";const s=this._createDivElement({className:"pushly_popover-second pushly-prompt-content"}),i=(t.appendChild(s),this._createDivElement({className:"pushly_popover-message pushly-prompt-message"}));s.appendChild(i);var n=this._createDivElement({className:"pushly_popover-message-headline pushly-prompt-message-headline",style:"color: "+this.promptTheme.title.text_color,innerText:this.promptTheme.title.text}),n=(i.appendChild(n),this._createDivElement({className:"pushly_popover-message-headline pushly-prompt-message-headline",style:"color: "+this.promptTheme.subtitle.text_color,innerText:this.promptTheme.subtitle.text}));i.appendChild(n);const r=this._createDivElement({className:"pushly_popover-buttons pushly-prompt-actions"});return s.appendChild(r),this.dismissBtn=this._createButtonElement({className:"pushly_popover-buttons-dismiss pushly-prompt-buttons-dismiss",style:`color: ${this.promptTheme.dismiss_button.text_color}; background-color: ${this.promptTheme.dismiss_button.background_color};`,innerText:this.promptTheme.dismiss_button.text}),r.appendChild(this.dismissBtn),this.allowBtn=this._createButtonElement({className:"pushly_popover-buttons-allow pushly-prompt-buttons-allow",style:`color: ${this.promptTheme.allow_button.text_color}; background-color: ${this.promptTheme.allow_button.background_color};`,innerText:this.promptTheme.allow_button.text}),r.appendChild(this.allowBtn),t}run(t={}){const e=Object.create(null,{run:{get:()=>super.run}});return r(this,void 0,void 0,function*(){this.shown||(yield e.run.call(this,t),(yield this._canShow())?(this.dispatch(new o.EventModel(c.EventType.PROMPT_ELIGIBLE,this._buildDispatchEventPack())),yield this._attemptToShow(!!t.bypassEligibilityCheck)):this.dispatch(new o.EventModel(c.EventType.PROMPT_INELIGIBLE,this._buildDispatchEventPack())))})}_attemptToShow(e=!1){const s=Object.create(null,{_attemptToShow:{get:()=>super._attemptToShow}});return r(this,void 0,void 0,function*(){var t;yield s._attemptToShow.call(this),this.shown||(t=this.settings.prompt.is_auto_show||e,this._isPlacementEnabled()?(yield this._canShow())&&t&&(yield this._evaluateRunConditions(),yield this._show()):d.Logger.info("Current prompt is not enabled for this placement"))})}_show(){const t=Object.create(null,{_show:{get:()=>super._show}});return r(this,void 0,void 0,function*(){this.shown||(yield t._show.call(this),this.shown=!0)})}}e.SlidePrompt=l},"./src/sdk/repositories/application.repository.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.ApplicationRepository=void 0;const n=s("./src/sdk/utils.ts"),r=s("./src/sdk/data-providers/cookie.data-provider.ts"),o=s("./src/sdk/services/logging.service.ts"),c=s("./src/sdk/models/application/app.model.ts");e.ApplicationRepository=class{static get(){return i(this,void 0,void 0,function*(){let t=new c.AppModel;return o.Logger.info("Data mode: CDM"),t.isVisibleLoggingEnabled=(0,n.tryParseJSON)(yield r.CookieDataProvider.getmv("_pnvl",!1,"pushly.app_visibleLogs")),this.removeDeprecatedCookies(),t})}static set(t){return i(this,void 0,void 0,function*(){return yield r.CookieDataProvider.set("_pnvl",!0===t.isVisibleLoggingEnabled),this})}static purgeCookies(){return i(this,void 0,void 0,function*(){yield this.removeDeprecatedCookies();for(const t of["_pnvl","_pndbg","_pndbgpr"])(yield r.CookieDataProvider.has(t))&&(yield r.CookieDataProvider.clear(t))})}static removeDeprecatedCookies(){return i(this,void 0,void 0,function*(){for(const t of["pushly.app_env","pushly.app_version","pushly.app_workerVersion","pushly_view_logs"])(yield r.CookieDataProvider.has(t))&&(yield r.CookieDataProvider.clear(t))})}}},"./src/sdk/repositories/domain.repository.ts":function(t,e,s){"use strict";var n=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.DomainRepository=void 0;const r=s("./src/common/data-providers/api.data-provider.ts"),o=s("./src/sdk/constants.ts"),c=s("./src/sdk/models/domains/domain.model.ts"),d=s("./src/sdk/exceptions/domain-load.exception.ts"),u=s("./src/sdk/services/logging.service.ts");class i extends s("./src/sdk/models/events/eventable.model.ts").EventableModel{static get(i){return n(this,void 0,void 0,function*(){var e;const s=new c.DomainModel;Object.assign(s,{}),u.Logger.info("Updating domain cache");try{let t=o.INJECTED_DOMAIN_SETTINGS;(t=!o.DOMAIN_SETTINGS_INJECTION_FAILED.test(t)&&"domain"in t?t:yield r.ApiDataProvider.get(o.SETTINGS_ENDPOINT+"/"+i))&&(e=t.domain,s.id=e.id,s.name=e.name,s.domainKey=i,s.senderId=e.sender_id,s.customAllowDomain=e.custom_allow_domain,s.frequencyCaps=e.frequency_caps,s.globalPromptSettings=e.global_prompt_settings,s.integrationType=e.integration_type,s.whitelistDomains=e.whitelist_domains,s.sdkEventOnlyDomains=e.sdk_event_only_domains,s.apnsConfiguration=e.apns_configuration,s.flags=e.flags||s.flags||[],s.vapidPublicKey=e.vapid_public_key,s.additionalSubscriptionData=e.additional_subscription_data,s.promptGroups=t.prompt_groups,s.prompts=t.prompts)}catch(t){throw u.Logger.warn("Unable to load remote domain settings.",t),this.debugPromptNotShown({domainKey:i},"load_failed"),new d.DomainLoadException(t)}return s})}}e.DomainRepository=i},"./src/sdk/repositories/subscription.repository.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.SubscriptionRepository=void 0;const n=s("./src/_utils/service-worker-registration.ts");class r extends s("./src/sdk/models/events/eventable.model.ts").EventableModel{static unregister(s){return i(this,void 0,void 0,function*(){let e=!0;try{const t=yield(0,n.getPushlyServiceWorkerRegistration)(s);t&&(e=yield t.unregister())}catch(t){e=!1}return e})}}e.SubscriptionRepository=r},"./src/sdk/repositories/user.repository.ts":function(t,e,s){"use strict";var o=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.UserRepository=void 0;const c=s("./src/sdk/constants.ts"),d=s("./src/sdk/data-providers/cookie.data-provider.ts"),u=s("./src/sdk/prompts/base.prompt.ts"),i=s("./src/sdk/utils.ts"),n=s("./src/sdk/models/users/user.model.ts");e.UserRepository=class{static get(){return o(this,void 0,void 0,function*(){let t={};return t.puuid=t.puuid||d.CookieDataProvider.get("pushly.user_puuid"),t.externalId=t.externalId||d.CookieDataProvider.getmv("_pnxd",null,"pushly.user_externalId"),t.doNotTrackFlags=t.doNotTrackFlags||d.CookieDataProvider.getmv("_pndnt",null,"pushly.user_doNotTrackFlags"),t.subscriberState=t.subscriberState||d.CookieDataProvider.getmv("_pnss",null,"pushly.user_subscriberState"),t.domainOfRecord=t.domainOfRecord||d.CookieDataProvider.getmv("_dor",null,"pushly.user_domainOfRecord"),t.lastSeenPromptId=t.lastSeenPromptId||d.CookieDataProvider.getmv("_pnlspid",null,"pushly.user_lastSeenPromptId"),t.profileDocument=t.profileDocument||(0,i.simpleUnHash)(d.CookieDataProvider.getmv("_pnupf",null,"pushly.user_profile")),"subscribed"===t.subscriberState&&(t.token=t.token||d.CookieDataProvider.getmv("_pntx",null,"pushly.user_token")),t.promptFcapSeconds=d.CookieDataProvider.getmv("_pnfcps",null,"pushly.user_promptFcapSeconds"),t.promptCountState=d.CookieDataProvider.getmv("_pnpcs",null,"pushly.user_promptCountState"),this.removeDeprecatedCookies(),n.UserModel.of(t)})}static set(t){return o(this,void 0,void 0,function*(){return d.CookieDataProvider.set("pushly.user_puuid",t.puuid),d.CookieDataProvider.set("_pnxd",t.externalId),d.CookieDataProvider.set("_pndnt",(t.doNotTrackFlags||[]).join(",")),d.CookieDataProvider.set("_pnss",t.subscriberState),d.CookieDataProvider.set("_pnlspid",t.lastSeenPromptId),d.CookieDataProvider.set("_dor",t.domainOfRecord),t.token?d.CookieDataProvider.set("_pntx",t.token):d.CookieDataProvider.clear("_pntx"),this})}static getWithCachePriority(){return o(this,void 0,void 0,function*(){let t={};return t.puuid=d.CookieDataProvider.get("pushly.user_puuid")||t.puuid,t.doNotTrackFlags=d.CookieDataProvider.getmv("_pndnt",null,"pushly.user_doNotTrackFlags")||t.doNotTrackFlags,t.subscriberState=d.CookieDataProvider.getmv("_pnss",null,"pushly.user_subscriberState")||t.subscriberState,t.lastSeenPromptId=d.CookieDataProvider.getmv("_pnlspid",null,"pushly.user_lastSeenPromptId")||t.lastSeenPromptId,t.domainOfRecord=d.CookieDataProvider.getmv("_dor",null,"pushly.user_domainOfRecord")||t.domainOfRecord,t.profileDocument=(0,i.simpleUnHash)(d.CookieDataProvider.getmv("_pnupf",null,"pushly.user_profile"))||t.profileDocument,"subscribed"===t.subscriberState&&(t.token=d.CookieDataProvider.getmv("_pntx",null,"pushly.user_token")||t.token),t.promptFcapSeconds=d.CookieDataProvider.getmv("_pnfcps",null,"pushly.user_promptFcapSeconds"),t.promptCountState=d.CookieDataProvider.getmv("_pnpcs",null,"pushly.user_promptCountState"),n.UserModel.of(t)})}static setPromptState(s,i){return o(this,void 0,void 0,function*(){var{promptFcapSeconds:t,promptCountState:e}=s;return d.CookieDataProvider.setWithRawExpires("_pnfcps",t,i),d.CookieDataProvider.setWithRawExpires("_pnpcs",e,i),this})}static clearPromptState(){return o(this,void 0,void 0,function*(){return d.CookieDataProvider.clear("_pnfcps"),d.CookieDataProvider.clear("_pnpcs"),this})}static setPromptDismissedState(n,r){return o(this,void 0,void 0,function*(){let t=c.PUSHLY_PROMPT_DISMISSED_COOKIE_TIMEOUT,e="d",s={};var i;return"cookie_length_seconds"in(s=r instanceof u.BasePrompt?r.promptConfig.behavior||{}:r.promptBehavior||{})&&(null!=(i=s.cookie_length_seconds)&&(t=i,e="s")),0!==t?(n.subscriberState="dismissed",d.CookieDataProvider.set("_pnpdm",!0,t,e)):n.subscriberState="none",yield this.set(n),self})}static getPromptDismissedState(){return o(this,void 0,void 0,function*(){var t=d.CookieDataProvider.getmv("_pnpdm",!1,"pushly.prompt_dismissed");return"true"===t||!0===t})}static purgeCookies(){this.removeDeprecatedCookies();["pushly.user_puuid","_pndnt","_pnss","_pnlspid","_pnupf","_pntx","_pnfcps","_pnpcs","_pnpdm"].forEach(t=>{d.CookieDataProvider.has(t)&&d.CookieDataProvider.clear(t)})}static removeDeprecatedCookies(){["pushly.user_createdAt","pushly.user_updatedAt","pushly.user_profile","pushly.user_lifetimeViewedKeywordMap","pushly_uqid","pushly_uqid_timestamp","pushly_subscriber_data_updated_at","pushly_do_not_track","pushly_apns_token","pushly_fcm_token","pushly_subscribed"].forEach(t=>{d.CookieDataProvider.has(t)&&d.CookieDataProvider.clear(t)})}}},"./src/sdk/sdk.ts":function(t,e,s){"use strict";var n=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.SDK=void 0;const u=s("./src/sdk/enums/event-type.enum.ts"),r=s("./src/sdk/services/logging.service.ts"),i=s("./src/_utils/validate-only-instance-of-sdk.ts"),o=s("./src/sdk/services/user-debug.service.ts"),c=s("./src/sdk/enums/steamable-event-type.enum.ts"),d=s("./src/sdk/enums/consent.enum.ts"),a=s("./src/sdk/constants.ts"),l=s("./src/sdk/factories/data-provider-factory.ts"),h=s("./src/sdk/exceptions/exit.exception.ts"),v=s("./src/sdk/exceptions/fail.exception.ts"),p=s("./src/sdk/services/flow.service.ts"),m=s("./src/_utils/consent.ts"),f=s("./src/sdk/services/prompt.service.ts"),y=s("./src/sdk/exceptions/pushly.exception.ts"),b=s("./src/sdk/data-providers/cookie.data-provider.ts"),g=s("./src/sdk/services/app.service.ts"),_=s("./src/sdk/enums/runtime-environment.enum.ts"),w=s("./src/sdk/services/user.service.ts"),k=s("./src/sdk/services/domain.service.ts"),P=s("./src/sdk/exceptions/domain-load.exception.ts"),x=s("./src/sdk/cross-frame-messenger/messenger-server.ts"),S=s("./src/sdk/services/registration.service.ts");var O=s("./src/sdk/models/events/eventable.model.ts");const E=s("./src/sdk/models/events/event.model.ts"),j=s("./src/sdk/enums/exception-message.enum.ts"),M=s("./src/sdk/exceptions/invalid-event.exception.ts"),C=s("./src/sdk/services/environment.service.ts"),D=s("./src/sdk/exceptions/worker-registration.exception.ts"),A=s("./src/sdk/utils.ts");class N extends O.EventableModel{constructor(t){super(),this.context=t,this.iid=(0,A.randomString)(),this._swsts_=Date.now(),(this._swclk_=0,i.validateOnlyInstanceOfSdk)(this),this.s(),this.i()}push(i){return n(this,void 0,void 0,function*(){let t=i[0];const e=/^on_/i;try{var s;e.test(t)?(t=t.replace(e,""),this.watch(t,i[1])):(s=new E.EventModel(t,i[1]),yield this.dispatch(s))}catch(t){if(!(t instanceof M.InvalidEventException))throw t;r.Logger.warn(t.message)}})}on(t,e){return n(this,void 0,void 0,function*(){yield this.push(["on_"+t,e])})}trigger(t,e){return n(this,void 0,void 0,function*(){yield this.push([t,e])})}showLogs(t=!0){return n(this,void 0,void 0,function*(){this.context.app.isVisibleLoggingEnabled=!!t,yield g.AppService.saveApp(this.context.app),r.Logger.setVisibleLogsEnabled(t)})}getLogs(){return r.Logger.logs}load(t,e=!1){return n(this,void 0,void 0,function*(){try{yield this.n(t,e)}catch(t){let e=!1;t&&(t instanceof v.FailException||t instanceof P.DomainLoadException||t instanceof D.WorkerRegistrationException?(e=!0,r.Logger.error(this.context,t)):(t instanceof y.PushlyException||t&&t.isPushlyException)&&(e=!0,r.Logger.warn(t.message)),(t instanceof D.WorkerRegistrationException||t instanceof P.DomainLoadException||"object"==typeof t&&"message"in t&&t.message===j.ExceptionMessage.HOST_NOT_WHITELISTED)&&this.dispatch(new E.EventModel(u.EventType.APPLICATION_ERROR,{message:t.message}))),e||(yield this.r(t))}})}requestNotificationPermission(t=0,e){return n(this,void 0,void 0,function*(){if(!this.context.domain.isEventOnlyMode())return S.RegistrationService.performManualRegistrationAttempt(this.context,t,e);r.Logger.warn("Requesting notification permission is not available while in event only mode.")})}n(t,e){return n(this,void 0,void 0,function*(){if(this.context.runtimeEnvironment=t._subRuntimeEnvironmentOverride,this.context.runtimeEnvironment!==_.RuntimeEnvironment.AMP_FRAME_HELPER&&this.context.runtimeEnvironment!==_.RuntimeEnvironment.BROKERED_DATA_SERVER||x.MessengerServer.global.accept(),(0,i.validateOnlyInstanceOfSdk)(this),t.domainKey&&""!==t.domainKey.trim())return this.context.o=t,this.context.domainKey=t.domainKey,this.context.consent=(0,m.buildSdkConsentContext)(t,e),r.Logger.info("Loading: "+this.context.domainKey),this.context.domain=yield k.DomainService.loadDomain(this.context.domainKey),b.CookieDataProvider.domain=this.context.domain,this._runtimeEnvShouldSendSdkImpression(t)&&!g.AppService.inUdrContext()&&this.debug(this.context,c.StreamableEventType.SDK_IMPRESSION),this.context.env=yield C.EnvironmentService.loadEnv(),yield C.EnvironmentService.verifyEnvironmentSupport(t,this.context),yield k.DomainService.verifyEnvironmentSupport(this.context),this.context.domain.hasFlag("FEAT_SDK_RESTRICT_MULTI_SUBS")&&!this.context.domain.isEventOnlyMode()&&C.EnvironmentService.verifyNoSiblingSubscriptions(t,this.context),this.c();throw new h.ExitException(null,j.ExceptionMessage.DOMAIN_KEY_NOT_SPECIFIED)})}c(){return n(this,void 0,void 0,function*(){var e=this.context.o;if(this.context.consent.required&&this.context.consent.status===d.ConsentStatus.UNCONFIRMED)r.Logger.info("Awaiting Consent");else{this.context.app=yield g.AppService.loadApp(e),this.context.env.mode=this.context.app.mode,r.Logger.setVisibleLogsEnabled(this.context.app.isVisibleLoggingEnabled);let t=this.context.app.mode;this.context.domain.isEventOnlyMode()&&(t+=" [event only]"),r.Logger.info("Application Mode: "+t),r.Logger.info("Version: "+a.PUSHLY_APPLICATION_VERSION);try{const i=yield l.DataProviderFactory.getSessionDataProvider(this.context);var s=parseInt((yield i.getCurrentSession()).sessionStart);s<this._swsts_?this._swsts_=s:yield i.set("sessionStart",this._swsts_)}catch(t){}if(this.context.user=yield w.UserService.loadUser(e,this.context),!this.context.user)throw new v.FailException(null,j.ExceptionMessage.USER_UNABLE_TO_LOAD);yield C.EnvironmentService.verifyUdrState(this.context),e.externalId&&this.push(["profile",{external_id:e.externalId}]),o.UserDebugService.shouldShowDebugPanel()&&o.UserDebugService.showDebugPanel(this.context),C.EnvironmentService.configureRuntimeEnvironments(this.context),this.context.app.isLoaded=!0,r.Logger.info("Loaded"),this.dispatch(new E.EventModel(u.EventType.APPLICATION_LOADED)),this.context.user.isInUdr?r.Logger.info("Halting (UDR)"):yield this._loadFlows(e)}})}_loadFlows(s){return n(this,void 0,void 0,function*(){if(s.disableWebFlow)yield this.d();else{const e=p.FlowService.loadFlow(this.context);var t;!s.manualPromptMode&&e.isPromptableFlow&&(yield w.UserService.verifyUserSubscriptionState(this.context),this.context.domain.isEventOnlyMode()||(t={isSafari:this.context.env.isSafari()},f.PromptService.loadPrompts(this.context,t))),yield e.run()}})}_runtimeEnvShouldSendSdkImpression(t){const e=[_.RuntimeEnvironment.AMP_FRAME_HELPER,_.RuntimeEnvironment.AMP_PERMISSION_DIALOG,_.RuntimeEnvironment.PROXY,_.RuntimeEnvironment.PROXY_FRAME_HELPER,_.RuntimeEnvironment.PROXY_PERMISSION_DIALOG,_.RuntimeEnvironment.AMP,_.RuntimeEnvironment.AMP_FRAME_HELPER,_.RuntimeEnvironment.BROKERED_DATA_SERVER];return-1===e.indexOf(t._subRuntimeEnvironmentOverride)}s(){var t,e,s,i,n,r,o,c,d;this.context.app&&this.context.app.isLoaded||(t=this.u.bind(this),e=this.d.bind(this),s=this.a.bind(this),i=this.l.bind(this),n=this.h.bind(this),r=this.v.bind(this),o=this.p.bind(this),c=this.m.bind(this),d=this.f.bind(this),this.watchOnce(u.EventType.CONFIRM_CONSENT,t),this.watchOnce(u.EventType.APPLICATION_LOAD,i),this.watchOnce(u.EventType.AMP_FRAME_HELPER_LOAD,n),this.watchOnce(u.EventType.AMP_PERMISSION_DIALOG_LOAD,r),this.watchOnce(u.EventType.PROXY_PERMISSION_DIALOG_LOAD,o),this.watchOnce(u.EventType.BROKERED_DATA_SERVER_LOAD,d),this.watchOnce(u.EventType.FLOW_LOADED,e),this.watch(u.EventType.REVERT_USER_DELETION,c),this.watch(u.EventType.PROMPT_SHOW,s),w.UserService.wireProfileEvents(this.context))}u(){this.context.app&&this.context.app.isLoaded||this.load(this.context.o,!0)}m(){return n(this,void 0,void 0,function*(){b.CookieDataProvider.has("_pnudr")&&w.UserService.handleUdrRevert()})}l(t){this.load(t)}h(t){t._subRuntimeEnvironmentOverride=_.RuntimeEnvironment.AMP_FRAME_HELPER,r.Logger.setSubApplicationName("amp-helper-frame"),r.Logger.setColor("#7CBE7B"),r.Logger.setBackgroundColor("black"),this.load(t)}v(t){t._subRuntimeEnvironmentOverride=_.RuntimeEnvironment.AMP_PERMISSION_DIALOG,r.Logger.setSubApplicationName("amp-permission-dialog"),this.load(t)}p(t){t._subRuntimeEnvironmentOverride=_.RuntimeEnvironment.PROXY_PERMISSION_DIALOG,r.Logger.setSubApplicationName("proxy-permission-dialog"),this.load(t)}f(t){r.Logger.setSubApplicationName("brokered-data-server"),r.Logger.setColor("#FFC152"),r.Logger.setBackgroundColor("black"),t._subRuntimeEnvironmentOverride=_.RuntimeEnvironment.BROKERED_DATA_SERVER,this.load(t)}a(t){return n(this,void 0,void 0,function*(){this.y(()=>{this.context.domain.isEventOnlyMode()?r.Logger.warn("Manual prompting is not available while in event only mode."):(this.context.app.loadConfig.manualPromptMode||r.Logger.warn("Manual prompt mode is not enabled."),f.PromptService.performManualPromptLoad(this.context,t))},"Delaying 'show_prompt' request.")})}d(){return n(this,void 0,void 0,function*(){r.Logger.info("Ready"),this.context.app.isReady=!0,this.dispatch(new E.EventModel(u.EventType.APPLICATION_READY,this.context))})}y(t,e){this.context.app&&this.context.app.isReady?t():(r.Logger.debug(e||"Delaying request until application is in ready state."),this.watchOnce(u.EventType.APPLICATION_READY,t))}r(e){return n(this,void 0,void 0,function*(){if("object"==typeof e){e.context=Object.assign(Object.assign({},e.context),{sw_error:!1});const t=new RegExp(a.UNCAUGHT_ERROR_BLACKLIST.map(t=>`(${t})`).join("|"),"i");t.test(e.name)||t.test(e.message)?r.Logger.warn(this.context,e):r.Logger.error(this.context,e)}else r.Logger.error(this.context,e)})}i(){return n(this,void 0,void 0,function*(){setInterval(()=>{this._swclk_+=1,this.context.clock=this._swclk_},1e3)})}}e.SDK=N},"./src/sdk/services/app.service.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.AppService=void 0;const n=s("./src/sdk/data-providers/cookie.data-provider.ts"),r=s("./src/sdk/repositories/application.repository.ts"),o=s("./src/sdk/exceptions/exit.exception.ts"),c=s("./src/_utils/global-env.ts");e.AppService=new class{loadApp(e){return i(this,void 0,void 0,function*(){const t=yield r.ApplicationRepository.get();if(t.loadConfig=e,t.loadConfig.classNames=t.loadConfig.classNames||{},t.mode=(t.loadConfig.mode||t.mode||"production").toString().toLowerCase(),["production","development"].includes(t.mode))return yield this.saveApp(t),t.classNames=e.classNames,t;throw new o.ExitException("Invalid sdk mode specified.")})}saveApp(t){return i(this,void 0,void 0,function*(){return yield r.ApplicationRepository.set(t),t})}processUdr(){return i(this,void 0,void 0,function*(){return n.CookieDataProvider.set("_pnudr",1),r.ApplicationRepository.purgeCookies()})}inUdrContext(){return this.udrCookiePresent()||this.udrParamPresent()}udrCookiePresent(){let t=!1;try{t=!!n.CookieDataProvider.get("_pnudr")}catch(t){}return t}udrParamPresent(){var t=(0,c.getLocation)();let e=!1;try{e=/(^|[?&#])(push(ly)?_udr)=1(?=[&#]|$)/i.test(t.search)}catch(t){}return e}}},"./src/sdk/services/domain.service.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.DomainService=void 0;const d=s("./src/_utils/global-env.ts"),n=s("./src/sdk/models/events/event.model.ts"),u=s("./src/sdk/enums/exception-message.enum.ts"),r=s("./src/sdk/enums/event-type.enum.ts"),a=s("./src/sdk/exceptions/exit.exception.ts");var o=s("./src/sdk/models/events/eventable.model.ts");const c=s("./src/sdk/repositories/domain.repository.ts");class l extends o.EventableModel{loadDomain(t){return i(this,void 0,void 0,function*(){return c.DomainRepository.get(t)})}verifyEnvironmentSupport(t){return i(this,void 0,void 0,function*(){if(t.env.isSafari()&&!t.env.isPushManagerInScope()){if(!t.domain.hasApnsConfig())throw this.debugPromptNotShown(t,"apns_not_configured"),this.dispatch(new n.EventModel(r.EventType.WEB_PUSH_NOT_CONFIGURED)),this.dispatch(new n.EventModel(r.EventType.DOMAIN_APNS_NOT_CONFIGURED)),new a.ExitException(null,u.ExceptionMessage.DOMAIN_APNS_NOT_CONFIGURED);if(!t.domain.isApnsConfigEnabled())throw this.debugPromptNotShown(t,"apns_not_enabled"),this.dispatch(new n.EventModel(r.EventType.WEB_PUSH_NOT_CONFIGURED)),this.dispatch(new n.EventModel(r.EventType.DOMAIN_APNS_NOT_ENABLED)),new a.ExitException(null,u.ExceptionMessage.DOMAIN_APNS_NOT_ENABLED);if(!t.domain.getWebsitePushId())throw this.debugPromptNotShown(t,"apns_invalid_config"),this.dispatch(new n.EventModel(r.EventType.WEB_PUSH_NOT_CONFIGURED)),this.dispatch(new n.EventModel(r.EventType.DOMAIN_APNS_INVALID_CONFIG)),new a.ExitException(null,u.ExceptionMessage.DOMAIN_APNS_INVALID_CONFIG)}this.validateHostAvailability(t)})}validateHostAvailability(t){var e=(0,d.getLocation)();let s,i=t.domain.whitelistDomains;if(i=t.env.isSafari()?[i[0]]:i)if(Array.isArray(i)&&0!==i.length){var n=["localhost","127.0.0.1"];const r=e.protocol+"//"+e.hostname,o=e.protocol+"//"+e.host,c=e.href;e=[...i,...n].some(t=>{/^\*/.test(t)&&(t="."+t);const e=new RegExp(`^(http[s]?://)?${t}$`,"i");return e.test(r)||e.test(o)||e.test(c)});s=!e}else s=!1;else s=!1;if(s)throw this.debugPromptNotShown(t,"host_not_whitelisted"),new a.ExitException(null,u.ExceptionMessage.HOST_NOT_WHITELISTED)}}e.DomainService=new l},"./src/sdk/services/environment.service.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.EnvironmentService=void 0;const r=s("./src/sdk/services/logging.service.ts"),n=s("./src/sdk/services/app.service.ts"),o=s("./src/sdk/models/events/subscriber-streamable-event.model.ts"),c=s("./src/sdk/enums/runtime-environment.enum.ts"),d=s("./src/sdk/enums/event-type.enum.ts"),u=s("./src/sdk/services/user.service.ts");var a=s("./src/sdk/models/events/eventable.model.ts");const l=s("./src/sdk/models/events/event.model.ts"),h=s("./src/sdk/enums/exception-message.enum.ts"),v=s("./src/sdk/enums/steamable-event-type.enum.ts"),p=s("./src/sdk/models/application/environment.model.ts"),m=s("./src/sdk/factories/data-provider-factory.ts"),f=s("./src/sdk/exceptions/exit.exception.ts"),y=s("./src/sdk/enums/integration-type.enum.ts");class b extends a.EventableModel{loadEnv(){return i(this,void 0,void 0,function*(){return new p.EnvironmentModel})}verifyNoSiblingSubscriptions(e,t){if(t.env.document.cookie.split(";").map(t=>t.toString().trim().split("=")).find(t=>/^_pnss/.test(t[0])&&!new RegExp(e.domainKey.substr(-8)+"$").test(t[0])&&"subscribed"===t[1]))throw this.debugPromptNotShown(t,"sibling_subscription_detected",t.env.unsupportedReason),this.dispatch(new l.EventModel(d.EventType.EXISTING_SUBSCRIPTION_DETECTED,void 0,e,t.env)),new f.ExitException(null,h.ExceptionMessage.EXISTING_SUBSCRIPTION_DETECTED)}verifyEnvironmentSupport(e,s){return i(this,void 0,void 0,function*(){var t=!!s.env&&(yield s.env.isPushSupported());if(t)return this.dispatch(new l.EventModel(d.EventType.WEB_PUSH_SUPPORTED)),t;throw this.debugPromptNotShown(s,"web_push_unsupported",s.env.unsupportedReason),this.dispatch(new l.EventModel(d.EventType.WEB_PUSH_NOT_SUPPORTED,void 0,e,s.env)),new f.ExitException(null,h.ExceptionMessage.ENV_NOT_SUPPORTED)})}verifyUdrState(e){return i(this,void 0,void 0,function*(){if(n.AppService.inUdrContext()){e.user.isInUdr=!0;try{n.AppService.udrParamPresent()&&!n.AppService.udrCookiePresent()&&(yield this.post(new o.SubscriberStreamableEventModel(v.StreamableEventType.UDR,{},e)),yield n.AppService.processUdr(),yield u.UserService.processUdr(),this.dispatch(new l.EventModel(d.EventType.USER_DELETION_REQUEST)));const t=yield m.DataProviderFactory.getPermissionDataProvider(e);yield t.removeRegistration()}catch(t){"NoResponseException"!==t.name&&r.Logger.warn("Error processing UDR:",t)}}})}configureRuntimeEnvironments(t){const{app:e,domain:s,env:i}=t;if(s.integrationType===y.IntegrationType.DIRECT&&s.customAllowDomain&&!i.isHTTPS()&&!i.isDevMode())i.primaryRuntimeEnvironment=c.RuntimeEnvironment.PROXY;else if(e.loadConfig._subRuntimeEnvironmentOverride){var n=e.loadConfig._subRuntimeEnvironmentOverride;switch(n){case c.RuntimeEnvironment.BROKERED_DATA_SERVER:i.primaryRuntimeEnvironment=c.RuntimeEnvironment.BROKERED_DATA_SERVER;break;case c.RuntimeEnvironment.AMP_FRAME_HELPER||c.RuntimeEnvironment.AMP_PERMISSION_DIALOG:i.primaryRuntimeEnvironment=c.RuntimeEnvironment.AMP,i.subRuntimeEnvironment=n;break;case c.RuntimeEnvironment.PROXY_PERMISSION_DIALOG:i.primaryRuntimeEnvironment=c.RuntimeEnvironment.PROXY,i.subRuntimeEnvironment=n}}i.primaryRuntimeEnvironment||(s.integrationType===y.IntegrationType.PROXY?i.primaryRuntimeEnvironment=c.RuntimeEnvironment.PROXY:i.primaryRuntimeEnvironment=c.RuntimeEnvironment.DIRECT),r.Logger.info("Current runtime environment: "+c.RuntimeEnvironmentName[i.subRuntimeEnvironment||i.primaryRuntimeEnvironment])}}e.EnvironmentService=new b},"./src/sdk/services/flow.service.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.FlowService=e.FlowSvc=void 0;const i=s("./src/sdk/factories/flow.factory.ts");class n{loadFlow(t){return i.FlowFactory.getFlow(t)}}e.FlowSvc=n,e.FlowService=new n},"./src/sdk/services/helpers/apns.service-helpers.ts":function(t,e,s){"use strict";var n=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.ApnsServiceHelpers=void 0;const u=s("./src/sdk/services/logging.service.ts"),a=s("./src/sdk/constants.ts"),r=s("./src/sdk/enums/exception-message.enum.ts"),o=s("./src/sdk/enums/notification-permission-state.enum.ts"),c=s("./src/sdk/exceptions/fail.exception.ts");e.ApnsServiceHelpers=class{static getToken(s){return n(this,void 0,void 0,function*(){let t;var e=yield s.user.getComputedPushPermission(s);return t=e.deviceToken?e.deviceToken:t})}static requestNotificationPermission(s,i){return n(this,void 0,void 0,function*(){const t={permissionState:"default"};var e=s.domain.getWebsitePushId(),e=(u.Logger.info("APNS checking permission for",e),yield s.user.getComputedPushPermission(s));if(t.permissionState=e.permission,t.permissionState===o.NotificationPermissionState.GRANTED)u.Logger.info("APNS permission already granted"),t.token=e.deviceToken;else{e=yield this._checkRemotePermission(s,t,i);if(t.permissionState=e.permission,u.Logger.info("APNS response",e),e.permission===o.NotificationPermissionState.GRANTED&&(t.token=e.deviceToken,!t.token))throw new c.FailException(null,r.ExceptionMessage.APNS_FAILED_TO_GET_GRANTED_TOKEN)}return t})}static _checkRemotePermission(t,e,s){return n(this,void 0,void 0,function*(){if(null!==e&&e.permissionState!==o.NotificationPermissionState.DEFAULT)return e;if(s)try{s()}catch(t){}return this._requestSafariPermissions(t)})}static _requestSafariPermissions(d){return n(this,void 0,void 0,function*(){return new Promise(e=>{u.Logger.info("Setting permission scope");const s=d.env.scope,i=(u.Logger.info("Gathering permission snapshot"),s.safari.pushNotification.permission(d.domain.getWebsitePushId())||{});let n,r=0,o=!1;function c(){clearInterval(n),o=!0}u.Logger.info("Requesting permission"),s.safari.pushNotification.requestPermission(a.APNS_URL,d.domain.getWebsitePushId(),{domain_key:d.domainKey,pushly_unique_user_id:d.user.puuid},t=>{o||(c(),e(t),u.Logger.info(`Native permission response sent [${t.permission}]`))}),n=setInterval(()=>{try{var t;o||(r+=1,t=s.safari.pushNotification.permission(d.domain.getWebsitePushId())||{},600<=r?(clearInterval(n),u.Logger.info(`Fallback permission retry attempts exhausted, [${t.permission}]`)):t.permission!==i.permission&&(c(),e(t),u.Logger.info(`Fallback permission response sent [${t.permission}]`)))}catch(t){u.Logger.warn("sw.apns.error",t)}},500)})})}}},"./src/sdk/services/helpers/user-profile.service-helpers.ts":function(t,e,s){"use strict";var o=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.UserProfileServiceHelpers=void 0;const c=s("./src/sdk/models/events/subscriber-streamable-event.model.ts"),i=s("./src/sdk/enums/steamable-event-type.enum.ts"),d=s("./src/sdk/exceptions/profile.exception.ts");var n=s("./src/sdk/models/events/eventable.model.ts");const u=s("./src/sdk/utils.ts");class r extends n.EventableModel{static saveUserTags(t,e,s=0){return o(this,void 0,void 0,function*(){Array.isArray(e)||(e=[e]),yield this.patchProfile(i.StreamableEventType.PROFILE_UPDATE,t,{tag:e},s)})}static saveUserEvent(t,e){return o(this,void 0,void 0,function*(){yield this.patchProfile(i.StreamableEventType.PROFILE_UPDATE,t,{event:[e]})})}static saveUserProfileData(t,e){return o(this,void 0,void 0,function*(){yield this.patchProfile(i.StreamableEventType.PROFILE_UPDATE,t,{profile:e})})}static appendProfileArrayValue(t,e){return o(this,void 0,void 0,function*(){yield this.patchProfile(i.StreamableEventType.PROFILE_APPEND,t,{profile:e})})}static removeProfileArrayValue(t,e){return o(this,void 0,void 0,function*(){yield this.patchProfile(i.StreamableEventType.PROFILE_REMOVE,t,{profile:e})})}static pageTagVisit(t,e){return o(this,void 0,void 0,function*(){yield this.patchProfile(i.StreamableEventType.PAGE_TAG_VISITS,t,{page_tags:e})})}static viewItem(t,e){return o(this,void 0,void 0,function*(){yield this.patchProfile(i.StreamableEventType.VIEW_ITEM,t,e)})}static saveItem(t,e){return o(this,void 0,void 0,function*(){yield this.patchProfile(i.StreamableEventType.SAVE_ITEM,t,e)})}static addToCart(t,e){return o(this,void 0,void 0,function*(){yield this.patchProfile(i.StreamableEventType.ADD_TO_CART,t,e)})}static updateCartItem(t,e){return o(this,void 0,void 0,function*(){yield this.patchProfile(i.StreamableEventType.UPDATE_CART_ITEM,t,e)})}static purchase(t,e){return o(this,void 0,void 0,function*(){yield this.patchProfile(i.StreamableEventType.PURCHASE,t,e)})}static saveExternalUserId(t,e){return o(this,void 0,void 0,function*(){yield this.patchProfile(i.StreamableEventType.PROFILE_UPDATE,t,{profile:{external_id:e}},0)})}static patchProfile(s,i,n,r=0){return o(this,void 0,void 0,function*(){try{r&&0<r&&(yield(0,u.delayRandom)(r));let t={};n&&n.meta&&(t=n.meta);var e=(yield i.user.getComputedPushPermission(i)).subscription;t.subscription_data=e||void 0,yield this.post(new c.SubscriberStreamableEventModel(s,Object.assign(Object.assign({},n),{meta:t}),i))}catch(t){throw new d.ProfileException(t)}})}}e.UserProfileServiceHelpers=r},"./src/sdk/services/helpers/vapid.service-helpers.ts":function(t,e,s){"use strict";var c=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.VapidServiceHelpers=void 0;const d=s("./src/sdk/services/logging.service.ts"),o=s("./src/common/md5.ts"),u=s("./src/sdk/services/worker.service.ts"),a=s("./src/_utils/service-worker-registration.ts"),r=s("./src/_utils/base-64.ts"),l=s("./src/sdk/data-providers/local-permission.data-provider.ts"),h=s("./src/sdk/enums/exception-message.enum.ts"),i=s("./src/sdk/enums/notification-permission-state.enum.ts"),v=s("./src/sdk/exceptions/fail.exception.ts"),p=s("./src/sdk/utils.ts");e.VapidServiceHelpers=class{static getToken(n){return c(this,void 0,void 0,function*(){let e,s=yield this.getSubscription(n,!1);var t=n.user.isSubscribed(n);if(s&&s.endpoint&&(e=(0,o.MD5)(s.endpoint),n.domain&&n.domain.vapidPublicKey)){var i=n.domain.vapidPublicKey;let t;(t=s.options&&s.options.applicationServerKey?(0,r.arrayBufferToBase64)(s.options.applicationServerKey):t)!==i&&(s=yield this.subscribe(i,n,s),e=(0,o.MD5)(s.endpoint))}i=yield n.user.getLocalPushPermission(n);return e=!e&&t&&"granted"===i.permission&&(t=yield this.handleNotificationPermissionGranted(n,{permissionState:"granted"}))&&t.token?t.token:e})}static getSubscription(e,s=!0){return c(this,void 0,void 0,function*(){let t=null;return(yield(0,a.getPushlyServiceWorkerRegistration)(e))?t=yield(0,a.getPushSubscription)(e):s&&(yield u.WorkerService.registerWorker(e)),t})}static requestNotificationPermission(s,i){return c(this,void 0,void 0,function*(){var t=yield s.user.getLocalPushPermission(s);const e={permissionState:t.permission};return"default"===t.permission&&(i&&i(),d.Logger.debug("Requesting browser notification permission"),e.permissionState=yield Notification.requestPermission()),e})}static handleNotificationPermissionGranted(n,r){return c(this,void 0,void 0,function*(){var t=yield n.user.getLocalPushPermission(n,!0);if(r.permissionState=t.permission,r.permissionState===i.NotificationPermissionState.GRANTED){let t,s,i=1e3;for(let e=0;e<10;e++){try{if(r.subscription=yield this.subscribe(n.domain.vapidPublicKey,n),t=r.subscription?r.subscription.endpoint:t)break}catch(t){e<9?d.Logger.warn(t):s=t}d.Logger.info("Retrying fetch token"),i*=3,yield(0,p.delay)(i)}if(!t)throw new v.FailException(s,h.ExceptionMessage.FAILED_TO_GET_GRANTED_TOKEN);if("string"!=typeof t){const e=new v.FailException(null,h.ExceptionMessage.INVALID_TOKEN_TYPE);throw e.context={token:t},e}r.token=(0,o.MD5)(t)}return r})}static subscribe(t,r,o){return c(this,void 0,void 0,function*(){let e=yield(0,a.getPushlyServiceWorkerRegistration)(r);e=e||(yield u.WorkerService.registerWorker(r));try{yield(0,a.createPushSubscription)(r,e)}catch(t){if(!/unsubscribe then resubscribe/i.test(t.message))throw t;var s;if(o)d.Logger.info("Attempting to unsubscribe previous subscription"),yield o.unsubscribe();else for(s of yield(0,a.getServiceWorkerRegistrations)(r)){const n=yield s.pushManager.getSubscription();yield n.unsubscribe()}d.Logger.info("Resubscribing"),yield(0,a.createPushSubscription)(r,e)}const t=new l.LocalPermissionDataProvider(r);var i=yield t.getPushPermission();return r.user.setPushPermission(i),i.subscription})}}},"./src/sdk/services/logging.service.ts":function(t,e,s){"use strict";var r=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.Logger=void 0;const i=s("./node_modules/error-stack-parser/error-stack-parser.js"),d=s("./src/sdk/constants.ts"),o=s("./src/_utils/global-env.ts"),c=s("./src/sdk/utils.ts"),u=s("./src/sdk/exceptions/pushly.exception.ts"),a=s("./src/sdk/enums/steamable-event-type.enum.ts"),l=s("./src/sdk/models/context.model.ts"),h=["test",d.ENV_NAME_DEV,d.ENV_NAME_LOCAL,d.ENV_NAME_STAGING],v=["test",d.ENV_NAME_LOCAL_PRODUCTION,d.ENV_NAME_PRODUCTION];e.Logger=new class{constructor(){this.logs=[],this.applicationName=d.PUSHLY_SDK_APPLICATION_NAME,this.color=null,this.backgroundColor=null,this.subApplicationName=null,this.plugins=[];var t=(this.visibleLogsEnabled=!1,o.getNavigator)();try{if("plugins"in t)for(var e=0;e<t.plugins.length;e++)this.plugins.push(t.plugins[e].name)}catch(t){this.plugins.push("unable to collect plugin information")}}setVisibleLogsEnabled(t){this.visibleLogsEnabled=t}getComputedApplicationName(){let t=this.applicationName;return t=this.subApplicationName?this.applicationName+"::"+this.subApplicationName:t}print(t,e){var s;if((0,o.getSelf)().console)for(s of Array.isArray(e)?e:[e]){s instanceof Object&&(s=JSON.stringify(s));const i=[`[${this.getComputedApplicationName()}] `+s],n=[];this.color&&n.push("color: "+this.color),this.backgroundColor&&n.push("background-color: "+this.backgroundColor),n&&(i[0]="%c"+i[0],i.push(n.join(";"))),console[t].apply(console,i)}}getBacktrace(e){let s=[];try{let t=(0,i.parse)(e);t.forEach(t=>{s.push({file:t.fileName,line:t.lineNumber,column:t.columnNumber,function:t.functionName})})}catch(e){this.warn(e),s.push({file:"logging.service.ts",line:"1",function:"getBacktrace"})}return s}debug(...t){this.logs=Array.prototype.concat(this.logs,t.map(t=>["debug",t])),!this.visibleLogsEnabled&&-1===h.indexOf(d.ENV_NAME)||this.print("debug",t)}info(...t){this.logs=Array.prototype.concat(this.logs,t.map(t=>["info",t])),!this.visibleLogsEnabled&&-1===h.indexOf(d.ENV_NAME)||this.print("log",t)}warn(...t){this.logs=Array.prototype.concat(this.logs,t.map(t=>["warn",t])),!this.visibleLogsEnabled&&-1===h.indexOf(d.ENV_NAME)||this.print("warn",t)}error(...n){let r;if(n[0]instanceof l.ContextModel&&(r=n.shift()),this.logs=Array.prototype.concat(this.logs,n.map(t=>["error",t])),!this.visibleLogsEnabled&&-1===h.indexOf(d.ENV_NAME)||this.print("error",n),r&&0<n.length){let t=0,s=[],e=(this.logs.forEach(t=>{var e=t[0],t=t[1]instanceof Error?t[1].message:t[1];s.push([e,t])}),1<n.length&&-1===(t=n.findIndex(t=>t instanceof Error))&&(t=0),n.splice(t,1)),i=(e&&0<e.length?e=e[0]:(e=new Error("Cannot resolve error from logs")).code="sw/cannot-resolve-error-from-logs",e instanceof Error?e:new Error(e));if(i instanceof Error){let t=!1;const c={error_type:i.name,error_message:i.message,backtrace:this.getBacktrace(i),logs:Array.from(s).splice(s.length-15,15),plugins:this.plugins};i instanceof u.PushlyException&&(t=i.shouldSuppress(),"originError"in i&&i.originError instanceof Error&&(c.error_message!=i.originError.message&&(c.error_message=c.error_message+"; "+i.originError.message),c.backtrace=this.getBacktrace(i.originError)));var{context:n,code:o}=i;o&&(c.error_code=o),c.context={suppressed:t||!1,originError:i.originError||null};try{c.context=Object.assign(Object.assign({},c.context),n)}catch(t){}let e=!1;r.domain&&r.domain.hasFlag("SDK_DEBUG_EVENTS")&&(e=!0),t&&!e||this.streamError(r,c)}}}streamError(i,n){return r(this,void 0,void 0,function*(){var t=i.domain||{},e=i.user||{},s=(n=Object.assign(Object.assign({},n),{sdk_version:2,source:{application:this.applicationName,version:d.PUSHLY_APPLICATION_VERSION},page_url:i.env.location.toString(),pushly_unique_user_id:e.puuid}),"safari"in(0,o.getSelf)()?"apns_token":"fcm_subscription_id"),s=(n[s]=e.token,{action:a.StreamableEventType.ERROR,domain_id:t.id,domain_key:i.domainKey,event_date:(new Date).toISOString(),meta:n});-1!==v.indexOf(d.ENV_NAME)?(0,c.retryFetch)(d.EVENTS_ENDPOINT,{headers:{"content-type":"text/plain"},method:"POST",body:JSON.stringify(s)},()=>{}):console.log(s)})}setSubApplicationName(t){this.subApplicationName=t}setColor(t){this.color=t}setBackgroundColor(t){this.backgroundColor=t}}},"./src/sdk/services/prompt.service.ts":function(t,e,s){"use strict";var n=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.PromptService=void 0;const r=s("./src/sdk/constants.ts"),o=s("./src/sdk/services/logging.service.ts"),c=s("./src/_utils/global-env.ts"),i=s("./src/sdk/enums/prompt-style.enum.ts"),d=s("./src/sdk/prompts/native.prompt.ts"),u=s("./src/sdk/enums/event-type.enum.ts");var a=s("./src/sdk/models/events/eventable.model.ts");const l=s("./src/sdk/models/events/event.model.ts"),h=s("./src/sdk/prompts/dom.prompt.ts"),v=s("./src/sdk/prompts/custom.prompt.ts"),p=s("./src/sdk/factories/prompt.factory.ts"),m=s("./src/sdk/prompts/bell.prompt.ts"),f=s("./src/sdk/prompts/slide.prompt.ts");class y extends a.EventableModel{constructor(){super(),this.b=[],this.g={},this._wireEvents()}_wireEvents(){var t=this._handleWebPushNotSupported.bind(this);this.watch(u.EventType.WEB_PUSH_NOT_SUPPORTED,t)}_handleWebPushNotSupported(t,e,s){this.setCustomPromptUnsupportedClassname(e,s)}performManualPromptLoad(s,i){return n(this,void 0,void 0,function*(){let t;var e;(i=i||{}).id?t=this.g[i.id]:0<this.b.length&&(t=this.b[0])&&o.Logger.warn(`No prompt ID specified - using already loaded prompt ${t.promptId}.`),t?(o.Logger.warn(`Prompt, ${t.promptId}, is already running.`),t.bypassEligibilityCheck=void 0===i.checkEligibility||!i.checkEligibility,t.hasOwnProperty("shown")&&!t.shown&&t.run({bypassEligibilityCheck:t.bypassEligibilityCheck})):(i.id?t=this.getPromptById(s,i.id):(e=this.loadPrompts(s,{isSafari:s.env.isSafari()}),0<length&&(t=e[0])),t&&(t instanceof h.DomPrompt&&(yield t.attachToDom()),yield t.run({bypassEligibilityCheck:void 0===i.checkEligibility||!i.checkEligibility})))})}loadPrompts(t,e={}){const s=p.PromptFactory.getPrompts(t,e);return s.forEach(t=>{this._cachePrompt(t.promptId,t)}),s&&0===length&&this.dispatch(new l.EventModel(u.EventType.NO_ELIGIBLE_PROMPTS)),s}setCustomPromptUnsupportedClassname(t,e){return n(this,void 0,void 0,function*(){(yield this._locateCustomPrompt())&&this._loadUnsupportedCustomPrompt(t,e)})}getPromptById(t,e){const s={};let i;if(s.prompt=t.domain.prompts.find(t=>t.id.toString()===e.toString()),s.prompt&&(s.group=t.domain.promptGroups.find(t=>t.id.toString()===s.prompt.prompt_group_id.toString())),s.group){const n=this._selectPromptClass(s.prompt.style);i=new n(t,s)}return i}_selectPromptClass(t){return{[i.PromptStyle.Native]:d.NativePrompt,[i.PromptStyle.Slide]:f.SlidePrompt,[i.PromptStyle.Bell]:m.BellPrompt,[i.PromptStyle.Custom]:v.CustomPrompt}[t]}_cachePrompt(t,e){this.b.push(e),this.g[t]=e}_locateCustomPrompt(){return n(this,void 0,void 0,function*(){let n=0;return new Promise((s,t)=>{const i=setInterval(()=>{20<=n&&(clearInterval(i),s(!1)),n++;const t=(0,c.getDocument)();var e;t.getElementsByClassName&&(e=t.getElementsByClassName(r.DEFAULT_CLASSNAME_PROMPT_CUSTOM))&&0<e.length&&(clearInterval(i),s(!0))},500)})})}_loadUnsupportedCustomPrompt(t,e){t={app:{loadConfig:t},user:{env:e}};const s=new v.CustomPrompt(t,{},!1);s.runInUnsupportedMode()}}e.PromptService=new y},"./src/sdk/services/registration.service.ts":function(t,e,s){"use strict";var a=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.RegistrationService=void 0;const l=s("./src/sdk/constants.ts"),o=s("./src/sdk/services/helpers/apns.service-helpers.ts"),c=s("./src/sdk/services/helpers/vapid.service-helpers.ts"),h=s("./src/sdk/services/logging.service.ts"),d=s("./src/sdk/services/user.service.ts"),n=s("./src/sdk/services/worker.service.ts"),v=s("./src/sdk/utils.ts"),p=s("./src/sdk/models/events/subscriber-streamable-event.model.ts"),u=s("./src/sdk/models/events/event.model.ts"),m=s("./src/sdk/data-providers/cookie.data-provider.ts"),f=s("./src/sdk/enums/runtime-environment.enum.ts"),y=s("./src/sdk/repositories/user.repository.ts"),b=s("./src/sdk/enums/steamable-event-type.enum.ts"),i=s("./src/sdk/prompts/dom.prompt.ts"),g=s("./src/sdk/enums/event-type.enum.ts");var r=s("./src/sdk/models/events/eventable.model.ts");const _=s("./src/sdk/prompts/base.prompt.ts");class w extends r.EventableModel{constructor(){super(),this._wireEvents()}_wireEvents(){var t=this._handlePromptAllowed.bind(this),e=this._handlePromptDisabled.bind(this);this.watch(g.EventType.PROMPT_ALLOWED,t),this.watch(g.EventType.PROMPT_DISABLED,e)}_handlePromptAllowed(t,e,s){return a(this,void 0,void 0,function*(){if(!e.domain.isEventOnlyMode())return this._tryRegistration(e,s);h.Logger.warn("Prompt events are suppressed while in event only mode")})}_handlePromptDisabled(t,e,s){return a(this,void 0,void 0,function*(){var t;e.domain.isEventOnlyMode()?h.Logger.warn("Prompt events are suppressed while in event only mode"):(t=this._getPromptRegistrationData(e,s),this._handlePermissionDenied(e,t))})}tryMigration(n,r=!0){return a(this,void 0,void 0,function*(){if(n.domain.isEventOnlyMode())h.Logger.warn("Cannot try migration while in event only mode");else{let t;var e,s,i;(t=n.env.isPushManagerInScope()?yield c.VapidServiceHelpers.getToken(n):yield o.ApnsServiceHelpers.getToken(n))&&t!==n.user.token&&(h.Logger.info("Subscription token refreshed by the remote end. Migrating subscription."),"granted"===(i=yield n.user.getLocalPushPermission(n)).permission&&(n.env.primaryRuntimeEnvironment===f.RuntimeEnvironment.PROXY||(yield n.user.isUnsubscribed(n)))||(e=yield n.user.isSubscribed(n),s=n.user.token,n.user.token=t,yield y.UserRepository.set(n.user),i=this._sendSubscriptionToRemote(n,{subscription_data:i.subscription||void 0,token:t,previous_token:s,external_id:n.user.externalId,domain_key:n.domain.domainKey,amp:n.env.primaryRuntimeEnvironment===f.RuntimeEnvironment.AMP,migrated:!0,pushly_subscriber_data_present:e}),r&&(yield i),this.dispatch(new u.EventModel(g.EventType.REGISTRATION_MIGRATED,t))))}})}_shouldOpenProxyRegistrationWindow(t){return!t.domain.isEventOnlyMode()&&t.env.primaryRuntimeEnvironment===f.RuntimeEnvironment.PROXY&&t.env.subRuntimeEnvironment!==f.RuntimeEnvironment.PROXY_PERMISSION_DIALOG}_tryRegistration(e,s){return a(this,void 0,void 0,function*(){var t;{if(!e.domain.isEventOnlyMode())return t=this._getPromptRegistrationData(e,s),this._shouldOpenProxyRegistrationWindow(e)?this._openProxyRegistrationWindow(e,t):this._register(e,t);h.Logger.warn("Cannot try registration while in event only mode")}})}performManualRegistrationAttempt(e,s,i){return a(this,void 0,void 0,function*(){var t;{if(!e.domain.isEventOnlyMode())return yield n.WorkerService.registerWorker(e),t=this._getPromptRegistrationData(e,{promptId:s,promptKeywords:i}),this._shouldOpenProxyRegistrationWindow(e)?this._openProxyRegistrationWindow(e,t):this._register(e,t);h.Logger.warn("Cannot perform manual registration attempt while in event only mode")}})}unsubscribe(i,n="blocked"){return a(this,void 0,void 0,function*(){if(i.domain.isEventOnlyMode())h.Logger.warn("Cannot perform unsubscribe request while in event only mode");else{const e=this._buildPromptPermissionEventPack(),s=yield i.user.getLocalPushPermission(i);var t=yield i.user.isSubscribed(i);s.subscription&&t&&i.env.isPushManagerInScope()&&i.env.primaryRuntimeEnvironment!==f.RuntimeEnvironment.PROXY&&(h.Logger.info("Processing subscription unsubscribe request"),e.meta=Object.assign(Object.assign({},e.meta),{subscription_data:s.subscription}),yield s.subscription.unsubscribe(),i.user.setPushPermission(s)),t&&(yield d.UserService.setSubscriptionState(i.user,n),this.post(new p.SubscriberStreamableEventModel(b.StreamableEventType.MANUAL_UNSUBSCRIBED,e,i)),this.dispatch(new u.EventModel(g.EventType.REGISTRATION_UNSUBSCRIBED,this._buildClientFeedbackEventPack())),h.Logger.info("User has been unsubscribed from notifications"))}})}_register(i,n){return a(this,void 0,void 0,function*(){if(i.domain.isEventOnlyMode())h.Logger.warn("Cannot perform registration while in event only mode");else{let t;var e=this._handlePermissionPrompted.bind(this,i,n);const{env:s}=i["user"];"granted"===(t=s.isPushManagerInScope()?yield c.VapidServiceHelpers.requestNotificationPermission(i,e):yield o.ApnsServiceHelpers.requestNotificationPermission(i,e)).permissionState?(yield this._handlePermissionGranted(i,n),i.domain.shouldUseVapid()&&(t=yield c.VapidServiceHelpers.handleNotificationPermissionGranted(i,t)),yield this._handleSubscriptionSuccess(i,t,n)):"default"===t.permissionState?this._handlePermissionDismissed(i,n):"denied"===t.permissionState?this._handlePermissionDenied(i,n):h.Logger.warn("Unknown")}})}_sendSubscriptionToRemote(s,i){return a(this,void 0,void 0,function*(){if(s.domain.isEventOnlyMode())h.Logger.warn("Cannot send subscription data while in event only mode");else if(s.user.subscriptionRegistered)h.Logger.warn(s,"Attempt to register subscription token more than once detected");else{const e={meta:Object.assign({},i)};var t=this.gatherAdditionalSubData(s),t=(t&&(e.meta.page_meta_properties=t),i.previous_token?e.meta.migrated=!0:e.meta.subscribed_referrer=(s.user.lastReferrerState||{}).referrer,new p.SubscriberStreamableEventModel(b.StreamableEventType.SUBSCRIBED,e,s));yield this.post(t,l.ALLOW_ENDPOINT),s.user.subscriptionRegistered=!0,yield y.UserRepository.set(s.user)}})}gatherAdditionalSubData(n){try{var t=n["domain"];const r={};if(Array.isArray(t.additionalSubscriptionData)){const e=t.additionalSubscriptionData;e.forEach(t=>{try{var e=t.profile_property;const i=t.selectors;if(e&&Array.isArray(i)){let s;i.some(t=>{var e=t.selector,t=t.value;return e&&t&&(e=n.env.document.head.querySelector(`[${e}~='${t}'][content]`),s=(e||{}).content),!!s}),s&&(r[e]=s)}}catch(t){}})}if(0<Object.keys(r).length)return r}catch(t){}}_handlePermissionPrompted(t,e){t.domain.isEventOnlyMode()?h.Logger.warn("Permission events are suppressed while in event only mode"):(this.post(new p.SubscriberStreamableEventModel(b.StreamableEventType.PERMISSION_PROMPTED,Object.assign({},e.streamPack),t)),this.dispatch(new u.EventModel(g.EventType.LEGACY_PERMISSION_DIALOG_SHOWN)),this.dispatch(new u.EventModel(g.EventType.PERMISSION_DIALOG_SHOWN,e.clientPack)))}_handlePermissionGranted(t,e){return a(this,void 0,void 0,function*(){t.domain.isEventOnlyMode()?h.Logger.warn("Permission events are suppressed while in event only mode"):(this.post(new p.SubscriberStreamableEventModel(b.StreamableEventType.PERMISSION_ACCEPTED,Object.assign({},e.streamPack),t)),this.dispatch(new u.EventModel(g.EventType.LEGACY_PERMISSION_GRANTED)),this.dispatch(new u.EventModel(g.EventType.PERMISSION_GRANTED,e.clientPack)))})}_handleSubscriptionSuccess(r,o,c){return a(this,void 0,void 0,function*(){if(r.domain.isEventOnlyMode())h.Logger.warn("Permission events are suppressed while in event only mode");else{h.Logger.info("Got token: "+o.token);const i=r["domain"];r.user.token=o.token;var e=r.env.isPushManagerInScope()?"fcm_subscription_id":"apns_token",s=r.env.getQueryString();let t=r.env.location.href;l.PUSHLY_SUBSCRIBED_URL_QS in s&&(t=decodeURIComponent(s[l.PUSHLY_SUBSCRIBED_URL_QS]));const n={[e]:i.shouldUseVapid()?void 0:o.token,subscription_data:o.subscription||void 0,external_id:r.user.externalId,subscribed_url:t,prompt_id:c.promptId,domain_key:r.domain.domainKey,amp:r.env.primaryRuntimeEnvironment===f.RuntimeEnvironment.AMP};c.promptId&&c.promptKeywords&&(n.tag=c.promptKeywords,n.keywords=c.promptKeywords),yield this._sendSubscriptionToRemote(r,n),d.UserService.setSubscriptionState(r.user,"subscribed",o.token),m.CookieDataProvider.set("_pnpds",window.location.hostname),this.post(new p.SubscriberStreamableEventModel(b.StreamableEventType.PAGE_VIEW,{meta:{subscription_data:o.subscription}},r)),this.dispatch(new u.EventModel(g.EventType.REGISTRATION_SUBSCRIBED,o.token))}})}_handlePermissionDismissed(t,e){t.domain.isEventOnlyMode()?h.Logger.warn("Permission events are suppressed while in event only mode"):(this.post(new p.SubscriberStreamableEventModel(b.StreamableEventType.PERMISSION_DISMISSED,Object.assign({},e.streamPack),t)),d.UserService.setSubscriptionState(t.user,"dismissed",null,e),this.dispatch(new u.EventModel(g.EventType.PERMISSION_DISMISSED,e.clientPack)))}_handlePermissionDenied(t,e){t.domain.isEventOnlyMode()?h.Logger.warn("Permission events are suppressed while in event only mode"):(this.post(new p.SubscriberStreamableEventModel(b.StreamableEventType.PERMISSION_DENIED,Object.assign({},e.streamPack),t)),d.UserService.setSubscriptionState(t.user,"blocked",null,e),this.dispatch(new u.EventModel(g.EventType.PERMISSION_DENIED,e.clientPack)))}_getPromptRegistrationData(t,e){const s={};t=t.env.getQueryString();return e instanceof _.BasePrompt?(s.promptId=e?e.promptId:void 0,s.promptBehavior=e?e.promptConfig.behavior:void 0,e&&e instanceof i.DomPrompt&&(s.promptKeywords=e.keywords)):(s.promptId=(e||{}).promptId,s.promptKeywords=(e||{}).promptKeywords),l.PUSHLY_PROMPT_ID_QS in t&&(s.promptId=(0,v.tryParseInt)(t[l.PUSHLY_PROMPT_ID_QS])),s.streamPack=this._buildPromptPermissionEventPack(s.promptId,s.promptKeywords),s.clientPack=this._buildClientFeedbackEventPack(s.promptId,s.promptKeywords),s}_openProxyRegistrationWindow(d,u){return a(this,void 0,void 0,function*(){if(d.domain.isEventOnlyMode())h.Logger.warn("Cannot open proxy registration window while in event only mode");else{const s=d.env.document;var t=d.domain.customAllowDomain;const i=s.createElement("a");var e,t=`https://${t}/`+d.domain.domainKey;i.href=t;const n=(0,v.parseQueryString)(i.search),r=(n[l.PUSHLY_SUBSCRIBED_URL_QS]=encodeURIComponent(d.env.location.toString()),n[l.PUSHLY_UNIQUE_USER_ID_QS]=d.user.puuid,n[l.PUSHLY_DOMAIN_KEY_QS]=d.domain.domainKey,n[l.PUSHLY_PROMPT_ID_QS]=u.promptId,[]);for(e in n)r.push(e+"="+n[e]);t=`${i.protocol}//${i.host}${i.pathname}?`+r.join("&");const o=d.env.scope.open(t,"Push Notification Registration","directories=0,toolbar=0,status=0,menubar=0,width=680,height=550");if(o){this.post(new p.SubscriberStreamableEventModel(b.StreamableEventType.PROXY_WINDOW_OPENED,{meta:{promptId:u.promptId}},d));const c=d.env.scope.setInterval(()=>{o.closed&&(clearInterval(c),this.post(new p.SubscriberStreamableEventModel(b.StreamableEventType.PROXY_WINDOW_CLOSED,{meta:{promptId:u.promptId}},d)))},1e3)}else this.post(new p.SubscriberStreamableEventModel(b.StreamableEventType.PROXY_WINDOW_BLOCKED,{meta:{promptId:u.promptId}},d))}})}_buildPromptPermissionEventPack(t=null,e){const s={meta:{promptId:t}};return t&&e&&(s.meta.keywords=e),s}_buildClientFeedbackEventPack(t=null,e=[]){return{prompt:{id:t,keywords:e}}}}e.RegistrationService=new w},"./src/sdk/services/user-debug.service.ts":function(t,e,s){"use strict";var i=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.UserDebugService=void 0;const _=s("./src/sdk/services/logging.service.ts"),n=s("./src/_utils/global-env.ts");e.UserDebugService=class{static shouldShowDebugPanel(){var t=(0,n.getLocation)();let e=!1;try{e="search"in t&&/(^|[?&#])((pushly_debug73485)|(push(ly)?_debug))=1(?=[&#]|$)/i.test(t.search)}catch(t){}return e}static showDebugPanel(g){return i(this,void 0,void 0,function*(){g.domain;const e=g.user,s=g.env;try{const c=s.document,d=c.createElement("style");c.head.appendChild(d),d.innerHTML=`
.sw-user-debug-drawer-wrapper {
  display: block !important;
  box-sizing: border-box;
  position: absolute;
  z-index: 7777;
  bottom: 120px;
  left: -320px;
  width: 320px;
  border: 1px solid #d9d9d9;
  border-left: none;
  box-shadow: 0 1px 4px #e9e9e9;
  background: #f5f5f7;
  transition: left .24s linear;
}
.sw-user-debug-drawer-wrapper.open {
  left: 0;
}

.sw-user-debug-drawer-wrapper .sw-user-debug-shadow {
  visibility: hidden;
  border: none;
  box-shadow: none;
  outline: none;
  position: absolute;
  z-index: -1;
}

.sw-user-debug-drawer-wrapper .sw-user-debug-shadow.copying {
  visibility: visible;
}

.sw-user-debug-drawer-wrapper .sw-user-debug-drawer .sw-user-debug-drawer-handle {
  cursor: pointer;
  display: block;
  box-sizing: border-box;
  position: absolute;
  background: #0077a0;
  border-radius: 0 0 12px 12px;
  border: 1px solid #888;
  border-top: none;
  top: 50%;
  transform: translateY(-50%) rotate(-90deg);
  padding: 8px 38px 8px 38px;
  right: -90px;
  box-shadow: 0 1px 3px #e9e9e9;
  color: #fff;
  font-family: arial;
  font-size: 13px;
}

.sw-user-debug-drawer-wrapper .sw-user-debug-drawer .sw-user-debug-drawer-content {
  color: #545454;
  font-family: arial;
  font-size: 13px;
  padding: 14px;
}

.sw-user-debug-drawer-wrapper .sw-user-debug-drawer .sw-user-debug-drawer-content .sw-user-debug-label {
  color: #949494;
  display: block;
  box-sizing: border-box;
  margin-bottom: 4px;
}
.sw-user-debug-drawer-wrapper .sw-user-debug-drawer .sw-user-debug-drawer-content .sw-user-debug-value {
  display: block;
  word-break: break-all;
}

.sw-user-debug-drawer-wrapper .sw-user-debug-drawer .sw-user-debug-drawer-content .sw-user-debug-puuid {
  border-bottom: 1px solid #d9d9d9;
  padding: 0 12px 6px;
}

.sw-user-debug-drawer-wrapper .sw-user-debug-drawer .sw-user-debug-drawer-content .sw-user-debug-substate {
  border-bottom: 1px solid #d9d9d9;
  padding: 6px 12px;
}

.sw-user-debug-drawer-wrapper .sw-user-debug-drawer .sw-user-debug-drawer-content .sw-user-debug-token {
  padding: 6px 12px 0;
}

.sw-user-debug-drawer-wrapper .sw-user-debug-drawer .sw-user-debug-drawer-content .sw-user-debug-action-wrapper {
  text-align: right;
}

.sw-user-debug-drawer-wrapper .sw-user-debug-drawer .sw-user-debug-drawer-content .sw-user-debug-copy-btn {
  display: inline-block;
  margin: 12px 12px 0;
  padding: 4px 14px;
  background: #0077a0;
  border-radius: 3px;
  color: #fff;
  transition: all .24s;
  cursor: pointer;
}
.sw-user-debug-drawer-wrapper .sw-user-debug-drawer .sw-user-debug-drawer-content .sw-user-debug-copy-btn.success {
  background: green;
}
`.trim();var i,n=e.puuid,r=e.subscriberState.toString().replace(/(^.)/,t=>t.toUpperCase()),o="subscribed"===e.subscriberState?e.token:"N/A";let t="Unable to Resolve";try{s.isPushManagerInScope()?(i=(yield g.user.getComputedPushPermission(g)).subscription)&&(t=i.endpoint):t="N/A"}catch(t){}const u=c.createElement("div"),a=(u.classList.add("sw-user-debug-drawer-wrapper"),u.setAttribute("style","display:none;"),c.createElement("div")),l=(u.appendChild(a),a.classList.add("sw-user-debug-drawer"),c.createElement("div")),h=(a.appendChild(l),l.classList.add("sw-user-debug-drawer-handle"),l.onclick=()=>{u.classList.contains("open")?u.classList.remove("open"):u.classList.add("open")},l.innerHTML=`
<span class="sw-user-debug-label">
    Push SDK
</span>
`.trim(),c.createElement("div")),v=(a.appendChild(h),h.classList.add("sw-user-debug-drawer-content"),c.createElement("div")),p=(h.appendChild(v),v.classList.add("sw-user-debug-puuid"),v.innerHTML=`
<span class="sw-user-debug-label">
    Push User ID
</span>
<span class="sw-user-debug-value">
    ${n}
</span>
`.trim(),c.createElement("div")),m=(h.appendChild(p),p.classList.add("sw-user-debug-substate"),p.innerHTML=`
<span class="sw-user-debug-label">
    Subscriber State
</span>
<span class="sw-user-debug-value">
    ${r}
</span>
`.trim(),c.createElement("div")),f=(h.appendChild(m),m.classList.add("sw-user-debug-token"),m.innerHTML=`
<span class="sw-user-debug-label">
    Subscriber Token
</span>
<span class="sw-user-debug-value">
    ${o}
</span>
`.trim(),c.createElement("input")),y=(u.appendChild(f),f.classList.add("sw-user-debug-shadow"),f.type="textarea",f.defaultValue=`
Push User ID: ${n}, \r

Subscriber State: ${r}, \r

Token: ${o}, \r

Endpoint: ${t}, \r

Browser Permissions: ${(yield g.user.getComputedPushPermission(g)).permission}, \r

UserAgent: ${s.userAgent}
`.trim(),c.createElement("div")),b=(h.appendChild(y),y.classList.add("sw-user-debug-action-wrapper"),c.createElement("div"));y.appendChild(b),b.classList.add("sw-user-debug-copy-btn"),b.innerText="Copy",b.onclick=()=>{f.classList.add("copying"),f.select(),c.execCommand("copy"),f.classList.remove("copying"),b.classList.add("success"),setTimeout(()=>{b.classList.remove("success")},240)},c.body.appendChild(u)}catch(t){_.Logger.warn(t)}})}}},"./src/sdk/services/user.service.ts":function(t,e,s){"use strict";var c=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.UserService=void 0;const o=s("./src/sdk/services/helpers/user-profile.service-helpers.ts"),i=s("./src/sdk/models/events/subscriber-streamable-event.model.ts"),d=s("./src/sdk/data-providers/cookie.data-provider.ts"),n=s("./src/sdk/repositories/subscription.repository.ts"),u=s("./src/sdk/enums/event-type.enum.ts"),a=s("./src/_utils/global-env.ts"),r=s("./src/sdk/repositories/application.repository.ts"),l=s("./src/sdk/services/logging.service.ts"),h=s("./src/sdk/services/registration.service.ts");var v=s("./src/sdk/models/events/eventable.model.ts");const p=s("./src/sdk/models/events/event.model.ts"),m=s("./src/sdk/enums/trackable-setting.enum.ts"),f=s("./src/sdk/repositories/user.repository.ts"),y=s("./src/sdk/constants.ts"),b=s("./src/sdk/enums/steamable-event-type.enum.ts"),g=s("./src/sdk/utils.ts");class _ extends v.EventableModel{constructor(){super(...arguments),this.userProfileEventsWired=!1}loadUser(i,n){return c(this,void 0,void 0,function*(){let t=yield f.UserRepository.get();var e=!t.puuid;let s;return n.env.inWorkerGlobalScope()||(s=n.env.getQueryString()[y.PUSHLY_UNIQUE_USER_ID_QS]),t.env=n.env,t.doNotTrackFlags=this._parseTrackableFlags(i.doNotTrack),e&&(t.puuid=s||(0,g.randomString)()),t.puuid&&/undefined/i.test(t.puuid.toString())&&(t.puuid=(0,g.randomString)()),n.domain.isEventOnlyMode()||!(yield f.UserRepository.getPromptDismissedState())&&t.isDismissed()&&(t.subscriberState="none"),0<t.doNotTrackFlags.length&&l.Logger.info("Tracking disabled for the following settings: "+t.doNotTrackFlags.join(", ")),yield f.UserRepository.set(t),t})}reloadUserWithCachePriority(e){return c(this,void 0,void 0,function*(){var t=yield f.UserRepository.getWithCachePriority();return e.puuid=t.puuid||e.puuid,e.subscriberState=t.subscriberState||e.subscriberState,e.token=t.token||e.token,e})}wireProfileEvents(e){if(!this.userProfileEventsWired){this.userProfileEventsWired=!0;const t=[u.EventType.PROFILE_UPDATE,u.EventType.PROFILE_UPDATE_EXTERNAL_ID,u.EventType.PROFILE_UPDATE_USER_EVENT,u.EventType.PROFILE_UPDATE_TAGS,u.EventType.PROFILE_APPEND,u.EventType.PROFILE_REMOVE,u.EventType.PAGE_TAG_VISIT,u.EventType.VIEW_ITEM,u.EventType.SAVE_ITEM,u.EventType.ADD_TO_CART,u.EventType.UPDATE_CART_ITEM,u.EventType.PURCHASE,u.EventType.REQUEST_USER_DELETION];t.forEach(t=>{this._wireProfileEvent(e,t)})}}verifyUserSubscriptionState(o){return c(this,void 0,void 0,function*(){const e=o.env,t=o.domain,s=o.user;if(t.isEventOnlyMode())l.Logger.info("Skipping user subscription state verification while in event only mode");else{l.Logger.info("Verifying user subscription state");let t;(e.isHTTPS()||e.isDevMode())&&(t=yield o.user.getComputedPushPermission(o));var i=d.CookieDataProvider.get("_pnss"),n="subscribed"===(s.subscriberState=i),r="blocked"===i,i="dismissed"===i;s.domainOfRecord=t?t.host:(0,a.getSelf)().location.hostname,r?t&&"denied"!==t.permission?"granted"===t.permission&&t.host===(0,a.getSelf)().location.hostname?yield h.RegistrationService.performManualRegistrationAttempt(o,s.lastSeenPromptId):"default"===t.permission&&this.setSubscriptionState(s,"none"):("blocked"!==s.subscriberState&&(s.subscriberState="blocked"),this.dispatch(new p.EventModel(u.EventType.EXIT_PERMISSIONS_DENIED)),this.debugPromptNotShown(o,"user_permission_denied")):i?t&&"default"!==t.permission?"granted"===t.permission&&t.host===(0,a.getSelf)().location.hostname?yield h.RegistrationService.performManualRegistrationAttempt(o,s.lastSeenPromptId):"denied"===t.permission&&(yield this.setSubscriptionState(s,"blocked"),this.dispatch(new p.EventModel(u.EventType.EXIT_PERMISSIONS_DENIED)),this.debugPromptNotShown(o,"user_permission_denied")):("dismissed"!==s.subscriberState&&(s.subscriberState="dismissed"),this.dispatch(new p.EventModel(u.EventType.EXIT_PERMISSIONS_DISMISSED)),this.debugPromptNotShown(o,"user_permission_dismissed")):n?t&&"granted"!==t.permission?"default"===t.permission?(yield this.setSubscriptionState(s,"none"),yield h.RegistrationService.unsubscribe(o,"none")):"denied"===t.permission&&(s.token=null,yield h.RegistrationService.unsubscribe(o),this.dispatch(new p.EventModel(u.EventType.EXIT_PERMISSIONS_DENIED)),this.debugPromptNotShown(o,"user_permission_denied")):"subscribed"!==s.subscriberState&&(s.subscriberState="subscribed"):t&&"default"!==t.permission?"granted"===t.permission?(s.subscriberState="subscribed",t.host===(0,a.getSelf)().location.hostname&&(yield h.RegistrationService.performManualRegistrationAttempt(o,s.lastSeenPromptId))):"denied"===t.permission&&(yield this.setSubscriptionState(s,"blocked"),this.dispatch(new p.EventModel(u.EventType.EXIT_PERMISSIONS_DENIED)),this.debugPromptNotShown(o,"user_permission_denied")):"none"!==s.subscriberState&&(s.subscriberState="none")}"none"===s.subscriberState?l.Logger.info("Subscription state is currently set to none."):"subscribed"===s.subscriberState?l.Logger.info("Subscription state is currently set to subscribed."):"dismissed"===s.subscriberState?l.Logger.info("Subscription state is currently set to dismissed."):"blocked"===s.subscriberState&&l.Logger.info("Subscription state is currently set to blocked."),yield f.UserRepository.set(s)})}setExternalId(t,e){return c(this,void 0,void 0,function*(){t.externalId=e,yield f.UserRepository.set(t)})}saveExternalId(t,e){return c(this,void 0,void 0,function*(){yield this.setExternalId(t.user,e),yield o.UserProfileServiceHelpers.saveExternalUserId(t,e)})}setToken(t,e){return c(this,void 0,void 0,function*(){t.token=e,yield f.UserRepository.set(t)})}setSubscriptionState(t,e,s,i){return c(this,void 0,void 0,function*(){l.Logger.info("Updating subscriber state to "+e),t.subscriberState=e,s?t.token=s:s=null,yield f.UserRepository.set(t),"dismissed"===t.subscriberState&&i&&(yield f.UserRepository.setPromptDismissedState(t,i))})}setLastSeenPromptId(t,e){return c(this,void 0,void 0,function*(){t.lastSeenPromptId=e,yield f.UserRepository.set(t)})}setPromptState(t,e,s,i){return c(this,void 0,void 0,function*(){t.promptFcapSeconds=e,t.promptCountState=s,yield f.UserRepository.setPromptState(t,i)})}clearPromptFcapState(){return c(this,void 0,void 0,function*(){yield f.UserRepository.clearPromptState()})}setPromptDismissed(t,e){return c(this,void 0,void 0,function*(){yield f.UserRepository.setPromptDismissedState(t,e)})}setLastReferrerState(t,e){return c(this,void 0,void 0,function*(){t.lastReferrerState={referrer:e,lastSetAt:(new Date).getTime()},yield f.UserRepository.set(t)})}clearLastReferrerState(t){return c(this,void 0,void 0,function*(){delete t.lastReferrerState,yield f.UserRepository.set(t)})}handleUdrRequest(s){return c(this,void 0,void 0,function*(){var t=s.env,e=!!t&&!!d.CookieDataProvider.get("_pnudr");d.CookieDataProvider.set("_pnudr","1"),e?l.Logger.warn("User deletion has already been requested."):(yield this.post(new i.SubscriberStreamableEventModel(b.StreamableEventType.UDR,{},s)),yield n.SubscriptionRepository.unregister(s),r.ApplicationRepository.purgeCookies(),f.UserRepository.purgeCookies(),this.dispatch(new p.EventModel(u.EventType.USER_DELETION_REQUEST,void 0,s.app.loadConfig,t)))})}handleUdrRevert(){d.CookieDataProvider.clear("_pnudr")}_parseTrackableFlags(t){let e=[],s=Object.keys(m.TrackableSetting).map(t=>m.TrackableSetting[t]);return t&&("string"==typeof t&&(t=String(t).split(",").map(t=>t.toLowerCase().trim())),Array.isArray(t)&&0<t.length&&(e=t.map(t=>t.toLowerCase()).filter(t=>-1!==s.indexOf(t)))),e}processUdr(){return c(this,void 0,void 0,function*(){return f.UserRepository.purgeCookies()})}_wireProfileEvent(n,r){this.watch(r,s=>{const i=()=>c(this,void 0,void 0,function*(){if(n.app&&n.app.isLoaded)if(((yield n.user.getComputedPushPermission(n)).subscription||n.domain.isEventOnlyMode())&&(yield n.user.isSubscribed(n)))try{switch(r){case u.EventType.PROFILE_UPDATE:yield o.UserProfileServiceHelpers.saveUserProfileData(n,s);break;case u.EventType.PROFILE_UPDATE_EXTERNAL_ID:yield this.setExternalId(n.user,s),yield o.UserProfileServiceHelpers.saveExternalUserId(n,s);break;case u.EventType.PROFILE_UPDATE_USER_EVENT:yield o.UserProfileServiceHelpers.saveUserEvent(n,s);break;case u.EventType.PROFILE_UPDATE_TAGS:yield o.UserProfileServiceHelpers.saveUserTags(n,s);break;case u.EventType.PROFILE_APPEND:yield o.UserProfileServiceHelpers.appendProfileArrayValue(n,s);break;case u.EventType.PROFILE_REMOVE:yield o.UserProfileServiceHelpers.removeProfileArrayValue(n,s);break;case u.EventType.PAGE_TAG_VISIT:s=Array.isArray(s)?s:[s],yield o.UserProfileServiceHelpers.pageTagVisit(n,s);break;case u.EventType.VIEW_ITEM:yield o.UserProfileServiceHelpers.viewItem(n,s);break;case u.EventType.SAVE_ITEM:yield o.UserProfileServiceHelpers.saveItem(n,s);break;case u.EventType.ADD_TO_CART:yield o.UserProfileServiceHelpers.addToCart(n,s);break;case u.EventType.UPDATE_CART_ITEM:yield o.UserProfileServiceHelpers.updateCartItem(n,s);break;case u.EventType.PURCHASE:yield o.UserProfileServiceHelpers.purchase(n,s);break;case u.EventType.REQUEST_USER_DELETION:yield this.handleUdrRequest(n)}}catch(t){l.Logger.error(n,t)}else{let t=!0,e;if(r===u.EventType.PROFILE_UPDATE_EXTERNAL_ID?(e=s,t=!1):s instanceof Object&&"external_id"in s&&(e=s.external_id),e&&(yield this.setExternalId(n.user,e)),t){let t,e;t=this.watchOnce(u.EventType.REGISTRATION_SUBSCRIBED,()=>{e&&e(),i()}),e=this.watchOnce(u.EventType.REGISTRATION_MIGRATED,()=>{t&&t(),i()})}}else this.watchOnce(u.EventType.APPLICATION_LOADED,i)});i()})}}e.UserService=new _},"./src/sdk/services/worker.service.ts":function(t,e,s){"use strict";var n=this&&this.__awaiter||function(t,o,c,d){return new(c=c||Promise)(function(s,e){function i(t){try{r(d.next(t))}catch(t){e(t)}}function n(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(i,n)}r((d=d.apply(t,o||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.WorkerService=void 0;const r=s("./src/sdk/constants.ts"),o=s("./src/sdk/services/logging.service.ts"),i=s("./src/_utils/service-worker-registration.ts"),c=s("./src/sdk/models/events/event.model.ts"),d=s("./src/sdk/enums/event-type.enum.ts"),u=s("./src/sdk/repositories/application.repository.ts");var a=s("./src/sdk/models/events/eventable.model.ts");const l=s("./src/sdk/exceptions/worker-registration.exception.ts");class h extends a.EventableModel{_installPushlyServiceWorker(s){return n(this,void 0,void 0,function*(){const t=s.env.navigator;var e=(0,i.getPushlyWorkerConfig)(s);return t.serviceWorker.register(e.installationPath,{updateViaCache:"none",scope:e.scope})})}registerWorker(e){return n(this,void 0,void 0,function*(){let t=null;try{(t=yield(0,i.getPushlyServiceWorkerRegistration)(e))||(o.Logger.info("Registering new ServiceWorker"),t=yield this._installPushlyServiceWorker(e),this.dispatch(new c.EventModel(d.EventType.SW_INSTALLED,{registration:t}))),yield u.ApplicationRepository.set(e.app),this.dispatch(new c.EventModel(d.EventType.SW_SETUP_COMPLETE,{registration:t}))}catch(t){throw o.Logger.warn({type:t.type,code:t.code,message:t.message,error:t}),new l.WorkerRegistrationException(t)}return t})}loadServiceWorkerDependencyScript(i){return n(this,void 0,void 0,function*(){const t=i.env.document;if(t&&t.body){const e=t.createElement("script"),s=(e.onload=()=>{o.Logger.info("ServiceWorker dependency script loaded")},e.async=!0,e.src=r.SW_DEPENDENCY_URL,t.getElementsByTagName("script")[0]);s.parentNode.insertBefore(e,s)}})}}e.WorkerService=new h},"./src/sdk/utils.ts":(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.tryParseJSON=e.parseQueryString=e.hashFromString=e.isProductionBuild=e.simpleUnHash=e.simpleHash=e.atobShim=e.delayRandom=e.delay=e.tryParseInt=e.randomString=e.retryFetch=void 0;var i=s("./src/common/utils.ts");Object.defineProperty(e,"retryFetch",{enumerable:!0,get:function(){return i.retryFetch}}),Object.defineProperty(e,"randomString",{enumerable:!0,get:function(){return i.randomString}}),Object.defineProperty(e,"tryParseInt",{enumerable:!0,get:function(){return i.tryParseInt}}),Object.defineProperty(e,"delay",{enumerable:!0,get:function(){return i.delay}}),Object.defineProperty(e,"delayRandom",{enumerable:!0,get:function(){return i.delayRandom}});const n=s("./src/sdk/constants.ts");e.atobShim=t=>{let e="";try{if("string"==typeof(e=window.atob(t)))return e}catch(t){}e="";var s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(t=String(t).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(t))throw new TypeError("Failed to execute 'atob' on 'Window': The string to be decoded is not correctly encoded.");t+="==".slice(2-(3&t.length));let i,n,r,o=0;for(;o<t.length;)i=s.indexOf(t.charAt(o++))<<18|s.indexOf(t.charAt(o++))<<12|(n=s.indexOf(t.charAt(o++)))<<6|(r=s.indexOf(t.charAt(o++))),e+=64===n?String.fromCharCode(i>>16&255):64===r?String.fromCharCode(i>>16&255,i>>8&255):String.fromCharCode(i>>16&255,i>>8&255,255&i);return e},e.simpleHash=t=>window.btoa(JSON.stringify(t)),e.simpleUnHash=t=>(0,e.tryParseJSON)((0,e.atobShim)(t)),e.isProductionBuild=()=>"production"===n.ENV_NAME||"prod"===n.ENV_NAME,e.hashFromString=t=>{let e=5381,s=t.length;for(;s;)e=33*e^t.charCodeAt(--s);return e>>>0},e.parseQueryString=t=>{t=t.split("?").pop().split("&");let e={};try{for(var s of t){const i=s.split("=");i[0]&&(i[1]=i[1]?i[1].replace(/\+/gi," "):"",e[i[0]]=decodeURIComponent(i[1]))}}catch(t){}return e};e.tryParseJSON=t=>{let e;try{e=JSON.parse(t)}catch(t){}return e}}},i={};function c(t){var e=i[t];if(void 0!==e)return e.exports;e=i[t]={exports:{}};return s[t].call(e.exports,e,e.exports,c),e.exports}var d={};(()=>{"use strict";Object.defineProperty(d,"__esModule",{value:!0});var e=c("./src/sdk/exceptions/pushly.exception.ts");const t=c("./src/sdk/models/context.model.ts"),s=c("./src/sdk/sdk.ts"),i=c("./src/sdk/services/logging.service.ts");try{const o=new s.SDK(new t.ContextModel);var n=window.PushlySDK;if(n&&n instanceof Array)for(var r of n)o.push(r);window.PushlySDK=o}catch(t){if(!(t instanceof e.PushlyException))throw t;console.log(t),i.Logger.warn("[pushly-sdk]",t.message)}})()})();

(function(){
if (document.location.pathname != '/') {
    PushlySDK.watch('ready', () => {
        const qs = document.querySelector('meta[name="keywords"]');
        if (qs && qs.content) {
            PushlySDK.push(['page_tag_visit', qs.content.split(',').map(v => v.trim())]);
        }
    });
}

})();